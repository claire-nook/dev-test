<!doctype html>
<html lang="zh-Hant">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Cruise Tracker</title>

	<style>
		:root {
			--card-bg: #fff;
			--soft: #f5f5f7;
			--ink: #222;
			--muted: #666;
			--accent: #888;
			--radius: 12px;
			--border: #e3e3e6;
		}

		* {
			box-sizing: border-box;
		}

		body {
			margin: 0;
			font-family: system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans TC", sans-serif;
			background: #fafafa;
			color: var(--ink);
		}

		header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 1rem 1.5rem;
			background: #fff;
			box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
			position: sticky;
			top: 0;
			z-index: 10;
		}

		header h2 {
			margin: 0;
			font-size: 1.25rem;
		}

		header a {
			text-decoration: none;
			font-size: 0.95rem;
			padding: 0.45rem 0.85rem;
			border-radius: 6px;
			background: #eee;
			color: #333;
			box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
			white-space: nowrap;
		}

		.wrap {
			max-width: 1080px;
			margin: 0 auto;
			padding: 20px 16px 40px;
		}

		h3 {
			margin: 0 0 8px;
			font-size: 1.05rem;
		}

		p {
			margin: 0 0 10px;
			font-size: 0.95rem;
			color: var(--muted);
		}

		.toolbar {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
			align-items: center;
			background: var(--card-bg);
			padding: 14px;
			border-radius: var(--radius);
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
			margin-bottom: 16px;
		}

		.toolbar-group {
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
			align-items: center;
		}

		.badge {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			padding: 3px 8px;
			border-radius: 999px;
			background: #f4f4ff;
			font-size: 0.82rem;
			color: #555;
			white-space: nowrap;
		}

		.badge-dot {
			width: 8px;
			height: 8px;
			border-radius: 50%;
			border: 2px solid #4f8cff;
		}

		input[type="date"],
		input[type="text"],
		input[type="number"],
		input[type="url"],
		select,
		textarea {
			font-size: 0.95rem;
			padding: 6px 8px;
			border: 1px solid var(--border);
			border-radius: 8px;
			background: #fff;
		}

		textarea {
			width: 100%;
			min-height: 92px;
			resize: vertical;
			line-height: 1.4;
		}

		.btn {
			border: none;
			background: #2f855a;
			color: #fff;
			padding: 8px 12px;
			border-radius: 10px;
			cursor: pointer;
			font-size: 0.95rem;
			display: inline-flex;
			align-items: center;
			gap: 6px;
			white-space: nowrap;
		}

		.btn.secondary {
			background: #4f8cff;
		}

		.btn.ghost {
			background: #e0e7ff;
			color: #333;
		}

		.btn.danger {
			background: #c62828;
		}

		.btn[disabled] {
			background: #bdbdbd;
			cursor: not-allowed;
		}

		.panel {
			background: var(--card-bg);
			border-radius: var(--radius);
			padding: 12px 12px 16px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
			margin-bottom: 18px;
		}

		.field-row {
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
			align-items: center;
			margin-bottom: 8px;
		}

		.field-row .grow {
			flex: 1 1 240px;
			min-width: 0;
		}

		.field-row .mini {
			width: 120px;
		}

		.field-row .mid {
			width: 180px;
		}

		/* iPad / æ¡Œé¢ï¼šä¸è¦éš¨ä¾¿æ›è¡Œï¼Œç‰ˆé¢å›ºå®š */
		@media (min-width: 820px) {
			.field-row {
				flex-wrap: nowrap;
				align-items: center;
			}
		}

		label {
			font-size: 0.9rem;
			color: var(--muted);
			min-width: 88px;
			text-align: left;
		}

		/* é¿å… label è·Ÿè¼¸å…¥å…ƒä»¶åœ¨åŒä¸€åˆ—æ™‚ç¸±å‘ä¸é½Š */
		.field-row {
			align-items: flex-start;
		}

		.field-row>label {
			margin-top: 6px;
		}

		.list {
			border-top: 1px dashed #e0e0e0;
			padding-top: 8px;
			margin-top: 6px;
			max-height: 360px;
			overflow: auto;
		}

		.chip {
			border-radius: 999px;
			border: 1px solid #e0e0e0;
			padding: 6px 10px;
			margin-bottom: 6px;
			display: flex;
			align-items: center;
			justify-content: flex-start;
			gap: 8px;
			background: #fafafa;
			font-size: 0.85rem;
		}

		.chip-main {
			display: flex;
			flex-direction: column;
			min-width: 0;
		}

		.chip-title {
			font-weight: 600;
			display: -webkit-box;
			-webkit-line-clamp: 2;
			/* æœ€å¤šå…©è¡Œ */
			-webkit-box-orient: vertical;
			overflow: hidden;
		}

		.chip-meta {
			font-size: 0.78rem;
			color: var(--muted);
			white-space: nowrap;
			text-overflow: ellipsis;
			overflow: hidden;
		}

		.chip-actions {
			display: flex;
			gap: 4px;
			flex-shrink: 0;
			margin-left: auto;
		}

		.chip.snapshot .chip-actions {
			margin-left: 8px;
		}

		.chip button {
			border: none;
			border-radius: 999px;
			padding: 7px 14px;
			font-size: 0.95rem;
			cursor: pointer;
		}

		.chip button.select {
			background: #e8f5e9;
			color: #1b5e20;
		}

		.chip button.edit {
			background: #e3f2fd;
			color: #1565c0;
		}

		.chip button.delete {
			background: #ffebee;
			color: #c62828;
		}

		.chip button.preview {
			background: #f4f4ff;
			color: #3949ab;
		}

		.chip.selected {
			border-color: #2f855a;
			box-shadow: 0 0 0 1px rgba(47, 133, 90, 0.35);
			background: #f1fbf5;
		}

		.chip.editing {
			border-color: #4f8cff;
			box-shadow: 0 0 0 1px rgba(79, 140, 255, 0.45);
			background: #f0f4ff;
		}

		/* iPad/çª„è¢å¹•ï¼šchip å…è¨±æ›è¡Œï¼ŒæŒ‰éˆ•ä¸è¦è¢«æ“ å‡ºç•«é¢ */
		@media (max-width: 900px) {
			.chip {
				flex-wrap: wrap;
				align-items: flex-start;
			}

			.chip-main {
				flex: 1 1 100%;
			}

			.chip-actions {
				margin-left: 0;
				width: 100%;
				justify-content: flex-end;
			}
		}

		.mono {
			font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
			font-size: 0.9rem;
		}

		.hint {
			font-size: 0.85rem;
			color: var(--muted);
			line-height: 1.4;
		}

		.view {
			display: none;
		}

		.view.active {
			display: block;
		}
	</style>
</head>

<body>
	<header>
		<h2>ğŸ›³ï¸ Cruise Tracker</h2>
		<a href="/">å›é¦–é </a>
	</header>

	<div class="wrap">
		<div class="toolbar">
			<div class="toolbar-group">
				<button class="btn secondary" id="btnImport">åŒ¯å…¥ JSON</button>
				<button class="btn secondary" id="btnExport">åŒ¯å‡º JSON</button>
				<button class="btn ghost" id="btnCopy">è¤‡è£½ JSON</button>
				<input type="file" id="fileInput" accept="application/json" style="display:none" />
			</div>

			<div class="toolbar-group">
				<button class="btn" id="btnGoSailings" type="button">â‘  èˆªç¨‹ä¸»æª”</button>
				<button class="btn ghost" id="btnGoSnapshots" type="button" disabled>â‘¡ åƒ¹æ ¼å¿«ç…§</button>
			</div>

			<span class="badge" title="å¹£åˆ¥å›ºå®š">
				<span class="badge-dot"></span>
				å¹£åˆ¥ï¼šUSD
			</span>

			<span class="badge" id="badgeSelected" title="å…ˆé¸èˆªç¨‹ï¼Œå†ç·¨è¼¯åƒ¹æ ¼å¿«ç…§ã€‚">
				<span class="badge-dot" style="border-color:#2f855a"></span>
				ç›®å‰æœªé¸èˆªç¨‹
			</span>
		</div>

		<!-- View: Sailings -->
		<section class="panel view active" id="viewSailings">
			<h3>â‘  èˆªç¨‹ä¸»æª”</h3>
			<p>ä¸Šé¢è¼¸å…¥ï¼Œä¸‹é¢åˆ—è¡¨ã€‚</p>

			<div class="field-row">
				<label>éƒµè¼ªåç¨±</label>
				<select id="ship" class="grow">
					<option value="X_EDGE">X_EDGE</option>
					<option value="X_SOLSTICE">X_SOLSTICE</option>
					<option value="X_SILHOUETTE">X_SILHOUETTE</option>
				</select>

				<label>æ™šæ•¸</label>
				<input id="days" class="mini" type="number" min="1" step="1" placeholder="16" />
			</div>
			<div class="field-row">
				<label>éƒµè¼ªèˆªç¨‹</label>
				<input id="routeName" class="grow" type="text" list="dlRouteNames" placeholder="å¤§æºªåœ° / é˜¿æ‹‰æ–¯åŠ  / ç§»èˆª..." />
				<datalist id="dlRouteNames"></datalist>
			</div>

			<div class="field-row">
				<label>å‡ºç™¼æ—¥æœŸ</label>
				<input id="sdate" class="grow" type="date" />

				<label>æŠµé”æ—¥æœŸ</label>
				<input id="edate" class="grow" type="date" />

			</div>

			<div class="field-row">
				<label>å‡ºç™¼åŸå¸‚</label>
				<input id="scity" class="grow" type="text" list="dlCities" placeholder="ï¼ˆä¸­æ–‡ï¼‰" />

				<label>æŠµé”åŸå¸‚</label>
				<input id="ecity" class="grow" type="text" list="dlCities" placeholder="ï¼ˆä¸­æ–‡ï¼‰" />

				<datalist id="dlCities"></datalist>
			</div>

			<div class="field-row">
				<label class="mid">å®˜ç¶² URL</label>
			</div>
			<div class="field-row">
				<input id="url" class="grow" type="url" placeholder="https://..." />
				<button class="btn ghost" id="btnOpenUrl" type="button">é–‹å•Ÿå®˜ç¶²</button>
			</div>

			<div class="field-row">
				<label class="grow">èˆªç¨‹è³‡è¨Š</label>
			</div>
			<div class="field-row">
				<textarea id="visiting" placeholder="ä¾‹å¦‚ï¼šæ©«æ¿± > ä»™å° > æµ·ä¸Š > æº«å“¥è¯..."></textarea>
			</div>

			<div class="field-row">
				<label class="grow">å‚™è¨»</label>
			</div>
			<div class="field-row">
				<textarea id="sailingRemark" placeholder="å…¶ä»–è£œå……"></textarea>
			</div>

			<div class="field-row">
				<button class="btn" id="btnSaveSailing" type="button">æ–°å¢èˆªç¨‹</button>
				<button class="btn ghost" id="btnResetSailing" type="button">æ¸…ç©º</button>
				<span class="hint mono" id="idPreview">IDï¼šâ€”</span>
			</div>

			<div class="list" id="sailingList"></div>
			<div class="list" style="margin-top:14px" id="previewWrap">
				<div class="hint" style="margin-bottom:8px">
					<strong>å¿«ç…§å¿«é€Ÿæª¢è¦–</strong>ï¼ˆå€’åºï¼‰ï¼š
					<span class="mono" id="previewTitle">å°šæœªé¸æ“‡èˆªç¨‹</span>
				</div>
				<div id="previewList"></div>
			</div>

		</section>

		<!-- View: Snapshots -->
		<section class="panel view" id="viewSnapshots">
			<h3>â‘¡ åƒ¹æ ¼å¿«ç…§</h3>
			<p>å…ˆé¸èˆªç¨‹ï¼Œå†æ–°å¢åƒ¹æ ¼å¿«ç…§ã€‚</p>

			<div class="field-row">
				<label>ç›®å‰èˆªç¨‹</label>
				<input id="selectedSailingId" class="grow mono" type="text" readonly placeholder="è«‹å…ˆåˆ° â‘  é¸å–èˆªç¨‹" />

			</div>

			<div class="field-row">
				<label>å·¡åƒ¹æ—¥æœŸ</label>
				<input id="pDate" class="grow" type="date" />
			</div>

			<div class="field-row">
				<label>Veranda</label>
				<input id="pVeranda" class="grow" type="number" min="0" step="1" placeholder="2949" />

				<label>Aqua</label>
				<input id="pAqua" class="grow" type="number" min="0" step="1" placeholder="ï¼ˆå¯ç©ºï¼‰" />

				<label>Suite</label>
				<input id="pSuite" class="grow" type="number" min="0" step="1" placeholder="ï¼ˆå¯ç©ºï¼‰" />
			</div>

			<div class="field-row">
				<label class="grow">å‚™è¨»</label>
			</div>
			<div class="field-row">
				<textarea id="pRemark" placeholder="ä¾‹å¦‚ï¼šé»‘äº” / flash saleï¼›OBC:200"></textarea>
			</div>

			<div class="field-row">
				<button class="btn" id="btnSaveSnapshot" type="button" disabled>æ–°å¢å¿«ç…§</button>
				<button class="btn ghost" id="btnResetSnapshot" type="button">æ¸…ç©º</button>
				<button class="btn ghost" id="btnBackToSailings" type="button">å›â‘ </button>
				<span class="hint mono" id="snapshotHint">æœªé¸èˆªç¨‹</span>
			</div>

			<div class="list" id="snapshotList"></div>

		</section>

	</div>

	<script>
		"use strict";

		let previewSailingId = null;
		let editingSnapshotId = null;

		const DATA = {
			meta: { schema_version: 1, updated_at: "" },
			dict: { cities: [], route_names: [] },
			sailings: [],
			price_snapshots: []
		};

		let selectedSailingId = null;
		let editingSailingId = null;
		let edateManuallyEdited = false;

		const el = {
			fileInput: document.getElementById("fileInput"),
			btnImport: document.getElementById("btnImport"),
			btnExport: document.getElementById("btnExport"),
			btnCopy: document.getElementById("btnCopy"),

			previewTitle: document.getElementById("previewTitle"),
			previewList: document.getElementById("previewList"),

			btnGoSailings: document.getElementById("btnGoSailings"),
			btnGoSnapshots: document.getElementById("btnGoSnapshots"),

			badgeSelected: document.getElementById("badgeSelected"),
			viewSailings: document.getElementById("viewSailings"),
			viewSnapshots: document.getElementById("viewSnapshots"),

			ship: document.getElementById("ship"),
			days: document.getElementById("days"),
			routeName: document.getElementById("routeName"),
			sdate: document.getElementById("sdate"),
			edate: document.getElementById("edate"),
			scity: document.getElementById("scity"),
			ecity: document.getElementById("ecity"),
			visiting: document.getElementById("visiting"),
			url: document.getElementById("url"),
			btnOpenUrl: document.getElementById("btnOpenUrl"),
			sailingRemark: document.getElementById("sailingRemark"),
			btnSaveSailing: document.getElementById("btnSaveSailing"),
			btnResetSailing: document.getElementById("btnResetSailing"),
			sailingList: document.getElementById("sailingList"),
			idPreview: document.getElementById("idPreview"),

			dlCities: document.getElementById("dlCities"),
			dlRouteNames: document.getElementById("dlRouteNames"),

			selectedSailingIdInput: document.getElementById("selectedSailingId"),
			btnBackToSailings: document.getElementById("btnBackToSailings"),

			pDate: document.getElementById("pDate"),
			pVeranda: document.getElementById("pVeranda"),
			pAqua: document.getElementById("pAqua"),
			pSuite: document.getElementById("pSuite"),
			pRemark: document.getElementById("pRemark"),
			btnSaveSnapshot: document.getElementById("btnSaveSnapshot"),
			btnResetSnapshot: document.getElementById("btnResetSnapshot"),
			snapshotList: document.getElementById("snapshotList"),
			snapshotHint: document.getElementById("snapshotHint")

		};

		function nowISO() {
			const d = new Date();
			const pad = (n) => String(n).padStart(2, "0");
			const yyyy = d.getFullYear();
			const mm = pad(d.getMonth() + 1);
			const dd = pad(d.getDate());
			const hh = pad(d.getHours());
			const mi = pad(d.getMinutes());
			const ss = pad(d.getSeconds());
			const tz = -d.getTimezoneOffset();
			const sign = tz >= 0 ? "+" : "-";
			const tzh = pad(Math.floor(Math.abs(tz) / 60));
			const tzm = pad(Math.abs(tz) % 60);
			return `${yyyy}-${mm}-${dd}T${hh}:${mi}:${ss}${sign}${tzh}:${tzm}`;
		}

		function clampText(s) {
			return (s ?? "").toString().trim();
		}

		function toNumOrNull(v) {
			const t = clampText(v);
			if (!t) return null;
			const n = Number(t);
			return Number.isFinite(n) ? n : null;
		}

		function formatMoney(n) {
			if (n === null || n === undefined) return "-";
			if (!Number.isFinite(n)) return "-";
			return String(Math.round(n));
		}

		function shipToIdPart(shipValue) {
			const s = clampText(shipValue);
			const parts = s.split("_");
			return parts.length >= 2 ? parts.slice(1).join("_") : s;
		}

		function genSailingId(shipValue, sdateValue) {
			const shipPart = shipToIdPart(shipValue);
			const sdate = clampText(sdateValue);
			if (!shipPart || !sdate) return "";
			const yyyymmdd = sdate.replaceAll("-", "");
			return `X_${shipPart}_${yyyymmdd}`;
		}

		function dateAddDaysInclusive(yyyyMmDd, days) {
			const s = clampText(yyyyMmDd);
			const d = Number(days);
			if (!s || !Number.isFinite(d) || d <= 0) return "";
			const dt = new Date(s + "T00:00:00");
			if (Number.isNaN(dt.getTime())) return "";

			// ç›´è¦ºç‰ˆï¼šç¬¬ 1 å¤© = å‡ºç™¼æ—¥ï¼Œæ‰€ä»¥ + (days - 1)
			dt.setDate(dt.getDate() + d);

			const pad = (n) => String(n).padStart(2, "0");
			const yyyy = dt.getFullYear();
			const mm = pad(dt.getMonth() + 1);
			const dd = pad(dt.getDate());
			return `${yyyy}-${mm}-${dd}`;
		}

		function showView(name) {
			const isSailings = name === "sailings";
			el.viewSailings.classList.toggle("active", isSailings);
			el.viewSnapshots.classList.toggle("active", !isSailings);

			// toolbar button styles
			el.btnGoSailings.classList.toggle("ghost", !isSailings);
			el.btnGoSnapshots.classList.toggle("ghost", isSailings);
		}

		function syncIdPreview() {
			const id = genSailingId(el.ship.value, el.sdate.value);
			el.idPreview.textContent = id ? `IDï¼š${id}` : "IDï¼šâ€”";
		}

		function upsertDictValue(arr, value) {
			const v = clampText(value);
			if (!v) return;
			if (!arr.includes(v)) arr.push(v);
		}

		function renderDatalists() {
			// Cities
			el.dlCities.innerHTML = "";
			DATA.dict.cities.forEach(c => {
				const opt = document.createElement("option");
				opt.value = c;
				el.dlCities.appendChild(opt);
			});

			// Route Names
			el.dlRouteNames.innerHTML = "";
			DATA.dict.route_names.forEach(r => {
				const opt = document.createElement("option");
				opt.value = r;
				el.dlRouteNames.appendChild(opt);
			});
		}

		function updateMetaAndJsonView() {
			DATA.meta.updated_at = nowISO();
		}

		function setSelectedSailing(id) {
			selectedSailingId = id;

			if (!id) {
				el.badgeSelected.innerHTML = `<span class="badge-dot" style="border-color:#2f855a"></span>ç›®å‰æœªé¸èˆªç¨‹`;
				el.btnGoSnapshots.disabled = true;
				el.btnSaveSnapshot.disabled = true;
				el.snapshotHint.textContent = "æœªé¸èˆªç¨‹";
				el.selectedSailingIdInput.value = "";
			} else {
				el.badgeSelected.innerHTML = `<span class="badge-dot" style="border-color:#2f855a"></span>ç›®å‰èˆªç¨‹ï¼š${id}`;
				el.btnGoSnapshots.disabled = false;
				el.btnSaveSnapshot.disabled = false;
				el.snapshotHint.textContent = `sailing_id = ${id}`;
				el.selectedSailingIdInput.value = id;
			}

			renderSailingList();
			renderSnapshotList();
			updateMetaAndJsonView();
		}

		function resetSailingForm() {
			editingSailingId = null;
			edateManuallyEdited = false;

			el.ship.value = "X_EDGE";
			el.days.value = "";
			el.routeName.value = "";
			el.sdate.value = "";
			el.edate.value = "";
			el.scity.value = "";
			el.ecity.value = "";
			el.visiting.value = "";
			el.url.value = "";
			el.sailingRemark.value = "";

			el.btnSaveSailing.textContent = "æ–°å¢èˆªç¨‹";
			syncIdPreview();
		}

		function resetSnapshotForm() {
			el.pDate.value = "";
			el.pVeranda.value = "";
			el.pAqua.value = "";
			el.pSuite.value = "";
			el.pRemark.value = "";
			editingSnapshotId = null;
			el.btnSaveSnapshot.textContent = "æ–°å¢å¿«ç…§";
		}

		function renderSailingList() {
			el.sailingList.innerHTML = "";

			const sorted = [...DATA.sailings].sort((a, b) => {
				const routeA = a.route_name || "";
				const routeB = b.route_name || "";

				// â‘  å…ˆæ¯”èˆªç¨‹åç¨±ï¼ˆå­—ä¸²æ­£åºï¼‰
				const r = routeA.localeCompare(routeB, "zh-Hant");
				if (r !== 0) return r;

				// â‘¡ åŒèˆªç¨‹ï¼Œå†æ¯”å‡ºç™¼æ—¥ï¼ˆæ™‚é–“æ­£åºï¼‰
				return (a.sdate || "").localeCompare(b.sdate || "");
			});

			sorted.forEach(s => {
				const chip = document.createElement("div");
				chip.className = "chip";
				if (s.id === selectedSailingId) chip.classList.add("selected");
				if (s.id === editingSailingId) chip.classList.add("editing");

				const title = `${s.route_name || "ï¼ˆæœªåˆ†é¡ï¼‰"}  Â·  ${s.id}`;
				const meta = `${s.sdate || "?"}~${s.edate || "?"} Â· ${s.days || "?"}æ™š Â· ${s.scity || "?"}ï½${s.ecity || "?"}`;

				chip.innerHTML = `
          <div class="chip-main">
            <div class="chip-title">${escapeHtml(title)}</div>
            <div class="chip-meta mono">${escapeHtml(meta)}</div>
          </div>
			<div class="chip-actions">
			  <button class="preview" type="button">æª¢è¦–åƒ¹æ ¼</button>
			  <button class="select" type="button">ç·¨è¼¯åƒ¹æ ¼</button>
			  <button class="edit" type="button">ç·¨è¼¯èˆªç¨‹</button>
			  <button class="delete" type="button">åˆªé™¤èˆªç¨‹</button>
			</div>
		  `;

				const [btnView, btnSelect, btnEdit, btnDelete] = chip.querySelectorAll("button");

				btnSelect.onclick = () => {
					setSelectedSailing(s.id);
					// é¸äº†èˆªç¨‹é€šå¸¸å°±æ˜¯è¦è¨˜å¿«ç…§ï¼Œé †ä¾¿å¹«ä½ åˆ‡éå»
					showView("snapshots");
				};

				btnView.onclick = () => {
					setPreviewSailing(s.id);
				};

				btnEdit.onclick = () => {
					editingSailingId = s.id;

					el.ship.value = s.ship || "X_EDGE";
					el.days.value = s.days ?? "";
					el.routeName.value = s.route_name ?? "";
					el.sdate.value = s.sdate ?? "";
					el.edate.value = s.edate ?? "";
					el.scity.value = s.scity ?? "";
					el.ecity.value = s.ecity ?? "";
					el.visiting.value = s.visiting ?? "";
					el.url.value = s.url ?? "";
					el.sailingRemark.value = s.remark ?? "";

					el.btnSaveSailing.textContent = "å„²å­˜è®Šæ›´";
					syncIdPreview();
					renderSailingList();
					updateMetaAndJsonView();
				};

				btnDelete.onclick = () => deleteSailingCascade(s.id);

				el.sailingList.appendChild(chip);
			});
		}

		function setPreviewSailing(id) {
			previewSailingId = id;
			renderSnapshotPreview();
		}

		function renderSnapshotPreview() {
			if (!el.previewTitle || !el.previewList) return;

			el.previewList.innerHTML = "";

			if (!previewSailingId) {
				el.previewTitle.textContent = "å°šæœªé¸æ“‡èˆªç¨‹";
				return;
			}

			el.previewTitle.textContent = previewSailingId;

			const list = DATA.price_snapshots
				.filter(p => p.sailing_id === previewSailingId)
				.sort((a, b) => (b.date || "").localeCompare(a.date || ""));

			if (list.length === 0) {
				el.previewList.innerHTML = `<div class="hint">ï¼ˆé€™æ¢èˆªç¨‹é‚„æ²’æœ‰å¿«ç…§ï¼‰</div>`;
				return;
			}

			list.forEach(p => {
				const div = document.createElement("div");
				div.className = "chip snapshot";
				const title = `${p.date || "ï¼ˆæœªå¡«æ—¥æœŸï¼‰"}`;
				const meta = `Veranda ${formatMoney(p.veranda)} | Aqua ${formatMoney(p.aqua)} | Suite ${formatMoney(p.suite)}`;
				div.innerHTML = `
      <div class="chip-main">
        <div class="chip-title">${escapeHtml(title)}</div>
        <div class="chip-meta">${escapeHtml(meta)}${p.remark ? " Â· " + escapeHtml(p.remark) : ""}</div>
      </div>
    `;
				el.previewList.appendChild(div);
			});
		}

		function renderSnapshotList() {
			el.snapshotList.innerHTML = "";

			if (!selectedSailingId) return;

			const list = DATA.price_snapshots
				.filter(p => p.sailing_id === selectedSailingId)
				.sort((a, b) => (b.date || "").localeCompare(a.date || ""));

			list.forEach(p => {
				const chip = document.createElement("div");
				chip.className = "chip snapshot";

				const title = `${p.date || "ï¼ˆæœªå¡«æ—¥æœŸï¼‰"}`;
				const meta = `Veranda ${formatMoney(p.veranda)} | Aqua ${formatMoney(p.aqua)} | Suite ${formatMoney(p.suite)}`;

				chip.innerHTML = `
          <div class="chip-main">
            <div class="chip-title">${escapeHtml(title)}</div>
            <div class="chip-meta">${escapeHtml(meta)}${p.remark ? " Â· " + escapeHtml(p.remark) : ""}</div>
          </div>
          <div class="chip-actions">
            <button class="edit" type="button">ç·¨è¼¯</button>
		  	<button class="delete" type="button">åˆªé™¤</button>
          </div>
        `;

				const [btnEdit, btnDelete] = chip.querySelectorAll("button");

				btnEdit.onclick = () => {
					editingSnapshotId = p._id;
					el.pDate.value = p.date || "";
					el.pVeranda.value = p.veranda ?? "";
					el.pAqua.value = p.aqua ?? "";
					el.pSuite.value = p.suite ?? "";
					el.pRemark.value = p.remark ?? "";
					el.btnSaveSnapshot.textContent = "å„²å­˜è®Šæ›´";
				};

				btnDelete.onclick = () => deleteSnapshot(p._id);

				el.snapshotList.appendChild(chip);
			});
		}

		function escapeHtml(str) {
			return (str ?? "").toString()
				.replaceAll("&", "&amp;")
				.replaceAll("<", "&lt;")
				.replaceAll(">", "&gt;")
				.replaceAll('"', "&quot;")
				.replaceAll("'", "&#039;");
		}

		function saveSailing() {
			const ship = clampText(el.ship.value);
			const sdate = clampText(el.sdate.value);
			const days = toNumOrNull(el.days.value);
			const routeName = clampText(el.routeName.value);

			if (!ship) return alert("Ship æ²’é¸åˆ°ï¼Œæ˜¯è¦è¿½è¹¤å¹½éˆéƒµè¼ªï¼Ÿ");
			if (!sdate) return alert("è«‹å¡« SDateï¼ˆå‡ºç™¼æ—¥ï¼‰ã€‚");
			if (!days || days <= 0) return alert("Days è«‹å¡«æ­£æ•´æ•¸ã€‚");

			// Auto EDate only if user didn't manually edit
			if (!edateManuallyEdited || !clampText(el.edate.value)) {
				const auto = dateAddDaysInclusive(sdate, days);
				if (auto) el.edate.value = auto;
			}

			const id = genSailingId(ship, sdate);
			if (!id) return alert("ID ç”¢ç”Ÿå¤±æ•—ï¼ˆé€™å¾ˆé›£ç™¼ç”Ÿï¼Œé™¤éä½ æŠŠæ—¥æœŸæ ¼å¼ç©å£ï¼‰ã€‚");

			// æ›´æ–°å­—å…¸ï¼ˆåŒæª”å…§é•·å¤§ï¼‰
			upsertDictValue(DATA.dict.cities, el.scity.value);
			upsertDictValue(DATA.dict.cities, el.ecity.value);
			upsertDictValue(DATA.dict.route_names, routeName);

			renderDatalists();

			const sailing = {
				id,
				ship,
				days,
				route_name: routeName,
				sdate,
				edate: clampText(el.edate.value),
				scity: clampText(el.scity.value),
				ecity: clampText(el.ecity.value),
				visiting: clampText(el.visiting.value),
				url: clampText(el.url.value),
				remark: clampText(el.sailingRemark.value)
			};

			if (editingSailingId && editingSailingId !== id) {
				// ç·¨è¼¯æ™‚è‹¥ ID æ”¹è®Šï¼ˆä¾‹å¦‚æ”¹äº† ship æˆ– sdateï¼‰ï¼Œè¦å•ä½ è¦ä¸è¦ç´šè¯æ¬å®¶å¿«ç…§
				const ok = confirm(
					`ä½ æ”¹äº† ship æˆ– sdateï¼ŒID æœƒå¾\n${editingSailingId}\nè®Šæˆ\n${id}\n\nè¦æŠŠèˆŠ ID çš„åƒ¹æ ¼å¿«ç…§ä¸€èµ·æ¬åˆ°æ–° ID å—ï¼Ÿ\nï¼ˆä¸æ¬å°±æœƒè®Šæˆå­¤å…’è³‡æ–™ï¼‰`
				);
				if (ok) {
					DATA.price_snapshots.forEach(p => {
						if (p.sailing_id === editingSailingId) p.sailing_id = id;
					});
				}
				// ä¸ç®¡æ¬ä¸æ¬ï¼ŒèˆŠä¸»æª”è¦ç§»é™¤ï¼ˆé¿å…å…©ç­†åŒå…§å®¹ï¼‰
				DATA.sailings = DATA.sailings.filter(s => s.id !== editingSailingId);
			}

			const idx = DATA.sailings.findIndex(s => s.id === id);
			if (idx >= 0) DATA.sailings[idx] = sailing;
			else DATA.sailings.push(sailing);

			editingSailingId = null;
			el.btnSaveSailing.textContent = "æ–°å¢èˆªç¨‹";

			// è‡ªå‹•é¸å–é€™ç­†
			setSelectedSailing(id);

			// è®“ä½ è¼¸å…¥é †ä¸€é»
			// ï¼ˆä½ è¦å›ä¸»æª”ç¹¼çºŒæ–°å¢ä¹Ÿè¡Œï¼Œä½†é€šå¸¸æ–°å¢å®Œæœƒæƒ³è¨˜å¿«ç…§ï¼‰
			// showView("snapshots");

			renderSailingList();
			updateMetaAndJsonView();
			syncIdPreview();
		}

		function deleteSailingCascade(id) {
			const s = DATA.sailings.find(x => x.id === id);
			const title = s ? `${s.route_name || "ï¼ˆæœªåˆ†é¡ï¼‰"} / ${s.ship} / ${s.sdate}` : id;

			const ok = confirm(`ç¢ºå®šåˆªé™¤é€™æ¢èˆªç¨‹ï¼Ÿ\n${title}\n\nå°‡ä¸€ä½µåˆªé™¤æ‰€æœ‰åƒ¹æ ¼å¿«ç…§ï¼ˆä¸å¯å¾©åŸï¼‰ã€‚`);
			if (!ok) return;

			DATA.sailings = DATA.sailings.filter(x => x.id !== id);
			DATA.price_snapshots = DATA.price_snapshots.filter(p => p.sailing_id !== id);

			if (selectedSailingId === id) setSelectedSailing(null);
			if (editingSailingId === id) resetSailingForm();

			renderSailingList();
			renderSnapshotList();
			updateMetaAndJsonView();

			// åˆªå®Œå°±å›ä¸»æª”è¦–åœ–ï¼Œé¿å…ä½ åœ¨å¿«ç…§é çœ‹è‘—ç©ºç©ºç™¼å‘†
			showView("sailings");
		}

		function openUrl() {
			const u = clampText(el.url.value);
			if (!u) return alert("URL é‚„æ˜¯ç©ºçš„ï¼Œä½ è¦æˆ‘æ‰“é–‹ä»€éº¼ï¼Ÿ");
			window.open(u, "_blank");
		}

		function saveSnapshot() {
			if (!selectedSailingId) return alert("è«‹å…ˆé¸èˆªç¨‹ã€‚");

			const date = clampText(el.pDate.value);
			if (!date) return alert("å¿«ç…§ Date ä¸èƒ½ç©ºã€‚");

			const veranda = toNumOrNull(el.pVeranda.value);
			const aqua = toNumOrNull(el.pAqua.value);
			const suite = toNumOrNull(el.pSuite.value);

			if (veranda === null && aqua === null && suite === null) {
				return alert("è‡³å°‘å¡«ä¸€å€‹åƒ¹æ ¼ï¼ˆVeranda/Aqua/Suiteï¼‰ï¼Œä¸ç„¶ä½ æ˜¯åœ¨è¨˜ç©ºæ°£ã€‚");
			}

			const payload = {
				date,
				veranda,
				aqua,
				suite,
				remark: clampText(el.pRemark.value)
			};

			// â˜… æœ‰ editingSnapshotIdï¼šæ›´æ–°æ—¢æœ‰å¿«ç…§
			if (editingSnapshotId) {
				const idx = DATA.price_snapshots.findIndex(p => p._id === editingSnapshotId);
				if (idx >= 0) {
					DATA.price_snapshots[idx] = {
						...DATA.price_snapshots[idx],
						...payload
					};
				}

				editingSnapshotId = null;
				el.btnSaveSnapshot.textContent = "æ–°å¢å¿«ç…§";
			}
			// â˜… æ²’æœ‰ editingSnapshotIdï¼šæ–°å¢å¿«ç…§
			else {
				DATA.price_snapshots.push({
					_id: cryptoId(),
					sailing_id: selectedSailingId,
					...payload
				});
			}

			renderSnapshotList();
			// è‹¥ä½ æƒ³è®“ã€Œæª¢è¦–å¿«ç…§ã€å€å¡Šä¹Ÿè·Ÿè‘—æ›´æ–°ï¼Œå¯ä»¥é †ä¾¿è£œé€™è¡Œ
			// renderSnapshotPreview();

			updateMetaAndJsonView();
			resetSnapshotForm();
		}

		function deleteSnapshot(snapshotId) {
			const ok = confirm("åˆªé™¤é€™ç­†å¿«ç…§ï¼Ÿï¼ˆä¸å¯å¾©åŸï¼‰");
			if (!ok) return;

			DATA.price_snapshots = DATA.price_snapshots.filter(p => p._id !== snapshotId);
			renderSnapshotList();
			updateMetaAndJsonView();
		}

		function cryptoId() {
			// å¾ˆçŸ­çš„éš¨æ©Ÿ idï¼Œé¿å…åŒæ—¥å¤šç­†å¿«ç…§åˆªé™¤æ™‚ä¸å¥½ç²¾æº–å®šä½
			// ä¸æ‹¿ä¾†ç•¶ä¸»éµçµ¦äººçœ‹ï¼Œåªæ˜¯å…§éƒ¨åˆªé™¤ç”¨
			const a = new Uint8Array(6);
			crypto.getRandomValues(a);
			return Array.from(a).map(x => x.toString(16).padStart(2, "0")).join("");
		}

		function exportJson() {
			const blob = new Blob([JSON.stringify(DATA, null, 2)], { type: "application/json" });
			const a = document.createElement("a");
			a.href = URL.createObjectURL(blob);
			a.download = "cruise_tracker.json";
			a.click();
			URL.revokeObjectURL(a.href);
		}

		async function copyJson() {
			try {
				await navigator.clipboard.writeText(JSON.stringify(DATA, null, 2));
				alert("å·²è¤‡è£½ JSON");
			} catch {
				alert("è¤‡è£½å¤±æ•—ï¼ˆiOS æœ‰æ™‚æœƒè£æ­»ï¼‰ï¼Œä½ å¯ä»¥ç”¨åŒ¯å‡º JSON ä»£æ›¿ã€‚");
			}
		}

		function importJson() {
			el.fileInput.click();
		}

		function handleFile(file) {
			const reader = new FileReader();
			reader.onload = () => {
				try {
					const obj = JSON.parse(reader.result);

					// æœ€ä½é™åº¦é©—è­‰
					if (!obj || typeof obj !== "object") throw new Error("bad json");
					if (!Array.isArray(obj.sailings) || !Array.isArray(obj.price_snapshots)) {
						throw new Error("missing arrays");
					}

					// æ¸…ç©ºå¾Œè¦†è“‹
					DATA.meta = obj.meta || DATA.meta;
					DATA.dict = obj.dict || { cities: [], route_names: [] };
					DATA.sailings = obj.sailings || [];
					DATA.price_snapshots = obj.price_snapshots || [];

					// ä¿®è£œ dict ä¸å­˜åœ¨æ™‚çš„é è¨­
					if (!Array.isArray(DATA.dict.cities)) DATA.dict.cities = [];
					if (!Array.isArray(DATA.dict.route_names)) DATA.dict.route_names = [];

					selectedSailingId = null;
					editingSailingId = null;

					renderDatalists();
					renderSailingList();
					renderSnapshotList();
					setSelectedSailing(null);
					resetSailingForm();
					resetSnapshotForm();
					updateMetaAndJsonView();

					showView("sailings");
				} catch (e) {
					alert("åŒ¯å…¥å¤±æ•—ï¼šJSON æ ¼å¼ä¸å°æˆ–ä¸æ˜¯ cruise_tracker æª”ã€‚");
				}
			};
			reader.readAsText(file);
		}

		// Events
		el.btnImport.onclick = importJson;
		el.btnExport.onclick = exportJson;
		el.btnCopy.onclick = copyJson;

		el.fileInput.onchange = (e) => {
			const file = e.target.files?.[0];
			if (file) handleFile(file);
			el.fileInput.value = "";
		};

		el.btnGoSailings.onclick = () => showView("sailings");
		el.btnGoSnapshots.onclick = () => showView("snapshots");

		el.btnBackToSailings.onclick = () => showView("sailings");

		el.btnOpenUrl.onclick = openUrl;

		el.btnSaveSailing.onclick = saveSailing;
		el.btnResetSailing.onclick = () => {
			editingSailingId = null;
			resetSailingForm();
			renderSailingList();
			updateMetaAndJsonView();
		};

		el.btnSaveSnapshot.onclick = saveSnapshot;
		el.btnResetSnapshot.onclick = resetSnapshotForm;

		// Auto EDate preview
		el.sdate.addEventListener("input", () => {
			edateManuallyEdited = false;
			syncIdPreview();
			const days = toNumOrNull(el.days.value);
			if (clampText(el.sdate.value) && days) {
				const auto = dateAddDaysInclusive(el.sdate.value, days);
				if (auto) el.edate.value = auto;
			}
		});

		el.ship.addEventListener("change", syncIdPreview);

		el.days.addEventListener("input", () => {
			edateManuallyEdited = false;
			syncIdPreview();
			const days = toNumOrNull(el.days.value);
			if (clampText(el.sdate.value) && days) {
				const auto = dateAddDaysInclusive(el.sdate.value, days);
				if (auto) el.edate.value = auto;
			}
		});

		el.edate.addEventListener("input", () => {
			edateManuallyEdited = true;
		});

		// Init
		(function init() {
			renderDatalists();
			resetSailingForm();
			resetSnapshotForm();
			setSelectedSailing(null);
			renderSailingList();
			renderSnapshotList();
			updateMetaAndJsonView();
			showView("sailings");
		})();
	</script>
</body>

</html>