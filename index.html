<!doctype html>
<html lang="zh-Hant">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Cruise Tracker</title>
	<style>
		:root {
			--card-bg: #fff;
			--ink: #222;
			--muted: #666;
			--radius: 12px;
			--border: #e3e3e6;
			--shadow: 0 2px 10px rgba(0, 0, 0, .06);
		}

		* {
			box-sizing: border-box
		}

		body {
			margin: 0;
			font-family: system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans TC", sans-serif;
			background: #fafafa;
			color: var(--ink)
		}

		header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 1rem 1.5rem;
			background: #fff;
			box-shadow: 0 2px 5px rgba(0, 0, 0, .05);
			position: sticky;
			top: 0;
			z-index: 10
		}

		header h2 {
			margin: 0;
			font-size: 1.25rem
		}

		header a {
			text-decoration: none;
			font-size: .95rem;
			padding: .45rem .85rem;
			border-radius: 6px;
			background: #eee;
			color: #333;
			box-shadow: 0 1px 4px rgba(0, 0, 0, .1);
			white-space: nowrap
		}

		.wrap {
			max-width: 1080px;
			margin: 0 auto;
			padding: 20px 16px 40px
		}

		h3 {
			margin: 0 0 8px;
			font-size: 1.05rem
		}

		p {
			margin: 0 0 10px;
			font-size: .95rem;
			color: var(--muted)
		}

		.toolbar {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
			align-items: center;
			background: var(--card-bg);
			padding: 14px;
			border-radius: var(--radius);
			box-shadow: var(--shadow);
			margin-bottom: 16px
		}

		.toolbar-group {
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
			align-items: center
		}

		.badge {
			display: inline-flex;
			align-items: center;
			gap: 6px;
			padding: 3px 8px;
			border-radius: 999px;
			background: #f4f4ff;
			font-size: .82rem;
			color: #555;
			white-space: nowrap
		}

		.badge-dot {
			width: 8px;
			height: 8px;
			border-radius: 50%;
			border: 2px solid #4f8cff
		}

		input[type="date"],
		input[type="text"],
		input[type="number"],
		input[type="url"],
		select,
		textarea {
			font-size: .95rem;
			padding: 8px 10px;
			border: 1px solid var(--border);
			border-radius: 10px;
			background: #fff
		}

		textarea {
			width: 100%;
			min-height: 96px;
			resize: vertical;
			line-height: 1.4
		}

		.btn {
			border: none;
			background: #2f855a;
			color: #fff;
			padding: 9px 14px;
			border-radius: 12px;
			cursor: pointer;
			font-size: .98rem;
			display: inline-flex;
			align-items: center;
			gap: 6px;
			white-space: nowrap
		}

		.btn.secondary {
			background: #4f8cff
		}

		.btn.ghost {
			background: #e0e7ff;
			color: #333
		}

		.btn.danger {
			background: #c62828
		}

		.btn[disabled] {
			background: #bdbdbd;
			cursor: not-allowed
		}

		.panel {
			background: var(--card-bg);
			border-radius: var(--radius);
			padding: 12px 12px 16px;
			box-shadow: var(--shadow);
			margin-bottom: 18px
		}

		.list {
			border-top: 1px dashed #e0e0e0;
			padding-top: 8px;
			margin-top: 6px;
			max-height: 360px;
			overflow: auto
		}

		.chip {
			border-radius: 999px;
			border: 1px solid #e0e0e0;
			padding: 10px 12px;
			margin-bottom: 8px;
			display: flex;
			align-items: flex-start;
			gap: 10px;
			background: #fafafa;
			font-size: .9rem
		}

		.chip-main {
			display: flex;
			flex-direction: column;
			min-width: 0;
			flex: 1 1 auto
		}

		.chip-title {
			font-weight: 650;
			display: -webkit-box;
			-webkit-line-clamp: 2;
			-webkit-box-orient: vertical;
			overflow: hidden
		}

		.chip-meta {
			font-size: .82rem;
			color: var(--muted);
			white-space: nowrap;
			text-overflow: ellipsis;
			overflow: hidden
		}

		.chip-actions {
			display: flex;
			gap: 6px;
			flex-shrink: 0;
			margin-left: auto;
			align-self: center
		}

		.chip button {
			border: none;
			border-radius: 999px;
			padding: 7px 12px;
			font-size: .92rem;
			cursor: pointer
		}

		.chip button.view {
			background: #e8f5e9;
			color: #1b5e20
		}

		.chip button.add {
			background: #f3e5f5;
			color: #6a1b9a
		}

		.chip button.edit {
			background: #e3f2fd;
			color: #1565c0
		}

		.chip button.delete {
			background: #ffebee;
			color: #c62828
		}

		/* iPad/çª„è¢å¹•ï¼šchip å…è¨±æ›è¡Œï¼Œé¿å…æŒ‰éˆ•è¢«æ“ å‡ºç•«é¢ */
		@media (max-width: 900px) {
			.chip {
				flex-wrap: wrap
			}

			.chip-actions {
				width: 100%;
				margin-left: 0;
				justify-content: flex-end
			}

			.chip-meta {
				white-space: normal
			}
		}

		.mono {
			font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace
		}

		.hint {
			font-size: .85rem;
			color: var(--muted);
			line-height: 1.4
		}

		/* Modal */
		.modal-backdrop {
			position: fixed;
			inset: 0;
			background: rgba(0, 0, 0, .35);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 50;
			padding: 18px
		}

		.modal-backdrop.active {
			display: flex
		}

		.modal {
			width: min(900px, 100%);
			max-height: 92vh;
			overflow: auto;
			background: #fff;
			border-radius: 16px;
			box-shadow: 0 20px 60px rgba(0, 0, 0, .25);
			padding: 14px 14px 16px
		}

		.modal-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 10px;
			margin-bottom: 10px
		}

		.modal-header h3 {
			margin: 0
		}

		.modal-actions {
			display: flex;
			gap: 8px;
			flex-wrap: wrap
		}

		.grid {
			display: grid;
			grid-template-columns: 120px 1fr 120px 1fr;
			gap: 10px;
			align-items: center
		}

		.grid label {
			color: var(--muted);
			font-size: .9rem;
			text-align: left
		}

		.grid .full {
			grid-column: 1 / -1
		}

		@media (max-width: 820px) {
			.grid {
				grid-template-columns: 1fr
			}

			.grid label {
				margin-top: 4px
			}
		}
	</style>
</head>

<body>
	<header>
		<h2>ğŸ›³ï¸ Cruise Tracker</h2>
		<a href="/">å›é¦–é </a>
	</header>

	<div class="wrap">
		<div class="toolbar">
			<div class="toolbar-group">
				<button class="btn secondary" id="btnImport">åŒ¯å…¥ JSON</button>
				<button class="btn secondary" id="btnExport">åŒ¯å‡º JSON</button>
				<button class="btn ghost" id="btnCopy">è¤‡è£½ JSON</button>
				<input type="file" id="fileInput" accept="application/json" style="display:none" />
			</div>

			<div class="toolbar-group">
				<button class="btn" id="btnNewSailing">æ–°å¢èˆªç¨‹</button>
				<span class="badge" title="ä½ å·²ç¶“æ±ºå®šäº†ï¼Œåˆ¥å†æŠ˜ç£¨è‡ªå·±">
					<span class="badge-dot"></span>
					å¹£åˆ¥ï¼šUSD
				</span>
				<span class="badge" id="badgeSelected" title="å…ˆæª¢è¦–ä¸€æ¢èˆªç¨‹ï¼Œæ‰æœƒæœ‰å¿«ç…§æ¸…å–®">
					<span class="badge-dot" style="border-color:#2f855a"></span>
					ç›®å‰æœªé¸èˆªç¨‹
				</span>
			</div>
		</div>

		<section class="panel">
			<h3>èˆªç¨‹æ¸…å–®ï¼ˆèˆªç¨‹ â†’ æ™‚é–“æ­£åºï¼‰</h3>
			<div class="list" id="sailingList"></div>
		</section>

		<section class="panel">
			<h3>åƒ¹æ ¼å¿«ç…§ï¼ˆå€’åºï¼‰</h3>
			<p class="hint">é»ä¸Šé¢æŸæ¢èˆªç¨‹çš„ã€Œæª¢è¦–åƒ¹æ ¼ã€å¾Œï¼Œå¿«ç…§æœƒå‡ºç¾åœ¨é€™è£¡ã€‚æ¯ç­†éƒ½å¯ä»¥ç·¨è¼¯æˆ–åˆªé™¤ã€‚</p>
			<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
				<span class="mono" id="previewTitle">å°šæœªé¸æ“‡èˆªç¨‹</span>
				<button class="btn ghost" id="btnNewSnapshot" disabled>æ–°å¢å¿«ç…§</button>
			</div>
			<div class="list" id="snapshotList"></div>
		</section>
	</div>

	<!-- datalists -->
	<datalist id="dlCities"></datalist>
	<datalist id="dlRouteNames"></datalist>

	<!-- Sailing Modal -->
	<div class="modal-backdrop" id="modalSailing">
		<div class="modal" role="dialog" aria-modal="true">
			<div class="modal-header">
				<h3 id="modalSailingTitle">æ–°å¢èˆªç¨‹</h3>
				<div class="modal-actions">
					<button class="btn ghost" id="btnSailingCancel">å–æ¶ˆ</button>
					<button class="btn" id="btnSailingSave">å„²å­˜</button>
				</div>
			</div>

			<div class="grid">
				<label>éƒµè¼ªåç¨±</label>
				<select id="mShip">
					<option value="X_EDGE">X_EDGE</option>
					<option value="X_SOLSTICE">X_SOLSTICE</option>
					<option value="X_SILHOUETTE">X_SILHOUETTE</option>
				</select>

				<label>æ™šæ•¸</label>
				<input id="mDays" type="number" min="1" step="1" placeholder="8" />


				<label>å‡ºç™¼æ—¥æœŸ</label>
				<input id="mSdate" type="date" />

				<label>æŠµé”æ—¥æœŸ</label>
				<input id="mEdate" type="date" />

				<label>å‡ºç™¼åŸå¸‚</label>
				<input id="mScity" type="text" list="dlCities" placeholder="ï¼ˆä¸­æ–‡ï¼‰" />

				<label>æŠµé”åŸå¸‚</label>
				<input id="mEcity" type="text" list="dlCities" placeholder="ï¼ˆä¸­æ–‡ï¼‰" />
				
				<label>éƒµè¼ªç›®çš„</label>
				<input id="mRouteName" type="text" list="dlRouteNames" placeholder="é˜¿æ‹‰æ–¯åŠ  / å¤§æºªåœ° / ç§»èˆª..." />

				<div class="full hint" id="mIdPreview">IDï¼šâ€”</div>

				<div class="full" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
					<label style="min-width:120px">å®˜ç¶² URL</label>
					<input id="mUrl" type="url" style="flex:1 1 420px;min-width:0" placeholder="https://..." />
					<button class="btn ghost" id="btnOpenUrl" type="button">é–‹å•Ÿå®˜ç¶²</button>
				</div>

				<div class="full">
					<label>åœé æ¸¯å£</label>
					<textarea id="mVisiting" placeholder="ä¾‹å¦‚ï¼šæ©«æ¿± > æµ·ä¸Š > æº«å“¥è¯..."></textarea>
				</div>

				<div class="full">
					<label>å‚™è¨»</label>
					<textarea id="mRemark" placeholder="èˆ¹åã€OBCã€ä¿ƒéŠ·ã€ä½ çš„ç¢å¿µï¼Œé€šé€šå¡é€™è£¡ã€‚"></textarea>
				</div>
			</div>
		</div>
	</div>

	<!-- Snapshot Modal -->
	<div class="modal-backdrop" id="modalSnapshot">
		<div class="modal" role="dialog" aria-modal="true">
			<div class="modal-header">
				<h3 id="modalSnapshotTitle">æ–°å¢å¿«ç…§</h3>
				<div class="modal-actions">
					<button class="btn ghost" id="btnSnapshotCancel">å–æ¶ˆ</button>
					<button class="btn" id="btnSnapshotSave">å„²å­˜</button>
				</div>
			</div>

			<div class="grid">
				<label>èˆªç¨‹</label>
				<input id="mSnapSailing" type="text" class="mono" readonly />

				<label>å·¡åƒ¹æ—¥æœŸ</label>
				<input id="mSnapDate" type="date" />

				<label>Veranda</label>
				<input id="mSnapVeranda" type="number" min="0" step="1" placeholder="2949" />

				<label>Aqua</label>
				<input id="mSnapAqua" type="number" min="0" step="1" placeholder="ï¼ˆå¯ç©ºï¼‰" />

				<label>Suite</label>
				<input id="mSnapSuite" type="number" min="0" step="1" placeholder="ï¼ˆå¯ç©ºï¼‰" />

				<div class="full">
					<label>å‚™è¨»</label>
					<textarea id="mSnapRemark" placeholder="ä¾‹å¦‚ï¼šé»‘äº”/flash saleï¼›OBC:200"></textarea>
				</div>
			</div>
		</div>
	</div>

	<script>
		"use strict";

		// ===== Data =====
		const DATA = {
			meta: { schema_version: 1, updated_at: "" },
			dict: { cities: [], route_names: [] },
			sailings: [],
			price_snapshots: []
		};

		let selectedSailingId = null; // currently previewing snapshots for this sailing
		let editingSailingId = null; // modal sailing edit target
		let editingSnapshotId = null; // modal snapshot edit target
		let edateManuallyEdited = false;

		// ===== Helpers =====
		const clampText = (s) => (s ?? "").toString().trim();

		function nowISO() {
			const d = new Date();
			const pad = (n) => String(n).padStart(2, "0");
			const yyyy = d.getFullYear();
			const mm = pad(d.getMonth() + 1);
			const dd = pad(d.getDate());
			const hh = pad(d.getHours());
			const mi = pad(d.getMinutes());
			const ss = pad(d.getSeconds());
			const tz = -d.getTimezoneOffset();
			const sign = tz >= 0 ? "+" : "-";
			const tzh = pad(Math.floor(Math.abs(tz) / 60));
			const tzm = pad(Math.abs(tz) % 60);
			return `${yyyy}-${mm}-${dd}T${hh}:${mi}:${ss}${sign}${tzh}:${tzm}`;
		}

		function toNumOrNull(v) {
			const t = clampText(v);
			if (!t) return null;
			const n = Number(t);
			return Number.isFinite(n) ? n : null;
		}

		function formatMoney(n) {
			if (n === null || n === undefined) return "-";
			if (!Number.isFinite(n)) return "-";
			return String(Math.round(n));
		}

		function shipToIdPart(shipValue) {
			const s = clampText(shipValue);
			const parts = s.split("_");
			return parts.length >= 2 ? parts.slice(1).join("_") : s;
		}

		function genSailingId(shipValue, sdateValue) {
			const shipPart = shipToIdPart(shipValue);
			const sdate = clampText(sdateValue);
			if (!shipPart || !sdate) return "";
			const yyyymmdd = sdate.replaceAll("-", "");
			return `X_${shipPart}_${yyyymmdd}`;
		}

		function dateAddDaysInclusive(yyyyMmDd, days) {
			const s = clampText(yyyyMmDd);
			const d = Number(days);
			if (!s || !Number.isFinite(d) || d <= 0) return "";
			const dt = new Date(s + "T00:00:00");
			if (Number.isNaN(dt.getTime())) return "";
			dt.setDate(dt.getDate() + d);
			const pad = (n) => String(n).padStart(2, "0");
			return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`;
		}

		function cryptoId() {
			const a = new Uint8Array(6);
			crypto.getRandomValues(a);
			return Array.from(a).map(x => x.toString(16).padStart(2, "0")).join("");
		}

		function escapeHtml(str) {
			return (str ?? "").toString()
				.replaceAll("&", "&amp;")
				.replaceAll("<", "&lt;")
				.replaceAll(">", "&gt;")
				.replaceAll('"', "&quot;")
				.replaceAll("'", "&#039;");
		}

		function upsertDictValue(arr, value) {
			const v = clampText(value);
			if (!v) return;
			if (!arr.includes(v)) arr.push(v);
		}

		function renderDatalists() {
			const dlCities = document.getElementById("dlCities");
			const dlRouteNames = document.getElementById("dlRouteNames");

			dlCities.innerHTML = "";
			DATA.dict.cities.forEach(c => {
				const opt = document.createElement("option");
				opt.value = c;
				dlCities.appendChild(opt);
			});

			dlRouteNames.innerHTML = "";
			DATA.dict.route_names.forEach(r => {
				const opt = document.createElement("option");
				opt.value = r;
				dlRouteNames.appendChild(opt);
			});
		}

		function touchUpdated() {
			DATA.meta.updated_at = nowISO();
		}

		// ===== DOM =====
		const el = {
			fileInput: document.getElementById("fileInput"),
			btnImport: document.getElementById("btnImport"),
			btnExport: document.getElementById("btnExport"),
			btnCopy: document.getElementById("btnCopy"),

			btnNewSailing: document.getElementById("btnNewSailing"),
			badgeSelected: document.getElementById("badgeSelected"),

			sailingList: document.getElementById("sailingList"),
			previewTitle: document.getElementById("previewTitle"),
			btnNewSnapshot: document.getElementById("btnNewSnapshot"),
			snapshotList: document.getElementById("snapshotList"),

			modalSailing: document.getElementById("modalSailing"),
			modalSailingTitle: document.getElementById("modalSailingTitle"),
			btnSailingCancel: document.getElementById("btnSailingCancel"),
			btnSailingSave: document.getElementById("btnSailingSave"),

			mShip: document.getElementById("mShip"),
			mDays: document.getElementById("mDays"),
			mRouteName: document.getElementById("mRouteName"),
			mSdate: document.getElementById("mSdate"),
			mEdate: document.getElementById("mEdate"),
			mScity: document.getElementById("mScity"),
			mEcity: document.getElementById("mEcity"),
			mIdPreview: document.getElementById("mIdPreview"),
			mUrl: document.getElementById("mUrl"),
			btnOpenUrl: document.getElementById("btnOpenUrl"),
			mVisiting: document.getElementById("mVisiting"),
			mRemark: document.getElementById("mRemark"),

			modalSnapshot: document.getElementById("modalSnapshot"),
			modalSnapshotTitle: document.getElementById("modalSnapshotTitle"),
			btnSnapshotCancel: document.getElementById("btnSnapshotCancel"),
			btnSnapshotSave: document.getElementById("btnSnapshotSave"),

			mSnapSailing: document.getElementById("mSnapSailing"),
			mSnapDate: document.getElementById("mSnapDate"),
			mSnapVeranda: document.getElementById("mSnapVeranda"),
			mSnapAqua: document.getElementById("mSnapAqua"),
			mSnapSuite: document.getElementById("mSnapSuite"),
			mSnapRemark: document.getElementById("mSnapRemark")
		};

		// ===== UI state =====
		function setSelectedSailing(id) {
			selectedSailingId = id;

			if (!id) {
				el.badgeSelected.innerHTML = `<span class="badge-dot" style="border-color:#2f855a"></span>ç›®å‰æœªé¸èˆªç¨‹`;
				el.previewTitle.textContent = "å°šæœªé¸æ“‡èˆªç¨‹";
				el.btnNewSnapshot.disabled = true;
			} else {
				el.badgeSelected.innerHTML = `<span class="badge-dot" style="border-color:#2f855a"></span>ç›®å‰èˆªç¨‹ï¼š${id}`;
				el.previewTitle.textContent = id;
				el.btnNewSnapshot.disabled = false;
			}

			renderSnapshotList();
		}

		function openModal(backdrop) {
			backdrop.classList.add("active");
		}

		function closeModal(backdrop) {
			backdrop.classList.remove("active");
		}

		// Close modal when clicking backdrop
		[el.modalSailing, el.modalSnapshot].forEach(bd => {
			bd.addEventListener("click", (e) => {
				if (e.target === bd) closeModal(bd);
			});
		});

		document.addEventListener("keydown", (e) => {
			if (e.key === "Escape") {
				closeModal(el.modalSailing);
				closeModal(el.modalSnapshot);
			}
		});

		// ===== Render =====
		function renderSailingList() {
			el.sailingList.innerHTML = "";

			const sorted = [...DATA.sailings].sort((a, b) => {
				const ra = (a.route_name || "");
				const rb = (b.route_name || "");
				const r = ra.localeCompare(rb, "zh-Hant");
				if (r !== 0) return r;
				return (a.sdate || "").localeCompare(b.sdate || "");
			});

			sorted.forEach(s => {
				const chip = document.createElement("div");
				chip.className = "chip";

				const title = `${s.route_name || "ï¼ˆæœªåˆ†é¡ï¼‰"}  Â·  ${s.id}`;
				const meta = `${s.sdate || "?"}ï½${s.edate || "?"} Â· ${s.days || "?"}æ™š Â· ${s.scity || "?"}ï½${s.ecity || "?"}`;

				chip.innerHTML = `
          <div class="chip-main">
            <div class="chip-title">${escapeHtml(title)}</div>
            <div class="chip-meta mono">${escapeHtml(meta)}</div>
          </div>
          <div class="chip-actions">
            <button class="view" type="button">æª¢è¦–åƒ¹æ ¼</button>
            <button class="add" type="button">ï¼‹åƒ¹æ ¼</button>
            <button class="edit" type="button">ç·¨è¼¯</button>
            <button class="delete" type="button">åˆªé™¤</button>
          </div>
        `;

				const [btnView, btnAdd, btnEdit, btnDelete] = chip.querySelectorAll("button");

				btnView.onclick = () => {
					setSelectedSailing(s.id);
					// æ²å‹•å¿«ç…§å€å›é ‚
					el.snapshotList.scrollTop = 0;
				};

				btnAdd.onclick = () => {
					setSelectedSailing(s.id);
					openSnapshotModal(null, s.id);
				};

				btnEdit.onclick = () => {
					openSailingModal(s.id);
				};

				btnDelete.onclick = () => {
					deleteSailingCascade(s.id);
				};

				el.sailingList.appendChild(chip);
			});
		}

		function renderSnapshotList() {
			el.snapshotList.innerHTML = "";
			if (!selectedSailingId) return;

			const list = DATA.price_snapshots
				.filter(p => p.sailing_id === selectedSailingId)
				.sort((a, b) => (b.date || "").localeCompare(a.date || ""));

			if (list.length === 0) {
				el.snapshotList.innerHTML = `<div class="hint">ï¼ˆé€™æ¢èˆªç¨‹é‚„æ²’æœ‰å¿«ç…§ï¼‰</div>`;
				return;
			}

			list.forEach(p => {
				const chip = document.createElement("div");
				chip.className = "chip";

				const title = `${p.date || "ï¼ˆæœªå¡«æ—¥æœŸï¼‰"}`;
				const meta = `Veranda ${formatMoney(p.veranda)} | Aqua ${formatMoney(p.aqua)} | Suite ${formatMoney(p.suite)}`;

				chip.innerHTML = `
          <div class="chip-main">
            <div class="chip-title">${escapeHtml(title)}</div>
            <div class="chip-meta">${escapeHtml(meta)}${p.remark ? " Â· " + escapeHtml(p.remark) : ""}</div>
          </div>
          <div class="chip-actions">
            <button class="edit" type="button">ç·¨è¼¯</button>
            <button class="delete" type="button">åˆªé™¤</button>
          </div>
        `;

				const [btnEdit, btnDelete] = chip.querySelectorAll("button");
				btnEdit.onclick = () => openSnapshotModal(p._id, p.sailing_id);
				btnDelete.onclick = () => deleteSnapshot(p._id);

				el.snapshotList.appendChild(chip);
			});
		}

		// ===== Sailing modal =====
		function syncSailingIdPreview() {
			const id = genSailingId(el.mShip.value, el.mSdate.value);
			el.mIdPreview.textContent = id ? `IDï¼š${id}` : "IDï¼šâ€”";
		}

		function resetSailingModal() {
			editingSailingId = null;
			edateManuallyEdited = false;
			el.modalSailingTitle.textContent = "æ–°å¢èˆªç¨‹";
			el.mShip.value = "X_EDGE";
			el.mDays.value = "";
			el.mRouteName.value = "";
			el.mSdate.value = "";
			el.mEdate.value = "";
			el.mScity.value = "";
			el.mEcity.value = "";
			el.mUrl.value = "";
			el.mVisiting.value = "";
			el.mRemark.value = "";
			syncSailingIdPreview();
		}

		function openSailingModal(id) {
			resetSailingModal();

			if (id) {
				const s = DATA.sailings.find(x => x.id === id);
				if (!s) return;
				editingSailingId = id;
				el.modalSailingTitle.textContent = "ç·¨è¼¯èˆªç¨‹";

				el.mShip.value = s.ship || "X_EDGE";
				el.mDays.value = s.days ?? "";
				el.mRouteName.value = s.route_name ?? "";
				el.mSdate.value = s.sdate ?? "";
				el.mEdate.value = s.edate ?? "";
				el.mScity.value = s.scity ?? "";
				el.mEcity.value = s.ecity ?? "";
				el.mUrl.value = s.url ?? "";
				el.mVisiting.value = s.visiting ?? "";
				el.mRemark.value = s.remark ?? "";

				syncSailingIdPreview();
			}

			openModal(el.modalSailing);
		}

		function saveSailingFromModal() {
			const ship = clampText(el.mShip.value);
			const sdate = clampText(el.mSdate.value);
			const days = toNumOrNull(el.mDays.value);
			const routeName = clampText(el.mRouteName.value);

			if (!ship) return alert("Ship æ²’é¸åˆ°ï¼Œæ˜¯è¦è¿½è¹¤å¹½éˆéƒµè¼ªï¼Ÿ");
			if (!sdate) return alert("è«‹å¡«å‡ºç™¼æ—¥æœŸ");
			if (!days || days <= 0) return alert("Days è«‹å¡«æ­£æ•´æ•¸ã€‚");

			if (!edateManuallyEdited || !clampText(el.mEdate.value)) {
				const auto = dateAddDaysInclusive(sdate, days);
				if (auto) el.mEdate.value = auto;
			}

			const id = genSailingId(ship, sdate);
			if (!id) return alert("ID ç”¢ç”Ÿå¤±æ•—ã€‚");

			// dict
			upsertDictValue(DATA.dict.cities, el.mScity.value);
			upsertDictValue(DATA.dict.cities, el.mEcity.value);
			upsertDictValue(DATA.dict.route_names, routeName);
			renderDatalists();

			const sailing = {
				id,
				ship,
				days,
				route_name: routeName,
				sdate,
				edate: clampText(el.mEdate.value),
				scity: clampText(el.mScity.value),
				ecity: clampText(el.mEcity.value),
				visiting: clampText(el.mVisiting.value),
				url: clampText(el.mUrl.value),
				remark: clampText(el.mRemark.value)
			};

			if (editingSailingId && editingSailingId !== id) {
				const ok = confirm(
					`ä½ æ”¹äº† ship æˆ– sdateï¼ŒID æœƒå¾\n${editingSailingId}\nè®Šæˆ\n${id}\n\nè¦æŠŠèˆŠ ID çš„åƒ¹æ ¼å¿«ç…§ä¸€èµ·æ¬åˆ°æ–° ID å—ï¼Ÿ\nï¼ˆä¸æ¬å°±æœƒè®Šæˆå­¤å…’è³‡æ–™ï¼‰`
				);
				if (ok) {
					DATA.price_snapshots.forEach(p => {
						if (p.sailing_id === editingSailingId) p.sailing_id = id;
					});
				}
				DATA.sailings = DATA.sailings.filter(s => s.id !== editingSailingId);

				if (selectedSailingId === editingSailingId) {
					selectedSailingId = id;
				}
			}

			const idx = DATA.sailings.findIndex(s => s.id === id);
			if (idx >= 0) DATA.sailings[idx] = sailing;
			else DATA.sailings.push(sailing);

			touchUpdated();
			renderSailingList();

			// if this is the current preview, refresh
			if (selectedSailingId === id) {
				setSelectedSailing(id);
			} else if (!selectedSailingId) {
				// optional: auto select the newly created one
				setSelectedSailing(id);
			} else {
				// still update badge if we migrated
				setSelectedSailing(selectedSailingId);
			}

			closeModal(el.modalSailing);
		}

		function openUrlFromModal() {
			const u = clampText(el.mUrl.value);
			if (!u) return alert("URL é‚„æ˜¯ç©ºçš„ï¼Œä½ è¦æˆ‘æ‰“é–‹ä»€éº¼ï¼Ÿ");
			window.open(u, "_blank");
		}

		// auto EDate & ID preview
		function sailingModalRecalc() {
			syncSailingIdPreview();
			const days = toNumOrNull(el.mDays.value);
			if (!edateManuallyEdited && clampText(el.mSdate.value) && days) {
				const auto = dateAddDaysInclusive(el.mSdate.value, days);
				if (auto) el.mEdate.value = auto;
			}
		}

		// ===== Snapshot modal =====
		function resetSnapshotModal() {
			editingSnapshotId = null;
			el.modalSnapshotTitle.textContent = "æ–°å¢å¿«ç…§";
			el.mSnapSailing.value = selectedSailingId || "";
			el.mSnapDate.value = "";
			el.mSnapVeranda.value = "";
			el.mSnapAqua.value = "";
			el.mSnapSuite.value = "";
			el.mSnapRemark.value = "";
		}

		function openSnapshotModal(snapshotId, sailingId) {
			if (!sailingId) sailingId = selectedSailingId;
			if (!sailingId) return alert("è«‹å…ˆé¸èˆªç¨‹ã€‚");

			resetSnapshotModal();
			el.mSnapSailing.value = sailingId;

			if (snapshotId) {
				const p = DATA.price_snapshots.find(x => x._id === snapshotId);
				if (!p) return;
				editingSnapshotId = snapshotId;
				el.modalSnapshotTitle.textContent = "ç·¨è¼¯å¿«ç…§";

				el.mSnapDate.value = p.date || "";
				el.mSnapVeranda.value = p.veranda ?? "";
				el.mSnapAqua.value = p.aqua ?? "";
				el.mSnapSuite.value = p.suite ?? "";
				el.mSnapRemark.value = p.remark ?? "";
			}

			openModal(el.modalSnapshot);
		}

		function saveSnapshotFromModal() {
			const sailing_id = clampText(el.mSnapSailing.value);
			if (!sailing_id) return alert("èˆªç¨‹ä¸è¦‹äº†ï¼Œé€™ä¸æ‡‰è©²ç™¼ç”Ÿã€‚");

			const date = clampText(el.mSnapDate.value);
			if (!date) return alert("å·¡åƒ¹æ—¥æœŸä¸èƒ½ç©ºã€‚");

			const veranda = toNumOrNull(el.mSnapVeranda.value);
			const aqua = toNumOrNull(el.mSnapAqua.value);
			const suite = toNumOrNull(el.mSnapSuite.value);

			if (veranda === null && aqua === null && suite === null) {
				return alert("è‡³å°‘å¡«ä¸€å€‹åƒ¹æ ¼ï¼ˆVeranda/Aqua/Suiteï¼‰ã€‚");
			}

			const payload = {
				sailing_id,
				date,
				veranda,
				aqua,
				suite,
				remark: clampText(el.mSnapRemark.value)
			};

			if (editingSnapshotId) {
				const idx = DATA.price_snapshots.findIndex(p => p._id === editingSnapshotId);
				if (idx >= 0) {
					DATA.price_snapshots[idx] = { ...DATA.price_snapshots[idx], ...payload };
				}
			} else {
				DATA.price_snapshots.push({ _id: cryptoId(), ...payload });
			}

			touchUpdated();

			// make sure preview points to this sailing
			setSelectedSailing(sailing_id);

			closeModal(el.modalSnapshot);
		}

		function deleteSnapshot(snapshotId) {
			const ok = confirm("åˆªé™¤é€™ç­†å¿«ç…§ï¼Ÿï¼ˆä¸å¯å¾©åŸï¼‰");
			if (!ok) return;
			DATA.price_snapshots = DATA.price_snapshots.filter(p => p._id !== snapshotId);
			touchUpdated();
			renderSnapshotList();
		}

		function deleteSailingCascade(id) {
			const s = DATA.sailings.find(x => x.id === id);
			const title = s ? `${s.route_name || "ï¼ˆæœªåˆ†é¡ï¼‰"} / ${s.ship} / ${s.sdate}` : id;
			const ok = confirm(`ç¢ºå®šåˆªé™¤é€™æ¢èˆªç¨‹ï¼Ÿ\n${title}\n\nå°‡ä¸€ä½µåˆªé™¤æ‰€æœ‰åƒ¹æ ¼å¿«ç…§ï¼ˆä¸å¯å¾©åŸï¼‰ã€‚`);
			if (!ok) return;

			DATA.sailings = DATA.sailings.filter(x => x.id !== id);
			DATA.price_snapshots = DATA.price_snapshots.filter(p => p.sailing_id !== id);

			if (selectedSailingId === id) setSelectedSailing(null);

			touchUpdated();
			renderSailingList();
			renderSnapshotList();
		}

		// ===== Import/Export/Copy =====
		function exportJson() {
			touchUpdated();
			const blob = new Blob([JSON.stringify(DATA, null, 2)], { type: "application/json" });
			const a = document.createElement("a");
			a.href = URL.createObjectURL(blob);
			a.download = "cruise_tracker.json";
			a.click();
			URL.revokeObjectURL(a.href);
		}

		async function copyJson() {
			try {
				touchUpdated();
				await navigator.clipboard.writeText(JSON.stringify(DATA, null, 2));
				alert("å·²è¤‡è£½ JSON");
			} catch {
				alert("è¤‡è£½å¤±æ•—ï¼ˆiOS æœ‰æ™‚æœƒè£æ­»ï¼‰ï¼Œä½ å¯ä»¥ç”¨åŒ¯å‡º JSON ä»£æ›¿ã€‚");
			}
		}

		function importJson() {
			el.fileInput.click();
		}

		function handleFile(file) {
			const reader = new FileReader();
			reader.onload = () => {
				try {
					const obj = JSON.parse(reader.result);
					if (!obj || typeof obj !== "object") throw new Error("bad json");
					if (!Array.isArray(obj.sailings) || !Array.isArray(obj.price_snapshots)) throw new Error("missing arrays");

					DATA.meta = obj.meta || DATA.meta;
					DATA.dict = obj.dict || { cities: [], route_names: [] };
					DATA.sailings = obj.sailings || [];
					DATA.price_snapshots = obj.price_snapshots || [];

					if (!Array.isArray(DATA.dict.cities)) DATA.dict.cities = [];
					if (!Array.isArray(DATA.dict.route_names)) DATA.dict.route_names = [];

					renderDatalists();
					renderSailingList();
					setSelectedSailing(null);
					touchUpdated();
				} catch {
					alert("åŒ¯å…¥å¤±æ•—ï¼šJSON æ ¼å¼ä¸å°æˆ–ä¸æ˜¯ cruise_tracker æª”ã€‚");
				}
			};
			reader.readAsText(file);
		}

		// ===== Events =====
		el.btnImport.onclick = importJson;
		el.btnExport.onclick = exportJson;
		el.btnCopy.onclick = copyJson;

		el.fileInput.onchange = (e) => {
			const file = e.target.files?.[0];
			if (file) handleFile(file);
			el.fileInput.value = "";
		};

		el.btnNewSailing.onclick = () => openSailingModal(null);

		el.btnNewSnapshot.onclick = () => {
			if (!selectedSailingId) return;
			openSnapshotModal(null, selectedSailingId);
		};

		el.btnSailingCancel.onclick = () => closeModal(el.modalSailing);
		el.btnSailingSave.onclick = saveSailingFromModal;

		el.btnSnapshotCancel.onclick = () => closeModal(el.modalSnapshot);
		el.btnSnapshotSave.onclick = saveSnapshotFromModal;

		el.btnOpenUrl.onclick = openUrlFromModal;

		// modal sailing live calc
		el.mShip.addEventListener("change", () => { edateManuallyEdited = false;
			sailingModalRecalc(); });
		el.mSdate.addEventListener("input", () => { edateManuallyEdited = false;
			sailingModalRecalc(); });
		el.mDays.addEventListener("input", () => { edateManuallyEdited = false;
			sailingModalRecalc(); });
		el.mEdate.addEventListener("input", () => { edateManuallyEdited = true;
			syncSailingIdPreview(); });

		// ===== Init =====
		(function init() {
			renderDatalists();
			renderSailingList();
			setSelectedSailing(null);
			touchUpdated();
		})();
	</script>
</body>

</html>