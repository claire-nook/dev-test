<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trip to Map Lite</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js" crossorigin="anonymous"></script>

  <style>
    :root{ --bg:#f6f7fb; --panel:#fff; --line:#e5e7eb; --text:#111827; --primary:#2563eb; --header-h:52px; }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Hiragino Sans","Microsoft JhengHei",Arial,sans-serif}
    .site-header{position:fixed;top:0;left:0;right:0;background:rgba(255,255,255,.92);backdrop-filter:saturate(150%) blur(6px);border-bottom:1px solid var(--line);z-index:1000}
    .site-header .wrap{display:flex;align-items:center;gap:12px;padding:max(6px,env(safe-area-inset-top)) 12px 6px}
    .brand{font-weight:800;letter-spacing:.2px}
    .brand small{opacity:.6;font-weight:700;margin-left:6px}
    .grow{flex:1;min-width:0}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;height:36px;padding:0 12px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn-home{display:inline-flex;align-items:center;gap:8px;height:36px;padding:0 12px;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.06);color:rgba(17,24,39,.85);font-weight:600;text-decoration:none;cursor:pointer}
    .btn-home:hover{background:#f9fafb;border-color:#d1d5db}
    .btn-home:active{transform:scale(.98);box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .btn-home:focus{outline:2px solid #3b82f6;outline-offset:2px}
    .page{padding-top:var(--header-h);height:calc(100dvh - var(--header-h));display:flex;flex-direction:column}
    .tabs{display:flex;gap:8px;padding:8px 12px 0}
    .tab{flex:1;display:inline-flex;align-items:center;justify-content:center;height:36px;border-radius:999px;border:1px solid var(--line);background:#fff;color:#374151;cursor:pointer;font-weight:700}
    .tab.active{background:#111827;color:#fff;border-color:#111827}
    .content{flex:1;min-height:0;padding:12px;display:flex;flex-direction:column;gap:12px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.05);padding:12px}
    .grid{display:none;gap:12px;flex:1;min-height:0;height:100%}
    .col{display:flex;flex-direction:column;gap:12px;min-height:0}
    @media (min-width:900px){
      .tabs{display:none}
      .grid{display:grid;grid-template-columns:2fr 3fr;grid-auto-rows:1fr}
      #stackList, #stackMap{display:none !important}
      .content{padding:12px}
    }
    .add-box{display:flex;flex-direction:column;gap:8px}
    .row{display:flex;gap:8px}
    .row .select,.row .text,.row .note{flex:1}
    select,input[type="text"],textarea{width:100%;border:1px solid var(--line);border-radius:10px;background:#fff;padding:10px 12px;font:inherit}
    textarea{min-height:40px;max-height:120px;resize:vertical}
    .list{flex:1;min-height:0;overflow:auto}
    .item{display:flex;align-items:flex-start;gap:10px;padding:10px;border:1px solid #eef0f3;border-radius:12px;background:#fff}
    .item + .item{margin-top:8px}
    .badge{min-width:22px;height:22px;border-radius:999px;background:#111827;color:#fff;display:inline-flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;margin-top:2px}
    .meta{flex:1;display:flex;flex-direction:column;gap:4px;min-width:0}
    .title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .note{color:#6b7280;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .actions{display:flex;gap:6px}
    .iconbtn{height:32px;min-width:32px;padding:0 10px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer}
    .iconbtn.danger{border-color:#fecaca;background:#fff1f2;color:#b91c1c}
    .filters{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:14px}

 
.map-wrap {
  position: relative; /* è®“å…§éƒ¨å­å…ƒç´ ï¼ˆåƒ Leaflet çš„æ§åˆ¶å…ƒä»¶ï¼‰å¯ä»¥ç”¨çµ•å°å®šä½ */
  flex: 1;            /* åœ¨ flex å®¹å™¨ä¸­ï¼Œä½”æ“šå‰©é¤˜çš„å¯ç”¨ç©ºé–“ */
  min-height: 0;      /* é¿å… flex å­å…ƒç´ åœ¨æŸäº›ç€è¦½å™¨ä¸‹ç„¡æ³•ç¸®å° */
}   
/* åœ°åœ–å®¹å™¨ï¼šæ¡Œé¢ç‰ˆèˆ‡è¡Œå‹•ç‰ˆå…±ç”¨æ¨£å¼ */
#map,
#m_map {
  height: 55dvh;                 /* é«˜åº¦ = è¢å¹•é«˜åº¦çš„ 60%ï¼ˆå¯èª¿æ•´ï¼Œä¾‹å¦‚ 55dvhï¼‰ */
  border: 1px solid var(--line); /* å¤–æ¡†ç·šæ¢ */
  border-radius: 12px;           /* åœ“è§’ */
  overflow: hidden;              /* è¶…å‡ºéš±è—ï¼Œé¿å… tile æº¢å‡º */
  box-shadow: inset 0 0 0 1px rgba(0,0,0,.02); /* å…§æ¡†é™°å½±ï¼ˆå¾®å¦™çš„ç«‹é«”æ„Ÿï¼‰ */
}

/* æ¡Œé¢ç‰ˆï¼ˆå¯¬åº¦ >= 900pxï¼‰ï¼šåœ°åœ–è‡ªå‹•å¡«æ»¿çˆ¶å®¹å™¨é«˜åº¦ */
@media (min-width: 900px) {
  #map {
    height: 75%; /* åœ¨æ¡Œé¢ä½ˆå±€è£¡ï¼Œè®“åœ°åœ–æ’æ»¿æ•´å€‹å³å´æ¬„ä½ */
  }
}
 
    .summary{margin-top:8px;border:1px dashed #e5e7eb;border-radius:10px;padding:8px;background:#fff}
    .summary h3{margin:0 0 6px;font-size:15px}
    .summary ol{margin:0;padding-left:20px}
    .summary li{padding:2px 0}
    .tip{color:#6b7280;font-size:13px}
    
  /* 1) ç›’æ¨¡å‹çµ±ä¸€ï¼Œé¿å… padding/border æŠŠå¯¬åº¦æ’çˆ† */
*, *::before, *::after { box-sizing: border-box; }

/* 2) å³å´åœ°åœ–+æ¸…å–®å®¹å™¨ä¸å‡†åœ¨ X è»¸å¤–æº¢ï¼ˆé¿å…å‡ºç¾æ°´å¹³æ²è»¸ï¼‰ */
.map-wrap,
.summary { 
  max-width: 100%;
  overflow-x: hidden;       /* æˆ–ç”¨ clipï¼›Safari ä¹Ÿ OK */
}

/* 3) ordered list çš„ç¸®æ’ä¿å®ˆä¸€é»ï¼Œé¿å…é‚Šç•Œè¨ˆç®—èª¤å·® */
.summary ol {
  padding-left: 16px;       /* åŸæœ¬ 20px â†’ 16pxï¼Œæ›´ä¿å®ˆ */
  margin-right: 0;          /* ä¿è­‰ä¸å¾€å³æ’ */
}

/* å¦‚æœä»å¶ç™¼çœ‹åˆ° 1px çš„æ°´å¹³æ²è»¸ï¼ˆæŸäº›è£ç½® sub-pixelï¼‰ï¼š
   å¯ä»¥ä¿éšªä¸€é»åœ¨ä¸»è¦å®¹å™¨å±¤ç´šé—œæ‰ X æ²è»¸ */
.content { overflow-x: hidden; }  
 
/* æ‹–æ‹‰æ™‚çš„åŠé€æ˜å½±åƒï¼ˆSortable æœƒå¥—ç”¨ï¼‰ */
.drag-ghost { opacity: .5; }

/* è®“åˆ—è¡¨æ­£å¸¸ç›´å‘æ²å‹• */
.list { overscroll-behavior: contain; }

/* æ‹–æ›³æŠŠæ‰‹ */
.grip {
  width: 18px;
  align-self: stretch;
  display: grid; place-items: center;
  cursor: grab;
  user-select: none;
  touch-action: none;       /* åªæœ‰æŠŠæ‰‹ç¦æ­¢æ‰‹å‹¢ï¼Œé¿å…èˆ‡æ²å‹•æ‰“æ¶ */
  opacity: .6;
}
.grip:active { cursor: grabbing; opacity: .9; }

/* Sortable çš„è¦–è¦ºç‹€æ…‹ */
.sort-chosen { opacity: .9; }
.sort-ghost  { opacity: .5; }
.sort-drag   { opacity: .8; }

  
    
  </style>
</head>
<body>
  <header class="site-header" role="banner">
    <div class="wrap">
      <div class="brand">Trip to Map <small>Lite</small></div>
      <div class="grow"></div>
      <button class="btn" id="btnPrint">åˆ—å°</button>
      <a href="/" class="btn-home" id="homeBtn" aria-label="å›é¦–é "><span>ğŸ§­</span><span>å›é¦–é </span></a>
    </div>
  </header>

  <main class="page">
    <div class="tabs" role="tablist">
      <button class="tab active" data-tab="list">æ¸…å–®</button>
      <button class="tab" data-tab="map">åœ°åœ–</button>
    </div>

    <div class="content">
      <div class="grid">
        <section class="col">
          <div class="panel">
            <div class="add-box">
              <div class="row">
                <select class="select" id="type">
                  <option value="sight">ğŸ—º sight</option>
                  <option value="food">ğŸœ food</option>
                  <option value="cafe">â˜•ï¸ cafe</option>
                  <option value="sweet">ğŸ° sweet</option>
                  <option value="hotel">ğŸ¨ hotel</option>
                  <option value="transit">ğŸš‡ transit</option>
                  <option value="shop">ğŸ› shop</option>
                  <option value="other">â­ï¸ other</option>
                </select>
                <input class="text" type="text" id="input" placeholder="åç¨±æˆ–åœ°å€â€¦" />
                <button class="btn primary" id="btnAdd">åŠ å…¥</button>
              </div>
              <!-- æ–°å¢ï¼šé¡¯ç¤ºåç¨±ï¼ˆé¸å¡«ï¼Œé è¨­è·Ÿä¸Šé¢åŒæ­¥ï¼‰ -->
              <div class="row">
                <input class="text" type="text" id="disp" placeholder="é¡¯ç¤ºåç¨±ï¼ˆå¯é¸ï¼Œé è¨­ç”¨ä¸Šæ–¹ï¼‰" />
              </div>
              <div class="row">
                <textarea class="note" id="note" placeholder="å‚™è¨»ï¼ˆå¯é¸ï¼‰"></textarea>
              </div>
            </div>
          </div>

          <div class="panel" style="display:flex;flex-direction:column;min-height:0;">
            <div class="list" id="list"></div>
            <div class="tip" style="padding:8px 4px;">æç¤ºï¼šå¯æ‹–æ‹‰é …ç›®æ’åºæˆ–ç”¨ç®­é ­èª¿æ•´ï¼›æ’åºæœƒæ›´æ–°è·¯ç·šã€‚</div>
          </div>
        </section>

        <section class="col">
          <div class="panel" style="display:flex;flex-direction:column;min-height:0;flex:1 1 auto;">
            <div class="filters" id="filters"></div>
            <label class="chip"><input type="checkbox" id="routeToggle" checked> é¡¯ç¤ºè·¯ç·š</label>
            <div class="map-wrap" id="mapWrap">
              <div id="map" aria-label="åœ°åœ–"></div>
              <div class="summary" id="summary">
                <h3>ä»Šæ—¥æ¸…å–®</h3>
                <ol id="summaryList"></ol>
              </div>
            </div>
          </div>
        </section>
      </div>

      <section class="panel" id="stackList">
        <div class="add-box">
          <div class="row">
            <select class="select" id="m_type">
              <option value="sight">ğŸ—º sight</option>
              <option value="food">ğŸœ food</option>
              <option value="cafe">â˜•ï¸ cafe</option>
              <option value="sweet">ğŸ° sweet</option>
              <option value="hotel">ğŸ¨ hotel</option>
              <option value="transit">ğŸš‡ transit</option>
              <option value="shop">ğŸ› shop</option>
              <option value="other">â­ï¸ other</option>
            </select>
            <input class="text" type="text" id="m_input" placeholder="åç¨±æˆ–åœ°å€â€¦" />
            <button class="btn primary" id="m_btnAdd">åŠ å…¥</button>
          </div>
          <!-- æ–°å¢ï¼šè¡Œå‹•ç‰ˆé¡¯ç¤ºåç¨± -->
          <div class="row">
            <input class="text" type="text" id="m_disp" placeholder="é¡¯ç¤ºåç¨±ï¼ˆå¯é¸ï¼Œé è¨­ç”¨ä¸Šæ–¹ï¼‰" />
          </div>
          <div class="row">
            <textarea class="note" id="m_note" placeholder="å‚™è¨»ï¼ˆå¯é¸ï¼‰"></textarea>
          </div>
        </div>
        <div class="list" id="m_list" style="margin-top:12px;"></div>
      </section>

      <section class="panel" id="stackMap" style="display:none;">
        <div class="filters" id="m_filters"></div>
        <label class="chip"><input type="checkbox" id="m_routeToggle" checked> é¡¯ç¤ºè·¯ç·š</label>
        <div class="map-wrap">
          <div id="m_map"></div>
          <div class="summary" id="m_summary">
            <h3>ä»Šæ—¥æ¸…å–®</h3>
            <ol id="m_summaryList"></ol>
          </div>
        </div>
      </section>
    </div>
  </main>

<script>
(function(){
  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];
  const uid = () => Math.random().toString(36).slice(2,9);
  const EMOJI = { sight:"ğŸ—º", food:"ğŸœ", cafe:"â˜•ï¸", sweet:"ğŸ°", hotel:"ğŸ¨", transit:"ğŸš‡", shop:"ğŸ›", other:"â­ï¸" };
  const TYPES = Object.keys(EMOJI);

  function setHeaderHeightVar(){
    const h = $('.site-header').getBoundingClientRect().height;
    document.documentElement.style.setProperty('--header-h', h + 'px');
  }
  window.addEventListener('resize', setHeaderHeightVar);
  window.visualViewport && window.visualViewport.addEventListener('resize', setHeaderHeightVar);
  setHeaderHeightVar();

  const STORAGE_KEY = 'trip-lite-v3';
  const CACHE_KEY = 'geo-cache-v1';
  let model = { route:true, places:[], filters: new Set(TYPES) };
  try{
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    if(saved && Array.isArray(saved.places)){
      model = { ...model, ...saved, filters: new Set(saved.filters || TYPES) };
    }
  }catch(e){}
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({ ...model, filters:[...model.filters] })); }

  const cache = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
  function saveCache(){ localStorage.setItem(CACHE_KEY, JSON.stringify(cache)); }
  let geocodeQueue = Promise.resolve();
  function geocode(q){
    if(!q) return Promise.resolve(null);
    const key = q.trim().toLowerCase();
    if(cache[key]) return Promise.resolve(cache[key]);
    geocodeQueue = geocodeQueue.then(() => new Promise((resolve) => {
      setTimeout(async () => {
        try{
          const url = 'https://nominatim.openstreetmap.org/search?format=json&accept-language=zh-TW&q=' + encodeURIComponent(q);
        const res = await fetch(url, { headers:{'Accept':'application/json'} });
        const data = await res.json();
        const item = data && data[0] ? { lat:+data[0].lat, lng:+data[0].lon, display:data[0].display_name } : null;
        cache[key] = item; saveCache(); resolve(item);
        }catch(e){ resolve(null); }
      }, 700);
    }));
    return geocodeQueue;
  }

  // Leaflet map init
  function createMap(elId){
    const map = L.map(elId, { zoomControl:true, tap:false });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      crossOrigin: 'anonymous',
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    map.setView([25.033,121.5654], 12);
    return map;
  }
  const mapMain = createMap('map');
  const mapMobile = createMap('m_map');

  let markersMain=[], lineMain=null, markersM=[], lineM=null;
  function markerIcon(n){
    const el = document.createElement('div');
    el.style.cssText='width:28px;height:28px;border-radius:50%;border:2px solid #111;background:#fff;display:grid;place-items:center;box-shadow:0 2px 6px rgba(0,0,0,.25);font:700 13px/1 system-ui';
    el.textContent=n; return L.divIcon({html:el,iconSize:[28,28],className:'num-pin'});
  }
  function clearMap(isMobile){
    const mk = isMobile?markersM:markersMain; mk.forEach(m=>m.remove()); mk.length=0;
    const ln = isMobile?lineM:lineMain; if(ln){ ln.remove(); if(isMobile) lineM=null; else lineMain=null; }
  }
  function renderMap(isMobile){
    const map = isMobile?mapMobile:mapMain;
    const mkArr = isMobile?markersM:markersMain;
    clearMap(isMobile);
    const visible = model.places.filter(p=>model.filters.has(p.type));
    const latlngs=[];
    visible.forEach((p,i)=>{
      if(p.lat && p.lng){
        const m=L.marker([p.lat,p.lng],{icon:markerIcon(i+1)}).addTo(map);
        const title=`${EMOJI[p.type]} ${p.name || p.input || 'æœªå‘½å'}`;
        const note=p.note?`<div style="color:#6b7280;margin-top:4px;">${escapeHtml(p.note)}</div>`:'';
        m.bindPopup(`<div style="font-weight:700;margin-bottom:4px;">${title}</div>${note}`);
        mkArr.push(m); latlngs.push([p.lat,p.lng]);
      }
    });
    const routeOn = isMobile ? $('#m_routeToggle').checked : $('#routeToggle').checked;
    if(routeOn && latlngs.length>=2){
      const ln=L.polyline(latlngs,{color:'#2563eb',weight:4,opacity:.9}).addTo(map);
      if(isMobile) lineM=ln; else lineMain=ln;
    }
    if(latlngs.length){ try{ map.fitBounds(latlngs,{padding:[40,40]}); }catch(e){} }
    setTimeout(()=> map.invalidateSize(), 150);
  }

// å…©é»ç›´ç·šè·é›¢ï¼ˆå…¬å°ºï¼ŒHaversineï¼‰
function haversineMeters(a, b){
  if(!a || !b || !a.lat || !a.lng || !b.lat || !b.lng) return null;
  const R = 6371000;
  const toRad = d => d * Math.PI / 180;
  const dLat = toRad(b.lat - a.lat);
  const dLng = toRad(b.lng - a.lng);
  const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
  const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
  return 2 * R * Math.asin(Math.sqrt(s));
}

// å…¬é‡Œã€è‡³å°‘ 0.1ã€1 ä½å°æ•¸ï¼›å›å‚³ä¾‹å¦‚ "â†˜ï¸0.4km"
function formatKm(meters){
  if(meters == null) return '';
  const km = meters / 1000;
  const shown = Math.max(0.1, Math.round(km * 10) / 10);
  return 'â†˜ï¸' + shown.toFixed(1) + 'km';
}


function renderSummary(){
  const build = el=>{
    el.innerHTML='';

    // åªå–è¢«å‹¾é¸çš„é …ç›®ï¼Œä¸”ä¿ç•™é †åº
    const visible = model.places.filter(p => model.filters.has(p.type));

    visible.forEach((p, idx) => {
      const li = document.createElement('li');
      const name = p.name || p.input || 'æœªå‘½å';

      // è·é›¢ï¼šåˆ°ä¸‹ä¸€é»ï¼ˆæœ€å¾Œä¸€å€‹æ²’æœ‰ï¼‰
      let distText = '';
      if(idx < visible.length - 1){
        const next = visible[idx + 1];
        const m = haversineMeters(p, next);
        if(m != null) distText = `ï¼ˆ${formatKm(m)}ï¼‰`; // å…¨å½¢æ‹¬è™Ÿ + å…¨å½¢ç®­é ­
      }

      // å‚™è¨»ï¼ˆå¦‚æœ‰ï¼‰
      const noteText = p.note ? `ï¼ˆ${p.note}ï¼‰` : '';

      // æœ€çµ‚çµ„åˆï¼šemoji åç¨± + è·é›¢ + å‚™è¨»
      li.textContent = `${EMOJI[p.type]} ${name}${distText}${noteText}`;
      el.appendChild(li);
    });
  };
  build($('#summaryList'));
  build($('#m_summaryList'));
}



  function renderFilters(){
    function build(container){
      container.innerHTML='';
      TYPES.forEach(t=>{
        const chip=document.createElement('label'); chip.className='chip';
        const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=model.filters.has(t);
        const span=document.createElement('span'); span.textContent=`${EMOJI[t]} ${t}`;
        chip.append(cb,span);
        cb.addEventListener('change',()=>{
          if(cb.checked) model.filters.add(t); else model.filters.delete(t);
          save(); renderMap(container.id.startsWith('m_')); renderSummary();
        });
        container.appendChild(chip);
      });
    }
    build($('#filters')); build($('#m_filters'));
  }

function itemTemplate(p,i){
  const el = document.createElement('div');
  el.className = 'item';
  el.dataset.id = p.id;
  el.innerHTML = `
    <div class="grip" aria-label="æ‹–æ›³èª¿æ•´é †åº">â‹®â‹®</div>
    <div class="badge">${i+1}</div>
    <div class="meta">
      <div class="title">${EMOJI[p.type]} ${escapeHtml(p.name||p.input||'æœªå‘½å')}</div>
      ${p.note?`<div class="note">${escapeHtml(p.note)}</div>`:''}
    </div>
    <div class="actions">
      <button class="iconbtn" data-act="up" title="ä¸Šç§»">â†‘</button>
      <button class="iconbtn" data-act="down" title="ä¸‹ç§»">â†“</button>
      <button class="iconbtn" data-act="loc" title="å®šä½">ğŸ¯</button>
      <button class="iconbtn danger" data-act="del" title="åˆªé™¤">åˆª</button>
    </div>`;
  return el;
}

function renderList(){
  function build(container){
    // 1) é‡æ–°æ¸²æŸ“æ¸…å–®
    container.innerHTML = '';
    model.places.forEach((p,i)=>container.appendChild(itemTemplate(p,i)));

    // 2) è‹¥å·²æœ‰èˆŠçš„ Sortableï¼Œå…ˆç æ‰é¿å…å¤šå¯¦ä¾‹è¡çª
    if (container._sortable) {
      try { container._sortable.destroy(); } catch(e){}
      container._sortable = null;
    }

    // 3) å•Ÿç”¨ Sortableï¼ˆåªç”¨æŠŠæ‰‹æ‹–ã€é¿å…å½±éŸ¿æ²å‹•ï¼‰
    container._sortable = new Sortable(container, {
      handle: '.grip',
      animation: 150,
      direction: 'vertical',
      delay: 160,                 // è§¸æ§é•·æŒ‰å•Ÿå‹•ï¼ˆé¿å…å’Œæ²å‹•æ‰“æ¶ï¼‰
      delayOnTouchOnly: true,
      forceFallback: true,        // è¡Œå‹•è£ç½®æ›´ç©©
      fallbackOnBody: true,
      scroll: true,
      scrollSensitivity: 60,
      scrollSpeed: 12,
      touchStartThreshold: 4,     // æ‰‹æŒ‡å¾®ç§»ä¸ç®—æ‹–
      filter: 'button',
      preventOnFilter: false,
      chosenClass: 'sort-chosen',
      ghostClass: 'sort-ghost',
      dragClass: 'sort-drag',
      onEnd: () => {
        // 4) ä¾ DOM é †åºé‡æ’è³‡æ–™
        const ids = [...container.querySelectorAll('.item')].map(el=>el.dataset.id);
        model.places.sort((a,b)=> ids.indexOf(a.id) - ids.indexOf(b.id));
        save();

        // 5) è¼•é‡æ›´æ–°ï¼ˆé¿å…å†é‡å»º Sortableï¼‰ï¼šåªæ›´æ–°å³å´åœ°åœ–èˆ‡ summaryï¼Œå’Œå·¦å´ç·¨è™Ÿ
        renderMap(false); renderMap(true); renderSummary();
        // æ›´æ–°ç·¨è™Ÿåœ“é»
        [...container.querySelectorAll('.badge')].forEach((b,i)=> b.textContent = i+1);
      }
    });

    // 6) å…¶é¤˜æŒ‰éˆ•ã€é›™æ“Šå¸¶å›è¡¨å–®ç…§èˆŠ
    container.onclick = ev => {
      const btn = ev.target.closest('button'); if(!btn) return;
      const block = ev.target.closest('.item'); if(!block) return;
      const id  = block.dataset.id;
      const idx = model.places.findIndex(p=>p.id===id);
      const act = btn.dataset.act;

      if(act === 'del'){ if(idx>=0){ model.places.splice(idx,1); save(); renderAll(); } return; }
      if(act === 'up' && idx>0){ const [x]=model.places.splice(idx,1); model.places.splice(idx-1,0,x); save(); renderAll(); return; }
      if(act === 'down' && idx<model.places.length-1){ const [x]=model.places.splice(idx,1); model.places.splice(idx+1,0,x); save(); renderAll(); return; }
      if(act === 'loc'){
        const p=model.places[idx];
        if(p && p.lat && p.lng){ (container.id.startsWith('m_')? mapMobile: mapMain).setView([p.lat,p.lng],16,{animate:true}); }
        else { toast('å°šæœªå®šä½ï¼Œæ­£åœ¨å˜—è©¦â€¦'); p && locatePlace(p,true); }
      }
    };

    container.ondblclick = ev => {
      const block = ev.target.closest('.item'); if(!block) return;
      const id = block.dataset.id;
      const p  = model.places.find(x=>x.id===id);
      fillInputs(p, container.id.startsWith('m_'));
    };
  }

  build(document.getElementById('list'));
  build(document.getElementById('m_list'));
}






  /* ====== é€™è£¡é–‹å§‹æ˜¯é¡¯ç¤ºåç¨±çš„åŠ å¼· ====== */
  // è®€å–ç›®å‰è¼¸å…¥
  function currentInputs(isMobile){
    return {
      type:  $(isMobile?'#m_type':'#type').value,
      input: $(isMobile?'#m_input':'#input').value.trim(),
      disp:  $(isMobile?'#m_disp':'#disp').value.trim(),  // æ–°å¢
      note:  $(isMobile?'#m_note':'#note').value.trim()
    };
  }
  // æ¸…ç©ºè¡¨å–®
  function clearInputs(isMobile){
    $(isMobile?'#m_input':'#input').value = '';
    $(isMobile?'#m_disp':'#disp').value   = '';          // æ–°å¢
    $(isMobile?'#m_note':'#note').value   = '';
    $(isMobile?'#m_input':'#input').focus();
  }
  // å°‡é …ç›®å¸¶å›è¡¨å–®ï¼ˆé›™æ“Šåˆ—è¡¨ï¼‰
  function fillInputs(p,isMobile){
    $(isMobile?'#m_type':'#type').value   = p.type;
    $(isMobile?'#m_input':'#input').value = p.input || '';
    $(isMobile?'#m_disp':'#disp').value   = p.name  || p.input || ''; // æ–°å¢
    $(isMobile?'#m_note':'#note').value   = p.note  || '';
    $(isMobile?'#m_input':'#input').focus();
  }

  // æ–°å¢é …ç›®ï¼šé¡¯ç¤ºåç¨±ç”¨ disp || input
  function addPlace(isMobile){
    const {type,input,disp,note}=currentInputs(isMobile);
    if(!input){ toast('è«‹è¼¸å…¥åç¨±æˆ–åœ°å€'); return; }
    const place={ id:uid(), type, name:(disp || input), input, note, lat:null, lng:null };
    model.places.push(place); save(); renderAll(); clearInputs(isMobile); locatePlace(place);
  }

  // è‡ªå‹•åŒæ­¥ã€Œé¡¯ç¤ºåç¨±ã€ï¼šé™¤éä½ æ”¹é
  ['','m_'].forEach(prefix=>{
    const inputEl = document.getElementById(prefix+'input');
    const dispEl  = document.getElementById(prefix+'disp');
    if(!inputEl || !dispEl) return;
    dispEl.addEventListener('input', ()=> dispEl.dataset.dirty = '1'); // ä½ å‹•éå°±æ¨™è¨˜
    inputEl.addEventListener('input', ()=>{ if(!dispEl.dataset.dirty){ dispEl.value = inputEl.value; } });
  });
  /* ====== é¡¯ç¤ºåç¨±åŠ å¼·åˆ°æ­¤ ====== */

  async function locatePlace(place, notify=false){
    const res=await geocode(place.input);
    if(res){place.lat=res.lat; place.lng=res.lng; save(); renderAll();}
    else if(notify){toast('å®šä½å¤±æ•—ï¼Œæ›å€‹é—œéµå­—è©¦è©¦');}
  }
  $('#btnAdd').addEventListener('click',()=>addPlace(false));
  $('#m_btnAdd').addEventListener('click',()=>addPlace(true));
  $('#input').addEventListener('keydown',e=>{if(e.key==='Enter') addPlace(false);});
  $('#m_input').addEventListener('keydown',e=>{if(e.key==='Enter') addPlace(true);});

  $$('.tab').forEach(tab=>tab.addEventListener('click',()=>{
    $$('.tab').forEach(t=>t.classList.toggle('active',t===tab));
    const isMap=tab.dataset.tab==='map';
    $('#stackList').style.display=isMap?'none':'';
    $('#stackMap').style.display=isMap?'':'none';
    setTimeout(()=> mapMobile.invalidateSize(), 200);
  }));

  $('#routeToggle').addEventListener('change',()=>renderAll());
  $('#m_routeToggle').addEventListener('change',()=>renderAll());

  $('#homeBtn').addEventListener('click',e=>{
    if(window.history.length>1){e.preventDefault(); history.back(); setTimeout(()=>{ location.href='/' }, 300);}
  });




  // åˆ—å°ä¿®æ­£ï¼šæŠŠç›®å‰ DOM è¤‡è£½åˆ°æ–°è¦–çª—ä¸¦å¸¶ Leaflet CSS
  document.getElementById('btnPrint').addEventListener('click', ()=>{
    const isWide = window.matchMedia('(min-width:900px)').matches;
    const wrap = isWide ? document.getElementById('mapWrap') : document.querySelector('#stackMap .map-wrap');
    const clone = wrap.cloneNode(true);
    const wrapRect = wrap.getBoundingClientRect();
    clone.style.width  = wrapRect.width + 'px'; clone.style.height = 'auto';
    const srcMapEl = wrap.querySelector(isWide ? '#map' : '#m_map');
    const dstMapEl = clone.querySelector(isWide ? '#map' : '#m_map');
    const mapRect  = srcMapEl.getBoundingClientRect();
    dstMapEl.style.width = mapRect.width + 'px';
    dstMapEl.style.height= mapRect.height + 'px';
    dstMapEl.style.borderRadius='0'; dstMapEl.style.boxShadow='none'; dstMapEl.style.border='0';
    const w = window.open('', '_blank');
    w.document.write(`<!doctype html><html lang="zh-Hant"><head>
      <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
      <style>@page{size:A4;margin:10mm} html,body{height:auto} body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial,sans-serif;-webkit-print-color-adjust:exact;print-color-adjust:exact}
      .map-wrap{width:${wrapRect.width}px} .summary{margin-top:8px;border:1px dashed #e5e7eb;padding:8px} img{image-rendering:-webkit-optimize-contrast}</style>
    </head><body></body></html>`);
    w.document.close(); w.document.body.appendChild(clone);
    const waitImages = (doc)=>{
      const imgs = Array.from(doc.images || []); if (!imgs.length) return Promise.resolve();
      return Promise.allSettled(imgs.map(img => new Promise(res=>{
        if (img.complete) return res(); img.addEventListener('load', res, {once:true}); img.addEventListener('error', res, {once:true});
      })));
    };
    setTimeout(async ()=>{ try{ await waitImages(w.document); } finally{ w.focus(); w.print(); } }, 150);
  });

  function toast(msg){
    let t=$('#toast');
    if(!t){ t=document.body.appendChild(document.createElement('div')); t.id='toast';
      Object.assign(t.style,{position:'fixed',left:'50%',bottom:'16px',transform:'translateX(-50%)',background:'#111827',color:'#fff',padding:'8px 12px',borderRadius:'10px',fontWeight:'600',zIndex:2500,transition:'opacity .2s'});
    }
    t.textContent=msg; t.style.opacity='1'; setTimeout(()=> t.style.opacity='0', 1800);
  }
  function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

  function renderAll(){ renderList(); renderFilters(); renderMap(false); renderMap(true); renderSummary(); }
  renderAll();
})();
</script>
</body>
</html>
