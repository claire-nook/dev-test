<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ—…éŠè¡Œäº‹æ›†</title>

  <style>
    :root {
      --card-bg:#fff;
      --soft:#f5f5f7;
      --ink:#222;
      --muted:#666;
      --accent:#888;
      --radius:12px;
      --border:#e3e3e6;
    }

    /* åŸºæœ¬æ’ç‰ˆèˆ‡åº•è‰² */
    body {
      margin:0;
      background:#fafafa;
      color:var(--ink);
      font-family: system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans TC", sans-serif;
    }

    /* é ‚éƒ¨å›ºå®šåˆ—ï¼ˆç…§ä½ ç¾æœ‰å·¥å…·é¢¨æ ¼ï¼‰ */
    header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:1rem 1.5rem;
      background:#fff;
      box-shadow:0 2px 5px rgba(0,0,0,0.05);
      position:sticky;
      top:0;
      z-index:10;
    }
    header h2 {
      margin:0;
      font-size:1.4rem;
      letter-spacing:.5px;
    }
    header a {
      text-decoration:none;
      font-size:1rem;
      padding:.5rem 1rem;
      border-radius:6px;
      background:#eee;
      color:#333;
      box-shadow:0 1px 4px rgba(0,0,0,0.1);
    }

    .wrap {
      max-width:1080px;
      margin:0 auto;
      padding:24px 24px 40px;
    }

    h1 {
      margin:0 0 10px;
      font-size: clamp(1.4rem, 1.2rem + 1vw, 1.8rem);
    }
    .sub {
      margin:0 0 16px;
      color:var(--muted);
      font-size:.98rem;
    }

    /* ä¸Šæ–¹ï¼šæ—¥æœŸèˆ‡è¦–åœ–æ§åˆ¶åˆ— */
    .toolbar {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      background:var(--card-bg);
      padding:14px;
      border-radius:var(--radius);
      box-shadow:0 2px 10px rgba(0,0,0,.06);
      margin-bottom:14px;
    }
    .toolbar label {
      font-size:.95rem;
      color:var(--muted);
    }
    .toolbar-group {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    input[type="date"],
    input[type="text"],
    input[type="color"],
    select {
      border:1px solid var(--border);
      border-radius:8px;
      padding:6px 10px;
      font-size:.95rem;
      background:#fff;
    }
    input[type="text"] { min-width:140px; }
    .btn {
      border:none;
      border-radius:10px;
      padding:8px 14px;
      font-size:.95rem;
      cursor:pointer;
      background:#2f855a;
      color:#fff;
      white-space:nowrap;
    }
    .btn.secondary {
      background:#e0e0e0;
      color:#333;
    }
    .btn[disabled] {
      background:#bdbdbd;
      cursor:not-allowed;
    }

    /* ç¸½è¦½ï¼èªªæ˜æ¡† */
    #summary {
      background:var(--soft);
      border-left:5px solid var(--accent);
      padding:10px 14px;
      border-radius:10px;
      font-size:.95rem;
      line-height:1.6;
      box-shadow: inset 0 0 0 1px #eee;
      margin-bottom:18px;
    }

    /* ä¸‹åŠéƒ¨ï¼šå·¦å³å…©æ¬„ï¼ˆå·¦ï¼šè¨­å®šï¼Œå³ï¼šæ—¥æ›†ï¼‰ */
    .layout {
      display:grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 2fr);
      gap:18px;
      align-items:flex-start;
    }

    /* å…©ç¨®è¨­å®šå¡ç‰‡ï¼šå€é–“èˆ‡äº‹ä»¶ */
    .panel {
      background:var(--card-bg);
      padding:14px;
      border-radius:var(--radius);
      box-shadow:0 2px 10px rgba(0,0,0,.06);
    }
    .panel h3 {
      margin:0 0 8px;
      font-size:1.05rem;
    }
    .panel p {
      margin:0 0 10px;
      font-size:.9rem;
      color:var(--muted);
    }

    .field-row {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:8px;
      align-items:center;
    }
    .field-row small {
      font-size:.8rem;
      color:var(--muted);
    }

    .badge {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 8px;
      border-radius:999px;
      background:var(--soft);
      font-size:.8rem;
      color:var(--muted);
    }
    .badge-dot {
      width:10px;
      height:10px;
      border-radius:50%;
      background:var(--accent);
    }

    .list {
      margin-top:8px;
      max-height:260px;
      overflow:auto;
      border-top:1px solid #eee;
      padding-top:6px;
    }
    .chip {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      border-radius:8px;
      background:#fafafa;
      border:1px solid #eee;
      font-size:.86rem;
      margin-bottom:4px;
    }
    .chip-main {
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .chip-title {
      font-weight:600;
    }
    .chip-meta {
      color:var(--muted);
      font-size:.8rem;
    }
    .chip-color {
      width:14px;
      height:14px;
      border-radius:4px;
      border:1px solid rgba(0,0,0,.08);
    }
    .chip button {
      border:none;
      background:transparent;
      color:#c62828;
      cursor:pointer;
      font-size:.9rem;
    }

    /* æ—¥æ›†å¤–æ¡† */
    .calendar-shell {
      background:var(--card-bg);
      padding:12px;
      border-radius:var(--radius);
      box-shadow:0 2px 10px rgba(0,0,0,.06);
    }
    .calendar-header {
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      margin-bottom:4px;
    }
    .calendar-header h3 {
      margin:0;
      font-size:1.05rem;
    }
    .calendar-header span {
      font-size:.85rem;
      color:var(--muted);
    }

    /* æ—¥æ›†æ ¼ç·š */
    .weekday-row {
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:4px;
      margin-bottom:4px;
      padding:0 2px;
      font-size:.8rem;
      color:var(--muted);
    }
    .weekday-cell {
      text-align:center;
    }

    .calendar-grid {
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:4px;
    }

    .day-cell {
      min-height:80px;
      background:#fff;
      border-radius:8px;
      border:1px solid var(--border);
      padding:4px 5px 6px;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      position:relative;
      overflow:hidden;
    }

    .day-number {
      font-size:.85rem;
      font-weight:600;
    }

    .day-month-tag {
      font-size:.7rem;
      color:var(--muted);
      margin-left:4px;
    }

    /* å€é–“é¡è‰²å¸¶ï¼šæ•´æ ¼æ·¡åº•ï¼‹å·¦å´å¯¦å¿ƒæ¢ */
    .day-cell.has-range {
      background:linear-gradient(to bottom, rgba(0,0,0,0.02), rgba(0,0,0,0.02));
    }
    .range-strip {
      position:absolute;
      top:0;
      bottom:0;
      left:0;
      width:6px;
      background:var(--accent);
    }
    .range-label {
      margin-top:2px;
      font-size:.75rem;
      font-weight:600;
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
    }

    /* å–®æ—¥äº‹ä»¶å€ */
    .events {
      margin-top:auto;
      font-size:.8rem;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .event-item {
      display:flex;
      align-items:center;
      gap:4px;
      padding:1px 3px;
      border-radius:4px;
      background:rgba(0,0,0,0.03);
    }
    .event-icon {
      font-size:.9rem;
    }
    .event-text {
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
    }

    /* ä»Šå¤©æ¨™è¨˜ï¼ˆå¦‚æœæ—¥æœŸæ­£å¥½æ˜¯ä»Šå¤©ï¼‰ */
    .today-ring {
      position:absolute;
      top:3px;
      right:4px;
      width:8px;
      height:8px;
      border-radius:50%;
      border:2px solid #ff7043;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 767px) {
      .wrap {
        padding:18px 14px 28px;
      }
      header {
        padding:.8rem 1rem;
      }
      input, select, button {
        font-size:16px !important; /* iOS ä¸ç¸®å¤ªå° */
        height:40px;
      }
      .day-cell {
        min-height:72px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h2>ğŸ§³ æ—…éŠè¡Œäº‹æ›†å·¥å…·</h2>
    <a href="index.html">ğŸ§­ å›é¦–é </a>
  </header>

  <div class="wrap">
    <h1>5 é€±æ—…éŠè¡Œäº‹æ›†è¦–åœ–</h1>
    <p class="sub">è¼¸å…¥ä»»æ„æ—¥æœŸï¼Œç³»çµ±è‡ªå‹•å¾€å‰è£œåˆ°ç•¶é€±æ˜ŸæœŸä¸€ï¼Œå›ºå®šé¡¯ç¤º 5 é€±å…± 35 å¤©ã€‚ä¸ŠåŠéƒ¨è¨­åŸå¸‚ï¼é£¯åº—å€é–“ï¼Œä¸‹åŠéƒ¨æ—¥æ›†è‡ªå‹•å¹«ä½ ä¸Šè‰²èˆ‡è²¼äº‹ä»¶åœ–ç¤ºã€‚</p>

    <!-- è¦–åœ–æ—¥æœŸæ§åˆ¶åˆ— -->
    <div class="toolbar">
      <div class="toolbar-group">
        <label for="anchorDate">é¸æ“‡ä»»ä¸€æ—¥æœŸï¼š</label>
        <input id="anchorDate" type="date" />
        <button id="btnToday" class="btn secondary" type="button">è·³åˆ°ä»Šå¤©æ‰€åœ¨é€±</button>
      </div>
      <div class="toolbar-group">
        <button id="btnGenerate" class="btn" type="button">æ›´æ–° 5 é€±è¦–åœ–</button>
        <span style="font-size:.9rem; color:var(--muted);">æœƒè‡ªå‹•æŠŠä½ é¸çš„æ—¥æœŸå°é½Šæˆã€Œç•¶é€±æ˜ŸæœŸä¸€ã€ç•¶ç¬¬ä¸€æ ¼ã€‚</span>
      </div>
    </div>

    <!-- ç¸½è¦½å€ -->
    <div id="summary">å°šæœªå»ºç«‹æ—¥æ›†ã€‚è«‹å…ˆé¸ä¸€å€‹æ—¥æœŸï¼Œå†æŒ‰ã€Œæ›´æ–° 5 é€±è¦–åœ–ã€ã€‚</div>

    <div class="layout">
      <!-- å·¦å´ï¼šè¨­å®šå€ -->
      <div class="panel">
        <h3>â‘  å€é–“ï¼ˆåŸå¸‚ï¼é£¯åº—ï¼‰</h3>
        <p>é€™è£¡ç”¨ä¾†è¨­å®šã€Œä½åœ¨å“ªè£¡ã€æˆ–ã€Œå¾…åœ¨å“ªå€‹åŸå¸‚ã€ã€‚åªæœƒåœ¨å€é–“ç¬¬ä¸€å¤©é¡¯ç¤ºåç¨±ï¼Œå…¶ä»–å¤©ç”¨é¡è‰²å»¶ä¼¸ã€‚</p>

        <div class="field-row">
          <input id="rangeName" type="text" placeholder="ä¾‹å¦‚ï¼šæœ­å¹Œï½œäº¬ç‹é£¯åº—" />
          <input id="rangeColor" type="color" value="#4f8cff" />
        </div>
        <div class="field-row">
          <label>èµ·ï¼š</label>
          <input id="rangeStart" type="date" />
          <label>è¿„ï¼š</label>
          <input id="rangeEnd" type="date" />
          <button id="btnAddRange" class="btn secondary" type="button">åŠ å…¥å€é–“</button>
        </div>
        <div class="field-row">
          <small>å°æé†’ï¼šèµ·è¨–æ—¥æœŸæœƒè¢«è¦–ç‚ºã€Œå«ç•¶å¤©ã€ã€‚é¡è‰²æœƒå¥—ç”¨åœ¨æ•´æ®µæ—¥æœŸä¸Šã€‚</small>
        </div>

        <div class="badge">
          <span class="badge-dot"></span>
          <span>å€é–“åªæ”¹é¡è‰²ï¼Œä¸å‹•äº‹ä»¶è³‡æ–™ã€‚</span>
        </div>

        <div id="rangeList" class="list"></div>

        <hr style="margin:14px 0; border:none; border-top:1px dashed #ddd;" />

        <h3>â‘¡ å–®æ—¥äº‹ä»¶ï¼ˆç§»å‹•ï¼æ´»å‹•ï¼å‚™è¨»ï¼‰</h3>
        <p>åƒæ˜¯ âœˆï¸ã€ğŸš„ã€ğŸ›ã€ğŸ£ é‚£ç¨®ç•¶å¤©æœƒç™¼ç”Ÿä¸€æ¬¡çš„äº‹æƒ…ã€‚è·¨æ—¥ç¡æ©Ÿä¸Šå°±è‡ªå·±åŠ å…©å¤©ï¼Œå¾ˆè‡ªç”±ã€‚</p>

        <div class="field-row">
          <label>æ—¥æœŸï¼š</label>
          <input id="eventDate" type="date" />
        </div>
        <div class="field-row">
          <label>åœ–ç¤ºï¼š</label>
          <select id="eventIcon">
            <option value="âœˆï¸">âœˆï¸ é£›æ©Ÿ</option>
            <option value="ğŸš„">ğŸš„ æ–°å¹¹ç·šï¼é«˜éµ</option>
            <option value="ğŸš†">ğŸš† ç«è»Š</option>
            <option value="ğŸšŒ">ğŸšŒ å·´å£«</option>
            <option value="ğŸš—">ğŸš— è‡ªé§•</option>
            <option value="ğŸ›ï¸">ğŸ›ï¸ æ›é£¯åº—</option>
            <option value="ğŸ£">ğŸ£ åƒé£¯ï¼é¤å»³</option>
            <option value="ğŸ›">ğŸ› é€›è¡—</option>
            <option value="ğŸ“">ğŸ“ å…¶ä»–</option>
          </select>
          <input id="eventNote" type="text" placeholder="ä¾‹å¦‚ï¼šTPE â†’ CTS å¤œèˆª" />
          <button id="btnAddEvent" class="btn secondary" type="button">åŠ å…¥äº‹ä»¶</button>
        </div>
        <div class="field-row">
          <small>ä½ è¦è·¨æ—¥ç¡é£›æ©Ÿï¼Œå°±è‡ªå·±åŠ å…©ç­†ï¼š13 âœˆï¸ã€14 âœˆï¸ã€‚ç³»çµ±åªè² è²¬ä¹–ä¹–è²¼ä¸Šåœ–ç¤ºã€‚</small>
        </div>

        <div id="eventList" class="list"></div>
      </div>

      <!-- å³å´ï¼šæ—¥æ›†è¦–åœ– -->
      <div class="calendar-shell">
        <div class="calendar-header">
          <h3>5 é€±æ—¥æ›†è¦–åœ–</h3>
          <span id="calendarRangeLabel"></span>
        </div>

        <div class="weekday-row">
          <div class="weekday-cell">ä¸€</div>
          <div class="weekday-cell">äºŒ</div>
          <div class="weekday-cell">ä¸‰</div>
          <div class="weekday-cell">å››</div>
          <div class="weekday-cell">äº”</div>
          <div class="weekday-cell">å…­</div>
          <div class="weekday-cell">æ—¥</div>
        </div>

        <div id="calendarGrid" class="calendar-grid">
          <!-- JS å‹•æ…‹ç”¢ç”Ÿæ—¥æ›†æ ¼å­ -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== å·¥å…·å±¤ï¼šæ—¥æœŸè™•ç† =====

    /**
     * å°‡ "YYYY-MM-DD" å­—ä¸²è½‰æˆ Dateï¼ˆé–åœ¨ç•¶åœ° 00:00ï¼Œé¿å…æ™‚å€äº‚é£„ï¼‰
     */
    function parseDate(value) {
      if (!value) return null;
      // åŠ ä¸Š T00:00:00ï¼Œé¿å…è¢«ç•¶æˆ UTC
      return new Date(value + 'T00:00:00');
    }

    /**
     * å°‡ Date è½‰æˆ "YYYY-MM-DD"
     */
    function formatDateISO(date) {
      if (!date) return '';
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    /**
     * æŠŠ Date è¤‡è£½ä¸€ä»½ï¼Œä¸¦åŠ ä¸ŠæŒ‡å®šå¤©æ•¸
     */
    function addDays(date, days) {
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }

    /**
     * å–å¾— JS getDay() è½‰æˆä»¥ã€Œé€±ä¸€ç‚º 0ã€çš„ç´¢å¼•
     * JS: 0=é€±æ—¥,1=é€±ä¸€,... â†’ è½‰æˆ 0=é€±ä¸€,...,6=é€±æ—¥
     */
    function getMondayIndex(date) {
      const jsDay = date.getDay(); // 0~6
      return (jsDay + 6) % 7;
    }

    /**
     * åˆ¤æ–· date æ˜¯å¦ä»‹æ–¼ [start, end] ä¹‹é–“ï¼ˆå«é‚Šç•Œï¼‰
     */
    function isWithin(date, start, end) {
      if (!start || !end) return false;
      const t = date.getTime();
      return t >= start.getTime() && t <= end.getTime();
    }

    // ===== ç‹€æ…‹å„²å­˜ =====

    /** è¦–åœ–èµ·å§‹æ—¥æœŸï¼ˆä¸€å®šæ˜¯æ˜ŸæœŸä¸€ï¼‰ */
    let viewStartDate = null;

    /** å€é–“è³‡æ–™ï¼š{id, name, color, start, end} */
    const ranges = [];

    /** å–®æ—¥äº‹ä»¶è³‡æ–™ï¼š{id, date, icon, note} */
    const events = [];

    let idCounter = 1;
    function nextId() {
      return idCounter++;
    }

    // ===== DOM å–å¾— =====

    const anchorInput = document.getElementById('anchorDate');
    const btnToday = document.getElementById('btnToday');
    const btnGenerate = document.getElementById('btnGenerate');

    const summaryBox = document.getElementById('summary');
    const calendarGrid = document.getElementById('calendarGrid');
    const calendarRangeLabel = document.getElementById('calendarRangeLabel');

    const rangeNameInput = document.getElementById('rangeName');
    const rangeColorInput = document.getElementById('rangeColor');
    const rangeStartInput = document.getElementById('rangeStart');
    const rangeEndInput = document.getElementById('rangeEnd');
    const btnAddRange = document.getElementById('btnAddRange');
    const rangeList = document.getElementById('rangeList');

    const eventDateInput = document.getElementById('eventDate');
    const eventIconSelect = document.getElementById('eventIcon');
    const eventNoteInput = document.getElementById('eventNote');
    const btnAddEvent = document.getElementById('btnAddEvent');
    const eventList = document.getElementById('eventList');

    // ===== è¦–åœ–åˆå§‹åŒ–ï¼šé è¨­æŠ“ä»Šå¤©æ‰€åœ¨é€± =====

    (function initDefaults() {
      const today = new Date();
      const iso = formatDateISO(today);
      anchorInput.value = iso;
      eventDateInput.value = iso;
      rangeStartInput.value = iso;
      rangeEndInput.value = iso;

      setViewStartFromAnchor(today);
      renderCalendar();
      updateSummary();
    })();

    /**
     * æ ¹æ“šã€Œä»»æ„æ—¥æœŸã€è¨ˆç®—æœ¬é€±æ˜ŸæœŸä¸€ï¼Œæ›´æ–° viewStartDate
     */
    function setViewStartFromAnchor(date) {
      if (!date) return;
      const mondayOffset = getMondayIndex(date); // 0~6
      viewStartDate = addDays(date, -mondayOffset);
    }

    // ===== äº‹ä»¶ç›£è½ï¼šè¦–åœ–æ§åˆ¶ =====

    btnToday.addEventListener('click', () => {
      const today = new Date();
      anchorInput.value = formatDateISO(today);
      setViewStartFromAnchor(today);
      renderCalendar();
      updateSummary();
    });

    btnGenerate.addEventListener('click', () => {
      const d = parseDate(anchorInput.value);
      if (!d) {
        alert('è«‹å…ˆé¸æ“‡ä¸€å€‹æ—¥æœŸã€‚');
        return;
      }
      setViewStartFromAnchor(d);
      renderCalendar();
      updateSummary();
    });

    // ===== å€é–“æ“ä½œ =====

    btnAddRange.addEventListener('click', () => {
      const name = rangeNameInput.value.trim();
      const color = rangeColorInput.value || '#4f8cff';
      const start = parseDate(rangeStartInput.value);
      const end = parseDate(rangeEndInput.value);

      if (!name) {
        alert('è«‹è¼¸å…¥å€é–“åç¨±ï¼ˆåŸå¸‚æˆ–é£¯åº—ï¼‰ã€‚');
        return;
      }
      if (!start || !end) {
        alert('è«‹è¨­å®šèµ·è¨–æ—¥æœŸã€‚');
        return;
      }
      if (end < start) {
        alert('çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸã€‚');
        return;
      }

      ranges.push({
        id: nextId(),
        name,
        color,
        start,
        end
      });

      rangeNameInput.value = '';
      renderRangesList();
      renderCalendar();
      updateSummary();
    });

    function removeRange(id) {
      const idx = ranges.findIndex(r => r.id === id);
      if (idx >= 0) {
        ranges.splice(idx, 1);
        renderRangesList();
        renderCalendar();
        updateSummary();
      }
    }

    function renderRangesList() {
      rangeList.innerHTML = '';
      if (!ranges.length) {
        rangeList.innerHTML = '<div style="font-size:.85rem; color:var(--muted);">å°šæœªåŠ å…¥ä»»ä½•å€é–“ã€‚</div>';
        return;
      }

      for (const r of ranges) {
        const chip = document.createElement('div');
        chip.className = 'chip';

        const main = document.createElement('div');
        main.className = 'chip-main';

        const title = document.createElement('div');
        title.className = 'chip-title';
        title.textContent = r.name;

        const meta = document.createElement('div');
        meta.className = 'chip-meta';
        meta.textContent = `${formatDateISO(r.start)} ï½ ${formatDateISO(r.end)}`;

        main.appendChild(title);
        main.appendChild(meta);

        const colorBox = document.createElement('div');
        colorBox.className = 'chip-color';
        colorBox.style.background = r.color;

        const btnDel = document.createElement('button');
        btnDel.type = 'button';
        btnDel.textContent = 'åˆªé™¤';
        btnDel.addEventListener('click', () => removeRange(r.id));

        chip.appendChild(colorBox);
        chip.appendChild(main);
        chip.appendChild(btnDel);

        rangeList.appendChild(chip);
      }
    }

    // ===== å–®æ—¥äº‹ä»¶æ“ä½œ =====

    btnAddEvent.addEventListener('click', () => {
      const date = parseDate(eventDateInput.value);
      const icon = eventIconSelect.value || 'ğŸ“';
      const note = eventNoteInput.value.trim();

      if (!date) {
        alert('è«‹å…ˆé¸æ“‡äº‹ä»¶æ—¥æœŸã€‚');
        return;
      }

      events.push({
        id: nextId(),
        date,
        icon,
        note
      });

      eventNoteInput.value = '';
      renderEventsList();
      renderCalendar();
      updateSummary();
    });

    function removeEvent(id) {
      const idx = events.findIndex(e => e.id === id);
      if (idx >= 0) {
        events.splice(idx, 1);
        renderEventsList();
        renderCalendar();
        updateSummary();
      }
    }

    function renderEventsList() {
      eventList.innerHTML = '';
      if (!events.length) {
        eventList.innerHTML = '<div style="font-size:.85rem; color:var(--muted);">å°šæœªåŠ å…¥ä»»ä½•äº‹ä»¶ã€‚</div>';
        return;
      }

      // ä¾æ—¥æœŸæ’åºï¼Œæ–¹ä¾¿ä½ è‡ªå·±çœ‹
      const sorted = [...events].sort((a, b) => a.date - b.date);

      for (const e of sorted) {
        const chip = document.createElement('div');
        chip.className = 'chip';

        const main = document.createElement('div');
        main.className = 'chip-main';

        const title = document.createElement('div');
        title.className = 'chip-title';
        title.textContent = `${e.icon} ${e.note || '(ç„¡å‚™è¨»)'}`;

        const meta = document.createElement('div');
        meta.className = 'chip-meta';
        meta.textContent = formatDateISO(e.date);

        main.appendChild(title);
        main.appendChild(meta);

        const btnDel = document.createElement('button');
        btnDel.type = 'button';
        btnDel.textContent = 'åˆªé™¤';
        btnDel.addEventListener('click', () => removeEvent(e.id));

        chip.appendChild(main);
        chip.appendChild(btnDel);

        eventList.appendChild(chip);
      }
    }

    // ===== æ—¥æ›†æ¸²æŸ“ =====

    function renderCalendar() {
      calendarGrid.innerHTML = '';

      if (!viewStartDate) return;

      const days = [];
      for (let i = 0; i < 35; i++) {
        days.push(addDays(viewStartDate, i));
      }

      // æ—¥æ›†ç¯„åœæ–‡å­—ï¼ˆå·¦ä¸Šå°å­—ï¼‰
      const first = days[0];
      const last = days[days.length - 1];
      const label = `${formatDateISO(first)} ï½ ${formatDateISO(last)}`;
      calendarRangeLabel.textContent = label;

      const todayISO = formatDateISO(new Date());

      for (const day of days) {
        const cell = document.createElement('div');
        cell.className = 'day-cell';

        const dateISO = formatDateISO(day);
        const dayNum = day.getDate();
        const month = day.getMonth() + 1;

        // æ—¥æœŸï¼‹æœˆæ¨™ç±¤ï¼ˆæ¯æœˆ 1 è™Ÿé¡¯ç¤ºï¼‰
        const topRow = document.createElement('div');
        topRow.style.display = 'flex';
        topRow.style.alignItems = 'baseline';
        const numSpan = document.createElement('span');
        numSpan.className = 'day-number';
        numSpan.textContent = dayNum;

        topRow.appendChild(numSpan);

        if (dayNum === 1) {
          const monthTag = document.createElement('span');
          monthTag.className = 'day-month-tag';
          monthTag.textContent = `${month} æœˆ`;
          topRow.appendChild(monthTag);
        }

        cell.appendChild(topRow);

        // ä»Šå¤©çš„å°åœˆåœˆ
        if (dateISO === todayISO) {
          const ring = document.createElement('div');
          ring.className = 'today-ring';
          cell.appendChild(ring);
        }

        // æ‰¾å‡ºé€™å¤©æœ‰å“ªäº›å€é–“å‘½ä¸­
        const hitRanges = ranges.filter(r => isWithin(day, r.start, r.end));

        if (hitRanges.length) {
          cell.classList.add('has-range');

          // ç›®å‰åªå–ç¬¬ä¸€å€‹å€é–“çš„é¡è‰²åšåº•è‰²èˆ‡å´é‚Šæ¢ï¼ˆä¸€èˆ¬æƒ…æ³ä¹Ÿåªæœƒæœ‰ä¸€å€‹ï¼‰
          const primary = hitRanges[0];

          const strip = document.createElement('div');
          strip.className = 'range-strip';
          strip.style.background = primary.color;
          cell.appendChild(strip);

          // å¦‚æœæ˜¯é€™å€‹å€é–“çš„ç¬¬ä¸€å¤©ï¼Œå°±é¡¯ç¤ºåç¨±
          for (const r of hitRanges) {
            if (formatDateISO(day) === formatDateISO(r.start)) {
              const labelDiv = document.createElement('div');
              labelDiv.className = 'range-label';
              labelDiv.textContent = r.name;
              labelDiv.style.color = r.color;
              cell.appendChild(labelDiv);
            }
          }
        }

        // å–®æ—¥äº‹ä»¶
        const dayEvents = events.filter(e => formatDateISO(e.date) === dateISO);
        if (dayEvents.length) {
          const eventsBox = document.createElement('div');
          eventsBox.className = 'events';

          const sorted = dayEvents.sort((a, b) => a.id - b.id);
          for (const e of sorted) {
            const item = document.createElement('div');
            item.className = 'event-item';

            const iconSpan = document.createElement('span');
            iconSpan.className = 'event-icon';
            iconSpan.textContent = e.icon;

            const textSpan = document.createElement('span');
            textSpan.className = 'event-text';
            textSpan.textContent = e.note || '';

            item.appendChild(iconSpan);
            if (e.note) item.appendChild(textSpan);

            eventsBox.appendChild(item);
          }

          cell.appendChild(eventsBox);
        }

        calendarGrid.appendChild(cell);
      }
    }

    // ===== ç¸½è¦½è³‡è¨Š =====

    function updateSummary() {
      if (!viewStartDate) {
        summaryBox.textContent = 'å°šæœªå»ºç«‹æ—¥æ›†ã€‚è«‹å…ˆé¸ä¸€å€‹æ—¥æœŸã€‚';
        return;
      }
      const first = viewStartDate;
      const last = addDays(viewStartDate, 34);

      const rangeCount = ranges.length;
      const eventCount = events.length;

      summaryBox.innerHTML = `
        ğŸ“… ç›®å‰è¦–åœ–ç¯„åœï¼š<strong>${formatDateISO(first)}</strong> ï½ <strong>${formatDateISO(last)}</strong><br/>
        ğŸ¨ å€é–“ï¼ˆåŸå¸‚ï¼é£¯åº—ï¼‰å…±ï¼š<strong>${rangeCount}</strong> ç­†<br/>
        ğŸ“Œ å–®æ—¥äº‹ä»¶å…±ï¼š<strong>${eventCount}</strong> ç­†<br/>
        âœï¸ å€é–“åªæœƒåœ¨èµ·å§‹æ—¥é¡¯ç¤ºåç¨±ï¼Œå…¶é¤˜é é¡è‰²è¾¨è­˜ã€‚äº‹ä»¶æ¡ã€Œå–®æ—¥ä¸€ç­†ã€é‚è¼¯ï¼Œè·¨æ—¥ç§»å‹•å°±è‡ªå·±åŠ å…©ç­†ã€‚
      `;
    }
  </script>
</body>
</html>