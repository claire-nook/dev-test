<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Writer + Images (合併版)</title>

<!-- ===== 外觀：簡潔到不會礙事 ===== -->
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280; --line:#e5e7eb; --brand:#4f46e5;
    --radius:12px; --shadow:0 6px 18px rgba(17,24,39,.06);
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{ margin:0; background:var(--bg); color:var(--text); font:16px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif; }

  header{
    position:sticky; top:0; z-index:10;
    display:flex; align-items:center; gap:8px; justify-content:space-between;
    padding:10px 12px; background:#fff; border-bottom:1px solid var(--line);
  }
  .h-left{ display:flex; align-items:center; gap:8px }
  .title{ font-weight:800; letter-spacing:.2px }
  .btn{
    appearance:none; border:1px solid var(--line); background:#fff; color:#111; padding:.5rem .8rem;
    border-radius:10px; cursor:pointer; font-weight:600; box-shadow:0 1px 4px rgba(0,0,0,.05);
  }
  .btn.primary{ background:var(--brand); color:#fff; border-color:transparent }
  .btn.ghost{ background:#fff }
  .btn:disabled{ opacity:.5; cursor:not-allowed }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 3px 10px rgba(0,0,0,.08) }
.btn.ghost {
  background:#fff;
  text-decoration: none; /* ← 這行拿掉底線 */
}
.btn.ghost,
.btn.ghost:hover {
  text-decoration: none;
}
  .wrap{ display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; padding:12px; height:calc(100vh - 64px); }
  @media (max-width: 980px){ .wrap{ grid-template-columns:1fr; height:auto; } }

  .card{
    background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
    box-shadow:var(--shadow); display:flex; flex-direction:column; min-height:0;
  }
  .card h3{
    margin:0; padding:10px 12px; border-bottom:1px solid var(--line);
    font-size:14px; color:var(--muted); display:flex; align-items:center; gap:8px; flex-wrap:wrap;
  }
  .card .body{ padding:12px; min-height:0; overflow:auto; }

  /* 編輯器 */
  textarea#md{
    width:100%; height:60vh; border:1px solid var(--line); border-radius:10px; padding:12px;
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:14px; resize:vertical;
  }
  @media (max-width:980px){ textarea#md{ height:40vh } }

  /* 圖片區 */
  .toolbar{ display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px }
  .grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px }
  @media (max-width:600px){ .grid{ grid-template-columns: repeat(2, 1fr) } }
  .thumb{
    position:relative; border:1px solid var(--line); border-radius:10px; overflow:hidden; background:#fff;
  }
  .thumb img{ width:100%; height:140px; object-fit:cover; display:block }
  .thumb .meta{
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    padding:6px; background:#fafafa; border-top:1px solid var(--line); font-size:12px;
  }
  .thumb .name{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#374151 }
  .thumb .chk{ display:inline-flex; align-items:center; gap:6px }
  .thumb .x{
    position:absolute; top:6px; right:6px; width:28px; height:28px; display:grid; place-items:center;
    background:rgba(255,255,255,.85); border:1px solid #fecaca; color:#b91c1c; border-radius:8px; cursor:pointer;
  }

  /* 小提示 */
  .tip{ font-size:13px; color:var(--muted) }

  /* Toast */
  .toast{
    position:fixed; bottom:16px; right:16px; background:#111827; color:#fff;
    padding:10px 14px; border-radius:10px; font-size:13px; opacity:0; transform:translateY(10px);
    transition:opacity .2s, transform .2s; pointer-events:none; z-index:99;
  }
  .toast.show{ opacity:1; transform:translateY(0) }

/* 左上角大顆勾選框（更好戳） */
.thumb .chk {
  position: absolute;
  left: 8px; top: 8px;
  z-index: 2;
  background: rgba(255,255,255,.95);
  border: 1px solid #d1d5db;
  border-radius: 10px;
  padding: 4px;
}
.thumb .chk input[type="checkbox"]{
  width: 22px; height: 22px;
  accent-color: #2563eb;
}

/* 被選中時，整張卡片有高對比外框與淡藍遮罩 */
.thumb.selected { box-shadow: 0 0 0 3px #2563eb inset; }
.thumb.selected::after{
  content:"";
  position:absolute; inset:0;
  background: rgba(37,99,235,.08);
  pointer-events:none;
}

/* 固定圖片工具列在圖片區塊上方 */
.card .body {
  display: flex;
  flex-direction: column;
}

.toolbar.sticky {
  position: sticky;
  top: 0;               /* 貼齊卡片內的最上方 */
  z-index: 5;           /* 蓋在縮圖之上 */
  background: #fff;     /* 背景要白，不然會跟下方縮圖疊色 */
  padding: 8px 0;       /* 確保不擠到邊 */
  border-bottom: 1px solid var(--line); /* 跟縮圖區隔 */
}

/* 只編輯：顯示編輯卡 + 圖片卡，隱藏預覽卡 */
body[data-mode="edit"] #previewCard { display:none; }
body[data-mode="edit"] #imagesCard  { display:block; }

/* 只預覽：整頁只剩預覽卡，吃滿高度 */
body[data-mode="preview"] .wrap { grid-template-columns:1fr; }
body[data-mode="preview"] section.card,
body[data-mode="preview"] aside.card { display:none; }
body[data-mode="preview"] #previewCard { display:flex; }
body[data-mode="preview"] #previewCard .body iframe {
  height: calc(100vh - 64px - 42px); /* 扣掉 header 和卡片標題 */
}

[hidden] { display: none !important; }
</style>
</head>
<body data-mode="edit">

<header>
  <div class="h-left">
    <div class="title">✍️ Writer + 🖼 Images</div>
    <!-- 編輯器功能列：開啟 / 儲存 / 複製 / 清空 / 插入圖片語法 -->
    <button class="btn" id="openMdBtn">開啟</button>
    <button class="btn" id="saveMdBtn">儲存</button>
    <button class="btn" id="copyMdBtn">複製</button>
    <button class="btn" id="clearMdBtn">清空</button>
    <button class="btn primary" id="insertFromImageBtn" title="請先在右側產生並複製勾選圖片的 MD">插入圖片語法</button>
    
    <!-- 新：兩顆模式鈕 -->
    <button class="btn" id="modeEditBtn">只編輯</button>
    <button class="btn primary" id="modePreviewBtn">只預覽</button>
    
    <input id="openMdFile" type="file" accept=".md,.markdown,text/markdown,text/plain" hidden />
  </div>
  <a class="btn ghost" href="index.html">🏠 回首頁</a>
</header>

<main class="wrap">
  <!-- 左：編輯器 -->
  <section class="card">
    <h3>Markdown 編輯</h3>
    <div class="body">
      <textarea id="md" placeholder="在這裡寫文章。插入圖片語法的來源：先到右邊圖片區『產生 MD 語法』並『複製勾選圖片MD』，再按上方『插入圖片語法』。"></textarea>
      <p class="tip" style="margin-top:8px">儲存與下載會優先使用系統存檔對話框（File System Access）。不支援時改用瀏覽器下載。</p>
    </div>
  </section>

  <!-- 右：圖片工具 -->
  <aside class="card" id="imagesCard">
    <h3>圖片區（壓縮、命名、勾選、ZIP）</h3>
    <div class="body">
      <div class="toolbar sticky">
        <button class="btn" id="pickBtn">選擇照片</button>
        <input id="file" type="file" accept="image/*" multiple hidden />
        <button class="btn" id="genMdBtn">產生MD語法（鎖檔名）</button>
        <button class="btn ghost" id="clearBatchBtn">清空此批</button>
      </div>
      <div class="toolbar sticky">
        <button class="btn ghost" id="checkAllBtn">全部勾選</button>
        <button class="btn ghost" id="uncheckAllBtn">取消勾選</button>
        <button class="btn" id="copySelectedBtn">複製勾選圖片MD</button>
        <button class="btn" id="saveZipBtn">下載ZIP圖片</button>
      </div>
      <div class="toolbar">
        <label class="tip">圖片最長邊（px）
          <input id="maxDim" type="number" value="1200" min="640" step="80" style="width:120px; margin-left:6px; padding:6px; border:1px solid var(--line); border-radius:8px" />
        </label>
        <span class="tip">ZIP 目錄固定為 <code>images/</code>，圖檔格式 <code>{prefix}-nnn.jpg</code>，去 EXIF。</span>
      </div>

      <div id="grid" class="grid"></div>
    </div>
  </aside>
  
  <!-- 新：內嵌預覽卡片 -->
  <section class="card" id="previewCard">
    <h3>預覽</h3>
    <div class="body" style="padding:0">
      <iframe id="previewFrame" style="width:100%;height:60vh;border:0"></iframe>
    </div>
  </section>
  
</main>

<div id="toast" class="toast"></div>

<!-- 依賴套件（CDN） -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
/* ===========================================================
   合併版核心邏輯
   - 編輯器：開啟 / 儲存 / 複製 / 清空 / 插入圖片語法
   - 圖片區：選圖(壓縮去EXIF) / 產生MD(鎖檔名) / 勾選管理 / ZIP / 清空
   =========================================================== */

/* ---------- 小工具：提示 ---------- */
const toastEl = document.getElementById('toast');
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'), 1600);
}

/* ---------- 編輯器 DOM ---------- */
const mdEl = document.getElementById('md');
const openMdBtn = document.getElementById('openMdBtn');
const openMdFile = document.getElementById('openMdFile');
const saveMdBtn = document.getElementById('saveMdBtn');
const copyMdBtn = document.getElementById('copyMdBtn');
const clearMdBtn = document.getElementById('clearMdBtn');
const insertFromImageBtn = document.getElementById('insertFromImageBtn');

/* ---------- 圖片區 DOM ---------- */
const pickBtn = document.getElementById('pickBtn');
const fileEl = document.getElementById('file');
const genMdBtn = document.getElementById('genMdBtn');
const clearBatchBtn = document.getElementById('clearBatchBtn');
const gridEl = document.getElementById('grid');
const checkAllBtn = document.getElementById('checkAllBtn');
const uncheckAllBtn = document.getElementById('uncheckAllBtn');
const copySelectedBtn = document.getElementById('copySelectedBtn');
const saveZipBtn = document.getElementById('saveZipBtn');
const maxDimEl = document.getElementById('maxDim');

/* ---------- 狀態 ---------- */
let items = []; // { file, blob, url, w, h, _finalName?, _selected }
let namePrefix = null; // 一批唯一前綴
let mdCache = '';      // 使用者剛剛在圖片區「複製勾選圖片MD」時，同步快取到這裡，供「插入圖片語法」使用

function makePrefix(){
  const t = Date.now().toString(36);
  const r = Math.floor(Math.random()*1e6).toString(36);
  return (t.slice(-3) + r).slice(0,5);
}
function pad3(n){ return String(n).padStart(3,'0'); }

/* ===========================================================
   編輯器功能
   =========================================================== */

/* 開啟（iCloud 可用系統對話框） */
openMdBtn.addEventListener('click', ()=> openMdFile.click());
openMdFile.addEventListener('change', async e=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  mdEl.value = txt;
  toast('已載入 Markdown');
});

/* 儲存（優先使用 File System Access，否則使用 FileSaver 備援） */
saveMdBtn.addEventListener('click', async ()=>{
  try{
    const blob = new Blob([mdEl.value], {type:'text/markdown;charset=utf-8'});
    if(window.showSaveFilePicker){
      const handle = await showSaveFilePicker({
        suggestedName: 'note.md',
        types: [{ description: 'Markdown', accept: { 'text/markdown':['.md','.markdown'], 'text/plain':['.md'] } }]
      });
      const writable = await handle.createWritable();
      await writable.write(blob);
      await writable.close();
    }else{
      saveAs(blob, 'note.md');
    }
    toast('MD 已儲存');
  }catch(e){
    console.error(e);
    toast('儲存失敗或取消');
  }
});

/* 複製整份 MD */
copyMdBtn.addEventListener('click', async ()=>{
  try{
    await navigator.clipboard.writeText(mdEl.value);
    toast('已複製 MD');
  }catch{
    toast('無法存取剪貼簿');
  }
});

/* 清空 */
clearMdBtn.addEventListener('click', ()=>{
  mdEl.value = '';
  toast('已清空編輯器');
});

/* 從圖片區插入（用快取，不強制要剪貼簿權限） */
insertFromImageBtn.addEventListener('click', async ()=>{
  let text = mdCache;
  if(!text){
    // 次選：嘗試從剪貼簿讀
    try{ text = await navigator.clipboard.readText(); }catch(_){}
  }
  if(!text){
    toast('沒有可插入的圖片 Markdown。請先在右側「複製勾選圖片MD」。');
    return;
  }
  insertAtCursor(mdEl, text.endsWith('\n') ? text : text + '\n');
  toast('已插入圖片 Markdown');
});
function insertAtCursor(textarea, text){
  const start = textarea.selectionStart ?? textarea.value.length;
  const end   = textarea.selectionEnd ?? textarea.value.length;
  const before = textarea.value.slice(0, start);
  const after  = textarea.value.slice(end);
  textarea.value = before + text + after;
  const pos = (before + text).length;
  textarea.setSelectionRange(pos, pos);
  textarea.focus();
}

/* ===========================================================
   圖片區：選圖→壓縮去EXIF→顯示縮圖
   =========================================================== */

pickBtn.addEventListener('click', ()=> fileEl.click());
fileEl.addEventListener('change', async e=>{
  const files = Array.from(e.target.files || []).filter(f=>f.type.startsWith('image/'));
  if(!files.length) return;
  const maxDim = Math.max(640, Number(maxDimEl.value || 1200));
  for(const f of files){
    const it = await readAndCompress(f, maxDim);
    items.push(it);
    addThumb(it);
  }
  toast(`已載入 ${files.length} 張圖片`);
});

/* 讀檔 + re-encode 去 EXIF */
function readFileAsDataURL(file){
  return new Promise((res, rej)=>{
    const fr = new FileReader();
    fr.onload = ()=> res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}
function loadImage(src){
  return new Promise((res, rej)=>{
    const img = new Image();
    img.onload = ()=> res(img);
    img.onerror = rej;
    img.src = src;
  });
}
async function readAndCompress(file, maxDim){
  const dataURL = await readFileAsDataURL(file);
  const img = await loadImage(dataURL);
  let w = img.width, h = img.height;
  const r = w / h;
  if(w > h && w > maxDim){ w = maxDim; h = Math.round(maxDim / r); }
  else if(h >= w && h > maxDim){ h = maxDim; w = Math.round(maxDim * r); }
  const c = document.createElement('canvas');
  c.width = w; c.height = h;
  const ctx = c.getContext('2d');
  ctx.drawImage(img, 0, 0, w, h);
  const blob = await new Promise(res => c.toBlob(res, 'image/jpeg', 0.7));
  const url = URL.createObjectURL(blob);
  return { file, blob, url, w, h, _selected:false };
}

function bindSelectable(div, it){
  // 讓整張縮圖能切換勾選，同時避免滑動誤觸
  const THRESHOLD_PX = 8;     // 位移門檻
  const THRESHOLD_MS = 250;   // 時長門檻
  let startX=0, startY=0, startT=0, moved=false, pointer=-1;

  const onDown = (e) => {
    if (pointer !== -1) return; // 已有指標
    const p = e.touches ? e.touches[0] : e;
    if (!p) return;
    pointer = p.identifier ?? p.pointerId ?? 0;
    startX = p.clientX; startY = p.clientY; startT = Date.now();
    moved  = false;
  };

  const onMove = (e) => {
    if (pointer === -1) return;
    const p = e.touches ? e.touches[0] : e;
    if (!p) return;
    const dx = p.clientX - startX, dy = p.clientY - startY;
    if (dx*dx + dy*dy > THRESHOLD_PX*THRESHOLD_PX) moved = true;
  };

  const onUp = (e) => {
    // 重置指標
    pointer = -1;
    const dur = Date.now() - startT;

    // 只在「短且沒移動」時當作點擊
    const isTap = !moved && dur < THRESHOLD_MS;
    if (!isTap) return;

    // 切換勾選狀態
    it._selected = !it._selected;
    if (it._chkEl) it._chkEl.checked = it._selected;
    div.classList.toggle('selected', it._selected);
  };

  // 綁定 Pointer/Touch/Mouse（被動監聽避免卡捲動）
  div.addEventListener('pointerdown', onDown, { passive: true });
  div.addEventListener('pointermove', onMove, { passive: true });
  div.addEventListener('pointerup',   onUp,   { passive: true });
  div.addEventListener('pointercancel', ()=> { pointer = -1; });

  // 鍵盤可用性（Tab 到縮圖按空白/Enter 也能切換）
  div.tabIndex = 0;
  div.setAttribute('role', 'checkbox');
  div.setAttribute('aria-checked', 'false');
  div.addEventListener('keydown', (e)=>{
    if (e.key === ' ' || e.key === 'Enter'){
      e.preventDefault();
      it._selected = !it._selected;
      if (it._chkEl) it._chkEl.checked = it._selected;
      div.classList.toggle('selected', it._selected);
      div.setAttribute('aria-checked', it._selected ? 'true' : 'false');
    }
  });
}


/* 縮圖元件（刪除在右上角 / 勾選分開） */
/* 縮圖元件（刪除在右上角 / 勾選分開 / 整張可點選） */
function addThumb(it){
  const div = document.createElement('div');
  div.className = 'thumb';

  // 圖片
  const img = document.createElement('img');
  img.src = it.url;

  // 右上角 ❌ 刪除
  const close = document.createElement('button');
  close.className = 'x';
  close.type = 'button';
  close.textContent = '✕';
  close.title = '刪除此張';
  close.addEventListener('click', (e)=>{
    e.stopPropagation();               // 避免同時觸發點擊切換
    const i = items.indexOf(it);
    if (i >= 0) items.splice(i, 1);
    URL.revokeObjectURL(it.url);
    div.remove();
  });

  // 左上角勾選框
  const chkWrap = document.createElement('label');
  chkWrap.className = 'chk';
  const chk = document.createElement('input');
  chk.type = 'checkbox';
  chk.addEventListener('change', ()=>{
    it._selected = chk.checked;
    div.classList.toggle('selected', it._selected);
    div.setAttribute('aria-checked', it._selected ? 'true' : 'false');
  });
  chkWrap.append(chk);

  // 下方檔名列
  const meta = document.createElement('div');
  meta.className = 'meta';
  const name = document.createElement('span');
  name.className = 'name';
  name.textContent = it._finalName || '(未命名)';
  meta.append(name);

  // 組裝
  div.append(img, close, chkWrap, meta);
  gridEl.append(div);

  // 狀態引用
  it._el = div;
  it._chkEl = chk;
  it._nameEl = name;

  // 讓整張縮圖可點選，但滑動不誤觸
  bindSelectable(div, it);
}



/* 一鍵清空此批 */
clearBatchBtn.addEventListener('click', ()=>{
  items.forEach(it=> URL.revokeObjectURL(it.url));
  items = [];
  gridEl.innerHTML = '';
  namePrefix = null;
  mdCache = '';
  toast('已清空此批圖片');
});

/* 產生 MD 語法：此刻固定檔名，不再因順序變動（這版沒有拖曳） */
genMdBtn.addEventListener('click', ()=>{
  if(!items.length){ toast('沒有圖片可以命名'); return; }
  if(!namePrefix) namePrefix = makePrefix();
  let n = 1;
  for(const it of items){
    if(!it._finalName){
      it._finalName = `${namePrefix}-${pad3(n++)}.jpg`;
      it._path = `images/${it._finalName}`;
      if(it._nameEl) it._nameEl.textContent = it._finalName;
    }
  }
  toast('檔名已固定，可勾選並複製 MD');
});

/* 勾選管理 */
checkAllBtn.addEventListener('click', ()=>{
  items.forEach(it=>{ it._selected = true; it._chkEl && (it._chkEl.checked = true); });
});
uncheckAllBtn.addEventListener('click', ()=>{
  items.forEach(it=>{ it._selected = false; it._chkEl && (it._chkEl.checked = false); });
});

/* 複製勾選圖片的 MD（並快取，供左側「插入圖片語法」用） */
copySelectedBtn.addEventListener('click', async ()=>{
  const hadName = items.every(it=> !!it._finalName);
  if(!hadName){ toast('請先按「產生MD語法」鎖定檔名'); return; }
  const picked = items.filter(it=> it._selected);
  if(!picked.length){ toast('請先勾選要插入的圖片'); return; }

  // 逐張獨立行，中間空一行，觸發你的自動圖牆規則
  const lines = [];
  for(const it of picked){
    lines.push(`![](${it._path})`, '');
  }
  const out = lines.join('\n');

  try{
    await navigator.clipboard.writeText(out);
    mdCache = out;
    toast('已複製勾選圖片的 Markdown');
  }catch{
    mdCache = out; // 就算沒有權限，還是保留在快取供「插入圖片語法」
    toast('已準備 MD（剪貼簿權限被擋，請用「插入圖片語法」貼入）');
  }
});

/* 下載 ZIP（images/ 裡面塞固定檔名的 blob） */
saveZipBtn.addEventListener('click', async ()=>{
  const named = items.filter(it=> it._finalName);
  if(!named.length){ toast('請先「產生MD語法」固定檔名'); return; }
  const zip = new JSZip();
  const folder = zip.folder('images');
  for(const it of named){
    const arrbuf = await it.blob.arrayBuffer();
    folder.file(it._finalName, arrbuf);
  }
  const blob = await zip.generateAsync({type:'blob'});
  try{
    if(window.showSaveFilePicker){
      const handle = await showSaveFilePicker({
        suggestedName: 'images.zip',
        types: [{ description:'ZIP 檔', accept:{ 'application/zip':['.zip'] } }]
      });
      const w = await handle.createWritable();
      await w.write(blob); await w.close();
    }else{
      saveAs(blob, 'images.zip');
    }
    toast('ZIP 已下載/儲存');
  }catch(e){
    console.error(e);
    toast('已取消或失敗');
  }
});
</script>



<script>
/* ===== Markdown 解析：有 CDN 就用 marked，沒載到就用 fallback ===== */
function escapeHtml(str){return String(str).replace(/[&<>"]/g,s=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[s]));}
function mdFallback(md){
  md = md.replace(/```([\s\S]*?)```/g,(_,c)=>"<pre><code>"+escapeHtml(c)+"</code></pre>");
  md = md.replace(/^###\s+(.*)$/gm,"<h3>$1</h3>").replace(/^##\s+(.*)$/gm,"<h2>$1</h2>").replace(/^#\s+(.*)$/gm,"<h1>$1</h1>");
  md = md.replace(/!\[([^\]]*)\]\(([^)]+)\)/g,'<p><img alt="$1" src="$2"></p>');
  md = md.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
  md = md.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>").replace(/\*([^*]+)\*/g,"<em>$1</em>").replace(/`([^`]+)`/g,"<code>$1</code>");
  md = md.replace(/(?:^|\n)(\|.*\|)\n(\|[\-:\s\|]+\|)\n((?:\|.*\|\n?)*)/g,function(_,h,sep,body){
    function row(r){return r.trim().slice(1,-1).split("|").map(s=>s.trim());}
    const head=row(h).map(x=>"<th>"+escapeHtml(x)+"</th>").join("");
    const bodyHtml=body.trim().split(/\n/).filter(Boolean).map(r=>"<tr>"+row(r).map(c=>"<td>"+escapeHtml(c)+"</td>").join("")+"</tr>").join("");
    return "\n<table><thead><tr>"+head+"</tr></thead><tbody>"+bodyHtml+"</tbody></table>\n";
  });
  md = md.replace(/(^|\n)([^<\n][^\n]*)/g,(m,br,line)=>{
    if(/^\s*$/.test(line)) return br+line;
    if(/^\s*<(h\d|pre|table|blockquote|ul|ol|img)/i.test(line)) return br+line;
    return br+"<p>"+line.trim()+"</p>";
  });
  return md;
}
function renderMarkdown(md){ return (window.marked && typeof marked.parse==="function") ? marked.parse(md) : mdFallback(md); }

/* ===== Obsidian callout 轉漂亮盒 ===== */
function preprocessCallouts(md){
  const lines=String(md).split(/\r?\n/), out=[]; let i=0;
  const titleMap={NOTE:"Note",TIP:"Tip",WARNING:"Warning",INFO:"Info"};
  while(i<lines.length){
    // 乾淨可用：支援 > [!NOTE] 這類 Obsidian callout
    const m = lines[i].match(/^\s*>\s*\[!(NOTE|TIP|WARNING|INFO)\]\s*(.*)$/i);
    if(m){
      const kind=m[1].toUpperCase(), title=(m[2]||"").trim()||titleMap[kind];
      const body=[]; i++;
      while(i<lines.length){
        const l=lines[i];
        if(/^\s*>/.test(l)){ body.push(l.replace(/^\s*>\s?/, "")); i++; }
        else if(/^\s*$/.test(l)){ body.push(""); i++; }
        else break;
      }
      out.push(`<blockquote class="callout"><div class="callout-head"><strong>${title}</strong></div><div class="callout-body">${renderMarkdown(body.join("\n"))}</div></blockquote>`);
      continue;
    }
    out.push(lines[i]); i++;
  }
  return out.join("\n");
}

/* ===== 圖片牆：把連續「只含圖片」的段落合成 .gallery-block ===== */
function isImgOnlyP(p){
  if(!(p && p.nodeType===1 && p.tagName==="P")) return false;
  const kids=[...p.childNodes]; if(!kids.length) return false;
  return kids.every(n => (n.nodeType===1 && n.tagName==="IMG") || (n.nodeType===3 && !String(n.nodeValue).trim()));
}
function wrapConsecutiveImages(root){
  const nodes=[...root.childNodes]; let run=[];
  function flush(){
    if(!run.length) return;
    const gallery=document.createElement("div"); gallery.className="gallery-block";
    const head=document.createElement("div"); head.className="gallery-head"; head.textContent="圖片";
    const grid=document.createElement("div"); grid.className="gallery-grid";
    gallery.append(head,grid);
    run.forEach(p=>{
      p.querySelectorAll("img").forEach(img=>{
        const item=document.createElement("div"); item.className="gallery-item";
        const a=document.createElement("a"); a.className="gallery-link"; a.href=img.getAttribute("src")||"#"; a.target="_blank";
        const thumb=img.cloneNode(true); thumb.classList.add("thumb"); a.appendChild(thumb);
        item.appendChild(a);
        if(img.alt){ const cap=document.createElement("div"); cap.className="caption"; cap.textContent=img.alt; item.appendChild(cap); }
        grid.appendChild(item);
      });
    });
    root.insertBefore(gallery, run[0]); run.forEach(n=>root.removeChild(n)); run=[];
  }
  for(const n of nodes){ if(isImgOnlyP(n)) run.push(n); else flush(); }
  flush();
}


/* ===== 在新分頁產出完整 HTML（含 marked、Mermaid、圖片牆） ===== */
function buildPreviewHTML(md){
  // 把原始 MD 變成可安全內嵌的字串
  const RAW = JSON.stringify(String(md));

  const css = `
:root{ --bg:#f6f7fb; --panel:#fff; --line:#e5e7eb; --text:#111827; --muted:#6b7280; --thumb-w:320px; --thumb-h:200px; }
body{ font-family:ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif; margin:0; padding:24px; background:var(--bg); color:var(--text) }
h1{font-size:1.75rem;margin:.2rem 0 1rem} h2{font-size:1.35rem;margin:1.25rem 0 .75rem} h3{font-size:1.1rem;margin:1rem 0 .5rem}
p{margin:.5rem 0} a{color:#2563eb;text-decoration:none} a:hover{text-decoration:underline}
code{background:#f3f4f6;padding:0 .35rem;border-radius:4px} pre{background:#f3f4f6;padding:12px;border:1px solid var(--line);border-radius:8px;overflow:auto}
table{width:100%;border-collapse:collapse;margin:1rem 0;font-size:.95rem} th,td{border:1px solid var(--line);padding:.6rem .75rem;text-align:left} thead th{background:#e0f2fe}
blockquote{position:relative;margin:1rem 0;padding:12px 16px 12px 18px;border-left:4px solid #d1d5db;background:#f9fafb;border-radius:8px}
blockquote::before{content:"“";position:absolute;top:-6px;left:8px;font-size:40px;color:rgba(17,24,39,.12)}
.callout{padding:0;border-left:4px solid #d1d5db;background:#f9fafb;border-radius:8px;margin:1rem 0}
.callout-head{display:flex;align-items:center;gap:8px;padding:10px 12px;font-weight:700;border-bottom:1px solid #d1d5db}
.callout-body{padding:12px 14px;background:#fff}
.gallery-block{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff;margin:1rem 0}
.gallery-head{font-size:13px;color:var(--muted);font-weight:600;display:flex;align-items:center;gap:6px;margin-bottom:10px}
.gallery-head::before{content:"🖼️"}
.gallery-grid{display:grid;grid-template-columns:repeat(3,var(--thumb-w));gap:12px;justify-content:start}
.gallery-item{width:var(--thumb-w);height:var(--thumb-h);border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#fff}
.gallery-link{display:block;width:100%;height:100%}
.gallery-item img.thumb{width:100%;height:100%;object-fit:cover;display:block}
@media(max-width:767px){ :root{--thumb-w:100%;--thumb-h:220px} .gallery-grid{grid-template-columns:1fr} }
.lightbox{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:2000}
.lightbox.show{display:flex}
.lightbox img{max-width:95vw;max-height:90vh;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.lb-close{position:absolute;top:16px;right:16px;background:rgba(255,255,255,.9);border:0;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700}
`;

  return `<!doctype html><html lang="zh-Hant"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>預覽</title>
<link rel="icon" href="data:,">
<style>${css}</style>
<!-- 在「預覽分頁」自己載套件 -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"><\/script>
</head><body>
<div id="app" class="preview-box"></div>
<div id="lightbox" class="lightbox" aria-hidden="true">
  <button class="lb-close" onclick="document.getElementById('lightbox').classList.remove('show')">✕</button>
  <img id="lightbox-img" alt="">
</div>

<script>
(function(){
  const RAW_MD = ${RAW};

  // Obsidian callout 轉漂亮盒
  function preprocessCallouts(md){
    const lines=String(md).split(/\\r?\\n/), out=[]; let i=0;
    const titleMap={NOTE:"Note",TIP:"Tip",WARNING:"Warning",INFO:"Info"};
    while(i<lines.length){
      // 乾淨可用：支援 > [!NOTE] 這類 Obsidian callout
      const m = lines[i].match(/^\s*>\s*\[!(NOTE|TIP|WARNING|INFO)\]\s*(.*)$/i);
      if(m){
        const kind=m[1].toUpperCase(), title=(m[2]||"").trim()||titleMap[kind];
        const body=[]; i++;
        while(i<lines.length){
          const l=lines[i];
          if(/^\\s*>/.test(l)){ body.push(l.replace(/^\\s*>\\s?/, "")); i++; }
          else if(/^\\s*$/.test(l)){ body.push(""); i++; }
          else break;
        }
        out.push('> '+title);
        out.push('>');
        out.push(body.join('\\n'));
        continue;
      }
      out.push(lines[i]); i++;
    }
    return out.join('\\n');
  }

  // 只含圖片的 <p> 合成圖片牆（>=3 才包）
  function wrapConsecutiveImages(root){
    const kids=[...root.childNodes].filter(n=> n.nodeType===1 || (n.nodeType===3 && String(n.nodeValue).trim().length>0));
    let run=[];
    function isImgOnlyP(node){
      if(!(node.nodeType===1 && node.tagName==='P')) return false;
      const imgs=node.querySelectorAll('img'); if(!imgs.length) return false;
      const clone=node.cloneNode(true); clone.querySelectorAll('img').forEach(i=>i.remove());
      return String(clone.textContent||'').trim().length===0;
    }
    function flush(){
      if(run.length<3){ run.length=0; return; }
      const gallery=document.createElement('div'); gallery.className='gallery-block';
      const head=document.createElement('div'); head.className='gallery-head'; head.textContent='圖片';
      const grid=document.createElement('div'); grid.className='gallery-grid';
      gallery.append(head,grid);
      run.forEach(p=>{
        p.querySelectorAll('img').forEach(img=>{
          const item=document.createElement('div'); item.className='gallery-item';
          const a=document.createElement('a'); a.className='gallery-link'; a.href=img.getAttribute('src')||'#'; a.target='_blank';
          const thumb=img.cloneNode(true); thumb.classList.add('thumb'); a.appendChild(thumb);
          item.appendChild(a);
          if(img.alt){ const cap=document.createElement('div'); cap.className='caption'; cap.textContent=img.alt; item.appendChild(cap); }
          grid.appendChild(item);
        });
      });
      root.insertBefore(gallery, run[0]);
      run.forEach(n=>root.removeChild(n)); run.length=0;
    }
    kids.forEach(n=>{ if(isImgOnlyP(n)) run.push(n); else flush(); });
    flush();
  }

  // 把 <pre><code> 轉成 .mermaid，支援：
  // 1) ```mermaid fenced code
  // 2) ``` + 第一行內容是 "mermaid"
  function upgradeMermaid(root){
    root.querySelectorAll('pre > code').forEach(code=>{
      const lang=(code.className||'').toLowerCase();
      const txt=code.textContent||'';
      const hasLang=/(^|\\s)(language\\-|lang\\-)?mermaid(\\s|$)/.test(lang);
      const firstLine=/^mermaid\\s*\\n/.test(txt);
      if(!hasLang && !firstLine) return;
      const graph = hasLang ? txt : txt.replace(/^mermaid\\s*\\n/,'');
      const pre=code.parentElement;
      const div=document.createElement('div');
      div.className='mermaid';
      div.textContent=graph.trim();
      pre.replaceWith(div);
    });
  }

  function enableLightbox(){
    document.addEventListener('click', e=>{
      const a=e.target.closest('.gallery-link'); if(!a) return;
      e.preventDefault();
      const lb=document.getElementById('lightbox');
      const img=document.getElementById('lightbox-img');
      img.src=a.href; img.alt=a.querySelector('img')?.alt||'';
      lb.classList.add('show'); lb.setAttribute('aria-hidden','false');
    });
    document.getElementById('lightbox').addEventListener('click', e=>{
      if(e.target.id==='lightbox') e.currentTarget.classList.remove('show');
    });
    document.addEventListener('keydown', e=>{
      if(e.key==='Escape') document.getElementById('lightbox').classList.remove('show');
    });
  }

  function run(){
    const md = preprocessCallouts(RAW_MD);
    // 用 marked 在預覽頁解析
    const html = (window.marked && marked.parse) ? marked.parse(md) : md.replace(/[&<>"]/g,s=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[s]));
    const host = document.getElementById('app');
    host.innerHTML = html;

    // 升級 mermaid、跑 mermaid
    upgradeMermaid(host);
    if(window.mermaid){
      try{
        mermaid.initialize({ startOnLoad:false });
        if(typeof mermaid.run==='function') mermaid.run();
        else mermaid.init(undefined, host.querySelectorAll('.mermaid'));
      }catch(e){}
    }

    // 打包圖片牆
    wrapConsecutiveImages(host);
    enableLightbox();
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', run);
  else run();
})();
<\/script>
</body></html>`;
}


/* ===========================================================
   只編輯 / 只預覽：模式切換與預覽渲染
   依賴你現有的 buildPreviewHTML(md) 產出完整 HTML
   =========================================================== */

/* 內嵌預覽：把 buildPreviewHTML 產出的整份 HTML，變 Blob URL 塞進 iframe */
let __prevBlobUrl = null; // 記住上一次的 Blob URL，用來回收避免吃記憶體

function renderInlinePreview(){
  const frame = document.getElementById('previewFrame');
  if (!frame) {
    // 沒有預覽 iframe，直接跳過（避免你還沒放 HTML 時報錯）
    return;
  }

  const md = (document.getElementById('md')?.value) || '';
  const html = buildPreviewHTML(md); // ← 直接用你的函式

  // 回收上一次的 Blob URL（iPad 對記憶體特別玻璃心）
  if (__prevBlobUrl) {
    URL.revokeObjectURL(__prevBlobUrl);
    __prevBlobUrl = null;
  }

  // 產生新預覽並指給 iframe
  const blob = new Blob([html], { type: 'text/html' });
  __prevBlobUrl = URL.createObjectURL(blob);
  frame.src = __prevBlobUrl;
}

/* 模式切換：在 <body> 上設 data-mode，配合 CSS 顯示/隱藏
   - mode = 'edit'   ：只編輯（編輯器 + 圖片工具）
   - mode = 'preview' ：只預覽（顯示預覽卡片，其他藏起來）
*/
function setMode(mode){
  document.body.setAttribute('data-mode', mode);
  if (mode === 'preview') {
    // 需要看到預覽時才渲染，減少無謂重排
    renderInlinePreview();
  }
}

/* 綁定兩顆模式按鈕（存在才綁，避免你還沒放按鈕時報錯） */
const __btnEdit    = document.getElementById('modeEditBtn');
const __btnPreview = document.getElementById('modePreviewBtn');

if (__btnEdit)    __btnEdit.addEventListener('click',  () => setMode('edit'));
if (__btnPreview) __btnPreview.addEventListener('click', () => setMode('preview'));

/* 如果你還留著舊的 #previewBtn，那就讓它也切到只預覽 */
const __oldPreview = document.getElementById('previewBtn');
if (__oldPreview)  __oldPreview.addEventListener('click', () => setMode('preview'));

/* 快捷鍵：Cmd/Ctrl+Enter 預覽，Esc 回編輯（可刪） */
document.addEventListener('keydown', e => {
  if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') setMode('preview');
  if (e.key === 'Escape') setMode('edit');
});

/* 初始化預設模式：進頁面先處於只編輯 */
setMode('edit');

/* 安全下莊：離開頁面時回收 Blob URL（可省，但我不想看 iPad 掛） */
window.addEventListener('beforeunload', () => {
  if (__prevBlobUrl) URL.revokeObjectURL(__prevBlobUrl);
});













</script>
</body>
</html>