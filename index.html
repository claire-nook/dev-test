<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Writer + Images (åˆä½µç‰ˆ)</title>

<!-- ===== å¤–è§€ï¼šç°¡æ½”åˆ°ä¸æœƒç¤™äº‹ ===== -->
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280; --line:#e5e7eb; --brand:#4f46e5;
    --radius:12px; --shadow:0 6px 18px rgba(17,24,39,.06);
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{ margin:0; background:var(--bg); color:var(--text); font:16px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif; }

  header{
    position:sticky; top:0; z-index:10;
    display:flex; align-items:center; gap:8px; justify-content:space-between;
    padding:10px 12px; background:#fff; border-bottom:1px solid var(--line);
  }
  .h-left{ display:flex; align-items:center; gap:8px }
  .title{ font-weight:800; letter-spacing:.2px }
  .btn{
    appearance:none; border:1px solid var(--line); background:#fff; color:#111; padding:.5rem .8rem;
    border-radius:10px; cursor:pointer; font-weight:600; box-shadow:0 1px 4px rgba(0,0,0,.05);
  }
  .btn.primary{ background:var(--brand); color:#fff; border-color:transparent }
  .btn.ghost{ background:#fff }
  .btn:disabled{ opacity:.5; cursor:not-allowed }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 3px 10px rgba(0,0,0,.08) }
.btn.ghost {
  background:#fff;
  text-decoration: none; /* â† é€™è¡Œæ‹¿æ‰åº•ç·š */
}
.btn.ghost,
.btn.ghost:hover {
  text-decoration: none;
}
  .wrap{ display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; padding:12px; height:calc(100vh - 64px); }
  @media (max-width: 980px){ .wrap{ grid-template-columns:1fr; height:auto; } }

  .card{
    background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
    box-shadow:var(--shadow); display:flex; flex-direction:column; min-height:0;
  }
  .card h3{
    margin:0; padding:10px 12px; border-bottom:1px solid var(--line);
    font-size:14px; color:var(--muted); display:flex; align-items:center; gap:8px; flex-wrap:wrap;
  }
  .card .body{ padding:12px; min-height:0; overflow:auto; }

  /* ç·¨è¼¯å™¨ */
  textarea#md{
    width:100%; height:60vh; border:1px solid var(--line); border-radius:10px; padding:12px;
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:14px; resize:vertical;
  }
  @media (max-width:980px){ textarea#md{ height:40vh } }

  /* åœ–ç‰‡å€ */
  .toolbar{ display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px }
  .grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px }
  @media (max-width:600px){ .grid{ grid-template-columns: repeat(2, 1fr) } }
  .thumb{
    position:relative; border:1px solid var(--line); border-radius:10px; overflow:hidden; background:#fff;
  }
  .thumb img{ width:100%; height:140px; object-fit:cover; display:block }
  .thumb .meta{
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    padding:6px; background:#fafafa; border-top:1px solid var(--line); font-size:12px;
  }
  .thumb .name{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#374151 }
  .thumb .chk{ display:inline-flex; align-items:center; gap:6px }
  .thumb .x{
    position:absolute; top:6px; right:6px; width:28px; height:28px; display:grid; place-items:center;
    background:rgba(255,255,255,.85); border:1px solid #fecaca; color:#b91c1c; border-radius:8px; cursor:pointer;
  }

  /* å°æç¤º */
  .tip{ font-size:13px; color:var(--muted) }

  /* Toast */
  .toast{
    position:fixed; bottom:16px; right:16px; background:#111827; color:#fff;
    padding:10px 14px; border-radius:10px; font-size:13px; opacity:0; transform:translateY(10px);
    transition:opacity .2s, transform .2s; pointer-events:none; z-index:99;
  }
  .toast.show{ opacity:1; transform:translateY(0) }

/* å·¦ä¸Šè§’å¤§é¡†å‹¾é¸æ¡†ï¼ˆæ›´å¥½æˆ³ï¼‰ */
.thumb .chk {
  position: absolute;
  left: 8px; top: 8px;
  z-index: 2;
  background: rgba(255,255,255,.95);
  border: 1px solid #d1d5db;
  border-radius: 10px;
  padding: 4px;
}
.thumb .chk input[type="checkbox"]{
  width: 22px; height: 22px;
  accent-color: #2563eb;
}

/* è¢«é¸ä¸­æ™‚ï¼Œæ•´å¼µå¡ç‰‡æœ‰é«˜å°æ¯”å¤–æ¡†èˆ‡æ·¡è—é®ç½© */
.thumb.selected { box-shadow: 0 0 0 3px #2563eb inset; }
.thumb.selected::after{
  content:"";
  position:absolute; inset:0;
  background: rgba(37,99,235,.08);
  pointer-events:none;
}

/* å›ºå®šåœ–ç‰‡å·¥å…·åˆ—åœ¨åœ–ç‰‡å€å¡Šä¸Šæ–¹ */
.card .body {
  display: flex;
  flex-direction: column;
}

.toolbar.sticky {
  position: sticky;
  top: 0;               /* è²¼é½Šå¡ç‰‡å…§çš„æœ€ä¸Šæ–¹ */
  z-index: 5;           /* è“‹åœ¨ç¸®åœ–ä¹‹ä¸Š */
  background: #fff;     /* èƒŒæ™¯è¦ç™½ï¼Œä¸ç„¶æœƒè·Ÿä¸‹æ–¹ç¸®åœ–ç–Šè‰² */
  padding: 8px 0;       /* ç¢ºä¿ä¸æ“ åˆ°é‚Š */
  border-bottom: 1px solid var(--line); /* è·Ÿç¸®åœ–å€éš” */
}


</style>
</head>
<body>

<header>
  <div class="h-left">
    <div class="title">âœï¸ Writer + ğŸ–¼ Images</div>
    <!-- ç·¨è¼¯å™¨åŠŸèƒ½åˆ—ï¼šé–‹å•Ÿ / å„²å­˜ / è¤‡è£½ / æ¸…ç©º / æ’å…¥åœ–ç‰‡èªæ³• -->
    <button class="btn" id="openMdBtn">é–‹å•Ÿ</button>
    <button class="btn" id="saveMdBtn">å„²å­˜</button>
    <button class="btn" id="copyMdBtn">è¤‡è£½</button>
    <button class="btn" id="clearMdBtn">æ¸…ç©º</button>
    <button class="btn primary" id="insertFromImageBtn" title="è«‹å…ˆåœ¨å³å´ç”¢ç”Ÿä¸¦è¤‡è£½å‹¾é¸åœ–ç‰‡çš„ MD">æ’å…¥åœ–ç‰‡èªæ³•</button>
    
    <input id="openMdFile" type="file" accept=".md,.markdown,text/markdown,text/plain" hidden />
  </div>
  <a class="btn ghost" href="index.html">ğŸ  å›é¦–é </a>
</header>

<main class="wrap">
  <!-- å·¦ï¼šç·¨è¼¯å™¨ -->
  <section class="card">
    <h3>Markdown ç·¨è¼¯</h3>
    <div class="body">
      <textarea id="md" placeholder="åœ¨é€™è£¡å¯«æ–‡ç« ã€‚æ’å…¥åœ–ç‰‡èªæ³•çš„ä¾†æºï¼šå…ˆåˆ°å³é‚Šåœ–ç‰‡å€ã€ç”¢ç”Ÿ MD èªæ³•ã€ä¸¦ã€è¤‡è£½å‹¾é¸åœ–ç‰‡MDã€ï¼Œå†æŒ‰ä¸Šæ–¹ã€æ’å…¥åœ–ç‰‡èªæ³•ã€ã€‚"></textarea>
      <p class="tip" style="margin-top:8px">å„²å­˜èˆ‡ä¸‹è¼‰æœƒå„ªå…ˆä½¿ç”¨ç³»çµ±å­˜æª”å°è©±æ¡†ï¼ˆFile System Accessï¼‰ã€‚ä¸æ”¯æ´æ™‚æ”¹ç”¨ç€è¦½å™¨ä¸‹è¼‰ã€‚</p>
    </div>
  </section>

  <!-- å³ï¼šåœ–ç‰‡å·¥å…· -->
  <aside class="card">
    <h3>åœ–ç‰‡å€ï¼ˆå£“ç¸®ã€å‘½åã€å‹¾é¸ã€ZIPï¼‰</h3>
    <div class="body">
      <div class="toolbar sticky">
        <button class="btn" id="pickBtn">é¸æ“‡ç…§ç‰‡</button>
        <input id="file" type="file" accept="image/*" multiple hidden />
        <button class="btn" id="genMdBtn">ç”¢ç”ŸMDèªæ³•ï¼ˆé–æª”åï¼‰</button>
        <button class="btn ghost" id="clearBatchBtn">æ¸…ç©ºæ­¤æ‰¹</button>
      </div>
      <div class="toolbar sticky">
        <button class="btn ghost" id="checkAllBtn">å…¨éƒ¨å‹¾é¸</button>
        <button class="btn ghost" id="uncheckAllBtn">å–æ¶ˆå‹¾é¸</button>
        <button class="btn" id="copySelectedBtn">è¤‡è£½å‹¾é¸åœ–ç‰‡MD</button>
        <button class="btn" id="saveZipBtn">ä¸‹è¼‰ZIPåœ–ç‰‡</button>
      </div>
      <div class="toolbar">
        <label class="tip">åœ–ç‰‡æœ€é•·é‚Šï¼ˆpxï¼‰
          <input id="maxDim" type="number" value="1200" min="640" step="80" style="width:120px; margin-left:6px; padding:6px; border:1px solid var(--line); border-radius:8px" />
        </label>
        <span class="tip">ZIP ç›®éŒ„å›ºå®šç‚º <code>images/</code>ï¼Œåœ–æª”æ ¼å¼ <code>{prefix}-nnn.jpg</code>ï¼Œå» EXIFã€‚</span>
      </div>

      <div id="grid" class="grid"></div>
    </div>
  </aside>
  
  
</main>

<div id="toast" class="toast"></div>

<!-- ä¾è³´å¥—ä»¶ï¼ˆCDNï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
/* ===========================================================
   åˆä½µç‰ˆæ ¸å¿ƒé‚è¼¯
   - ç·¨è¼¯å™¨ï¼šé–‹å•Ÿ / å„²å­˜ / è¤‡è£½ / æ¸…ç©º / æ’å…¥åœ–ç‰‡èªæ³•
   - åœ–ç‰‡å€ï¼šé¸åœ–(å£“ç¸®å»EXIF) / ç”¢ç”ŸMD(é–æª”å) / å‹¾é¸ç®¡ç† / ZIP / æ¸…ç©º
   =========================================================== */

/* ---------- å°å·¥å…·ï¼šæç¤º ---------- */
const toastEl = document.getElementById('toast');
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'), 1600);
}

/* ---------- ç·¨è¼¯å™¨ DOM ---------- */
const mdEl = document.getElementById('md');
const openMdBtn = document.getElementById('openMdBtn');
const openMdFile = document.getElementById('openMdFile');
const saveMdBtn = document.getElementById('saveMdBtn');
const copyMdBtn = document.getElementById('copyMdBtn');
const clearMdBtn = document.getElementById('clearMdBtn');
const insertFromImageBtn = document.getElementById('insertFromImageBtn');

/* ---------- åœ–ç‰‡å€ DOM ---------- */
const pickBtn = document.getElementById('pickBtn');
const fileEl = document.getElementById('file');
const genMdBtn = document.getElementById('genMdBtn');
const clearBatchBtn = document.getElementById('clearBatchBtn');
const gridEl = document.getElementById('grid');
const checkAllBtn = document.getElementById('checkAllBtn');
const uncheckAllBtn = document.getElementById('uncheckAllBtn');
const copySelectedBtn = document.getElementById('copySelectedBtn');
const saveZipBtn = document.getElementById('saveZipBtn');
const maxDimEl = document.getElementById('maxDim');

/* ---------- ç‹€æ…‹ ---------- */
let items = []; // { file, blob, url, w, h, _finalName?, _selected }
let namePrefix = null; // ä¸€æ‰¹å”¯ä¸€å‰ç¶´
let mdCache = '';      // ä½¿ç”¨è€…å‰›å‰›åœ¨åœ–ç‰‡å€ã€Œè¤‡è£½å‹¾é¸åœ–ç‰‡MDã€æ™‚ï¼ŒåŒæ­¥å¿«å–åˆ°é€™è£¡ï¼Œä¾›ã€Œæ’å…¥åœ–ç‰‡èªæ³•ã€ä½¿ç”¨

function makePrefix(){
  const t = Date.now().toString(36);
  const r = Math.floor(Math.random()*1e6).toString(36);
  return (t.slice(-3) + r).slice(0,5);
}
function pad3(n){ return String(n).padStart(3,'0'); }

/* ===========================================================
   ç·¨è¼¯å™¨åŠŸèƒ½
   =========================================================== */

/* é–‹å•Ÿï¼ˆiCloud å¯ç”¨ç³»çµ±å°è©±æ¡†ï¼‰ */
openMdBtn.addEventListener('click', ()=> openMdFile.click());
openMdFile.addEventListener('change', async e=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  mdEl.value = txt;
  toast('å·²è¼‰å…¥ Markdown');
});

/* å„²å­˜ï¼ˆå„ªå…ˆä½¿ç”¨ File System Accessï¼Œå¦å‰‡ä½¿ç”¨ FileSaver å‚™æ´ï¼‰ */
saveMdBtn.addEventListener('click', async ()=>{
  try{
    const blob = new Blob([mdEl.value], {type:'text/markdown;charset=utf-8'});
    if(window.showSaveFilePicker){
      const handle = await showSaveFilePicker({
        suggestedName: 'note.md',
        types: [{ description: 'Markdown', accept: { 'text/markdown':['.md','.markdown'], 'text/plain':['.md'] } }]
      });
      const writable = await handle.createWritable();
      await writable.write(blob);
      await writable.close();
    }else{
      saveAs(blob, 'note.md');
    }
    toast('MD å·²å„²å­˜');
  }catch(e){
    console.error(e);
    toast('å„²å­˜å¤±æ•—æˆ–å–æ¶ˆ');
  }
});

/* è¤‡è£½æ•´ä»½ MD */
copyMdBtn.addEventListener('click', async ()=>{
  try{
    await navigator.clipboard.writeText(mdEl.value);
    toast('å·²è¤‡è£½ MD');
  }catch{
    toast('ç„¡æ³•å­˜å–å‰ªè²¼ç°¿');
  }
});

/* æ¸…ç©º */
clearMdBtn.addEventListener('click', ()=>{
  mdEl.value = '';
  toast('å·²æ¸…ç©ºç·¨è¼¯å™¨');
});

/* å¾åœ–ç‰‡å€æ’å…¥ï¼ˆç”¨å¿«å–ï¼Œä¸å¼·åˆ¶è¦å‰ªè²¼ç°¿æ¬Šé™ï¼‰ */
insertFromImageBtn.addEventListener('click', async ()=>{
  let text = mdCache;
  if(!text){
    // æ¬¡é¸ï¼šå˜—è©¦å¾å‰ªè²¼ç°¿è®€
    try{ text = await navigator.clipboard.readText(); }catch(_){}
  }
  if(!text){
    toast('æ²’æœ‰å¯æ’å…¥çš„åœ–ç‰‡ Markdownã€‚è«‹å…ˆåœ¨å³å´ã€Œè¤‡è£½å‹¾é¸åœ–ç‰‡MDã€ã€‚');
    return;
  }
  insertAtCursor(mdEl, text.endsWith('\n') ? text : text + '\n');
  toast('å·²æ’å…¥åœ–ç‰‡ Markdown');
});
function insertAtCursor(textarea, text){
  const start = textarea.selectionStart ?? textarea.value.length;
  const end   = textarea.selectionEnd ?? textarea.value.length;
  const before = textarea.value.slice(0, start);
  const after  = textarea.value.slice(end);
  textarea.value = before + text + after;
  const pos = (before + text).length;
  textarea.setSelectionRange(pos, pos);
  textarea.focus();
}

/* ===========================================================
   åœ–ç‰‡å€ï¼šé¸åœ–â†’å£“ç¸®å»EXIFâ†’é¡¯ç¤ºç¸®åœ–
   =========================================================== */

pickBtn.addEventListener('click', ()=> fileEl.click());
fileEl.addEventListener('change', async e=>{
  const files = Array.from(e.target.files || []).filter(f=>f.type.startsWith('image/'));
  if(!files.length) return;
  const maxDim = Math.max(640, Number(maxDimEl.value || 1200));
  for(const f of files){
    const it = await readAndCompress(f, maxDim);
    items.push(it);
    addThumb(it);
  }
  toast(`å·²è¼‰å…¥ ${files.length} å¼µåœ–ç‰‡`);
});

/* è®€æª” + re-encode å» EXIF */
function readFileAsDataURL(file){
  return new Promise((res, rej)=>{
    const fr = new FileReader();
    fr.onload = ()=> res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}
function loadImage(src){
  return new Promise((res, rej)=>{
    const img = new Image();
    img.onload = ()=> res(img);
    img.onerror = rej;
    img.src = src;
  });
}
async function readAndCompress(file, maxDim){
  const dataURL = await readFileAsDataURL(file);
  const img = await loadImage(dataURL);
  let w = img.width, h = img.height;
  const r = w / h;
  if(w > h && w > maxDim){ w = maxDim; h = Math.round(maxDim / r); }
  else if(h >= w && h > maxDim){ h = maxDim; w = Math.round(maxDim * r); }
  const c = document.createElement('canvas');
  c.width = w; c.height = h;
  const ctx = c.getContext('2d');
  ctx.drawImage(img, 0, 0, w, h);
  const blob = await new Promise(res => c.toBlob(res, 'image/jpeg', 0.7));
  const url = URL.createObjectURL(blob);
  return { file, blob, url, w, h, _selected:false };
}

function bindSelectable(div, it){
  // è®“æ•´å¼µç¸®åœ–èƒ½åˆ‡æ›å‹¾é¸ï¼ŒåŒæ™‚é¿å…æ»‘å‹•èª¤è§¸
  const THRESHOLD_PX = 8;     // ä½ç§»é–€æª»
  const THRESHOLD_MS = 250;   // æ™‚é•·é–€æª»
  let startX=0, startY=0, startT=0, moved=false, pointer=-1;

  const onDown = (e) => {
    if (pointer !== -1) return; // å·²æœ‰æŒ‡æ¨™
    const p = e.touches ? e.touches[0] : e;
    if (!p) return;
    pointer = p.identifier ?? p.pointerId ?? 0;
    startX = p.clientX; startY = p.clientY; startT = Date.now();
    moved  = false;
  };

  const onMove = (e) => {
    if (pointer === -1) return;
    const p = e.touches ? e.touches[0] : e;
    if (!p) return;
    const dx = p.clientX - startX, dy = p.clientY - startY;
    if (dx*dx + dy*dy > THRESHOLD_PX*THRESHOLD_PX) moved = true;
  };

  const onUp = (e) => {
    // é‡ç½®æŒ‡æ¨™
    pointer = -1;
    const dur = Date.now() - startT;

    // åªåœ¨ã€ŒçŸ­ä¸”æ²’ç§»å‹•ã€æ™‚ç•¶ä½œé»æ“Š
    const isTap = !moved && dur < THRESHOLD_MS;
    if (!isTap) return;

    // åˆ‡æ›å‹¾é¸ç‹€æ…‹
    it._selected = !it._selected;
    if (it._chkEl) it._chkEl.checked = it._selected;
    div.classList.toggle('selected', it._selected);
  };

  // ç¶å®š Pointer/Touch/Mouseï¼ˆè¢«å‹•ç›£è½é¿å…å¡æ²å‹•ï¼‰
  div.addEventListener('pointerdown', onDown, { passive: true });
  div.addEventListener('pointermove', onMove, { passive: true });
  div.addEventListener('pointerup',   onUp,   { passive: true });
  div.addEventListener('pointercancel', ()=> { pointer = -1; });

  // éµç›¤å¯ç”¨æ€§ï¼ˆTab åˆ°ç¸®åœ–æŒ‰ç©ºç™½/Enter ä¹Ÿèƒ½åˆ‡æ›ï¼‰
  div.tabIndex = 0;
  div.setAttribute('role', 'checkbox');
  div.setAttribute('aria-checked', 'false');
  div.addEventListener('keydown', (e)=>{
    if (e.key === ' ' || e.key === 'Enter'){
      e.preventDefault();
      it._selected = !it._selected;
      if (it._chkEl) it._chkEl.checked = it._selected;
      div.classList.toggle('selected', it._selected);
      div.setAttribute('aria-checked', it._selected ? 'true' : 'false');
    }
  });
}


/* ç¸®åœ–å…ƒä»¶ï¼ˆåˆªé™¤åœ¨å³ä¸Šè§’ / å‹¾é¸åˆ†é–‹ï¼‰ */
/* ç¸®åœ–å…ƒä»¶ï¼ˆåˆªé™¤åœ¨å³ä¸Šè§’ / å‹¾é¸åˆ†é–‹ / æ•´å¼µå¯é»é¸ï¼‰ */
function addThumb(it){
  const div = document.createElement('div');
  div.className = 'thumb';

  // åœ–ç‰‡
  const img = document.createElement('img');
  img.src = it.url;

  // å³ä¸Šè§’ âŒ åˆªé™¤
  const close = document.createElement('button');
  close.className = 'x';
  close.type = 'button';
  close.textContent = 'âœ•';
  close.title = 'åˆªé™¤æ­¤å¼µ';
  close.addEventListener('click', (e)=>{
    e.stopPropagation();               // é¿å…åŒæ™‚è§¸ç™¼é»æ“Šåˆ‡æ›
    const i = items.indexOf(it);
    if (i >= 0) items.splice(i, 1);
    URL.revokeObjectURL(it.url);
    div.remove();
  });

  // å·¦ä¸Šè§’å‹¾é¸æ¡†
  const chkWrap = document.createElement('label');
  chkWrap.className = 'chk';
  const chk = document.createElement('input');
  chk.type = 'checkbox';
  chk.addEventListener('change', ()=>{
    it._selected = chk.checked;
    div.classList.toggle('selected', it._selected);
    div.setAttribute('aria-checked', it._selected ? 'true' : 'false');
  });
  chkWrap.append(chk);

  // ä¸‹æ–¹æª”ååˆ—
  const meta = document.createElement('div');
  meta.className = 'meta';
  const name = document.createElement('span');
  name.className = 'name';
  name.textContent = it._finalName || '(æœªå‘½å)';
  meta.append(name);

  // çµ„è£
  div.append(img, close, chkWrap, meta);
  gridEl.append(div);

  // ç‹€æ…‹å¼•ç”¨
  it._el = div;
  it._chkEl = chk;
  it._nameEl = name;

  // è®“æ•´å¼µç¸®åœ–å¯é»é¸ï¼Œä½†æ»‘å‹•ä¸èª¤è§¸
  bindSelectable(div, it);
}



/* ä¸€éµæ¸…ç©ºæ­¤æ‰¹ */
clearBatchBtn.addEventListener('click', ()=>{
  items.forEach(it=> URL.revokeObjectURL(it.url));
  items = [];
  gridEl.innerHTML = '';
  namePrefix = null;
  mdCache = '';
  toast('å·²æ¸…ç©ºæ­¤æ‰¹åœ–ç‰‡');
});

/* ç”¢ç”Ÿ MD èªæ³•ï¼šæ­¤åˆ»å›ºå®šæª”åï¼Œä¸å†å› é †åºè®Šå‹•ï¼ˆé€™ç‰ˆæ²’æœ‰æ‹–æ›³ï¼‰ */
genMdBtn.addEventListener('click', ()=>{
  if(!items.length){ toast('æ²’æœ‰åœ–ç‰‡å¯ä»¥å‘½å'); return; }
  if(!namePrefix) namePrefix = makePrefix();
  let n = 1;
  for(const it of items){
    if(!it._finalName){
      it._finalName = `${namePrefix}-${pad3(n++)}.jpg`;
      it._path = `images/${it._finalName}`;
      if(it._nameEl) it._nameEl.textContent = it._finalName;
    }
  }
  toast('æª”åå·²å›ºå®šï¼Œå¯å‹¾é¸ä¸¦è¤‡è£½ MD');
});

/* å‹¾é¸ç®¡ç† */
checkAllBtn.addEventListener('click', ()=>{
  items.forEach(it=>{ it._selected = true; it._chkEl && (it._chkEl.checked = true); });
});
uncheckAllBtn.addEventListener('click', ()=>{
  items.forEach(it=>{ it._selected = false; it._chkEl && (it._chkEl.checked = false); });
});

/* è¤‡è£½å‹¾é¸åœ–ç‰‡çš„ MDï¼ˆä¸¦å¿«å–ï¼Œä¾›å·¦å´ã€Œæ’å…¥åœ–ç‰‡èªæ³•ã€ç”¨ï¼‰ */
copySelectedBtn.addEventListener('click', async ()=>{
  const hadName = items.every(it=> !!it._finalName);
  if(!hadName){ toast('è«‹å…ˆæŒ‰ã€Œç”¢ç”ŸMDèªæ³•ã€é–å®šæª”å'); return; }
  const picked = items.filter(it=> it._selected);
  if(!picked.length){ toast('è«‹å…ˆå‹¾é¸è¦æ’å…¥çš„åœ–ç‰‡'); return; }

  // é€å¼µç¨ç«‹è¡Œï¼Œä¸­é–“ç©ºä¸€è¡Œï¼Œè§¸ç™¼ä½ çš„è‡ªå‹•åœ–ç‰†è¦å‰‡
  const lines = [];
  for(const it of picked){
    lines.push(`![](${it._path})`, '');
  }
  const out = lines.join('\n');

  try{
    await navigator.clipboard.writeText(out);
    mdCache = out;
    toast('å·²è¤‡è£½å‹¾é¸åœ–ç‰‡çš„ Markdown');
  }catch{
    mdCache = out; // å°±ç®—æ²’æœ‰æ¬Šé™ï¼Œé‚„æ˜¯ä¿ç•™åœ¨å¿«å–ä¾›ã€Œæ’å…¥åœ–ç‰‡èªæ³•ã€
    toast('å·²æº–å‚™ MDï¼ˆå‰ªè²¼ç°¿æ¬Šé™è¢«æ“‹ï¼Œè«‹ç”¨ã€Œæ’å…¥åœ–ç‰‡èªæ³•ã€è²¼å…¥ï¼‰');
  }
});

/* ä¸‹è¼‰ ZIPï¼ˆimages/ è£¡é¢å¡å›ºå®šæª”åçš„ blobï¼‰ */
saveZipBtn.addEventListener('click', async ()=>{
  const named = items.filter(it=> it._finalName);
  if(!named.length){ toast('è«‹å…ˆã€Œç”¢ç”ŸMDèªæ³•ã€å›ºå®šæª”å'); return; }
  const zip = new JSZip();
  const folder = zip.folder('images');
  for(const it of named){
    const arrbuf = await it.blob.arrayBuffer();
    folder.file(it._finalName, arrbuf);
  }
  const blob = await zip.generateAsync({type:'blob'});
  try{
    if(window.showSaveFilePicker){
      const handle = await showSaveFilePicker({
        suggestedName: 'images.zip',
        types: [{ description:'ZIP æª”', accept:{ 'application/zip':['.zip'] } }]
      });
      const w = await handle.createWritable();
      await w.write(blob); await w.close();
    }else{
      saveAs(blob, 'images.zip');
    }
    toast('ZIP å·²ä¸‹è¼‰/å„²å­˜');
  }catch(e){
    console.error(e);
    toast('å·²å–æ¶ˆæˆ–å¤±æ•—');
  }
});
</script>












</script>
</body>
</html>