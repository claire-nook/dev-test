<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ—…éŠè¡Œäº‹æ›†å·¥å…·ï¼ˆ5é€±è¦–åœ–ï¼‰</title>

  <style>
    :root {
      --card-bg:#fff;
      --soft:#f5f5f7;
      --ink:#222;
      --muted:#666;
      --accent:#888;
      --radius:12px;
      --border:#e3e3e6;
    }

    * { box-sizing:border-box; }

    body {
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans TC", sans-serif;
      background:#fafafa;
      color:var(--ink);
    }

    header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:1rem 1.5rem;
      background:#fff;
      box-shadow:0 2px 5px rgba(0,0,0,0.05);
      position:sticky;
      top:0;
      z-index:10;
    }

    header h2 {
      margin:0;
      font-size:1.3rem;
    }

    header a {
      text-decoration:none;
      font-size:0.95rem;
      padding:0.45rem 0.85rem;
      border-radius:6px;
      background:#eee;
      color:#333;
      box-shadow:0 1px 4px rgba(0,0,0,0.1);
    }

    .wrap {
      max-width:1080px;
      margin:0 auto;
      padding:20px 16px 40px;
    }

    h3 {
      margin:0 0 8px;
      font-size:1.05rem;
    }

    p {
      margin:0 0 10px;
      font-size:0.95rem;
      color:var(--muted);
    }

    .toolbar {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      background:var(--card-bg);
      padding:14px;
      border-radius:var(--radius);
      box-shadow:0 2px 10px rgba(0,0,0,.06);
      margin-bottom:16px;
    }

    .toolbar-group {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }

    label {
      font-size:0.9rem;
      color:var(--muted);
    }

    input[type="date"],
    input[type="text"],
    input[type="number"],
    select,
    textarea {
      font-size:0.95rem;
      padding:6px 8px;
      border:1px solid var(--border);
      border-radius:8px;
      background:#fff;
    }

    input[type="color"] {
      padding:0;
      width:40px;
      height:32px;
      border-radius:6px;
      border:1px solid var(--border);
      background:#fff;
    }

    .btn {
      border:none;
      background:#2f855a;
      color:#fff;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-size:0.95rem;
      display:inline-flex;
      align-items:center;
      gap:4px;
      white-space:nowrap;
    }

    .btn.secondary { background:#4f8cff; }
    .btn.ghost { background:#e0e7ff; color:#333; }
    .btn[disabled] { background:#bdbdbd; cursor:not-allowed; }

    #summary {
      background:var(--soft);
      border-left:5px solid var(--accent);
      padding:12px 14px;
      border-radius:10px;
      font-size:0.95rem;
      line-height:1.6;
      box-shadow:inset 0 0 0 1px #eee;
      margin-bottom:16px;
    }

    /* é€™å€‹ç¾åœ¨ä¸åŒ…ä»»ä½•æ±è¥¿ï¼Œä½†ä¿ç•™ä¸å½±éŸ¿ */
    .main-layout {
      display:grid;
      grid-template-columns:minmax(0, 1fr);
      gap:18px;
      align-items:flex-start;
    }

    .calendar-card {
      background:var(--card-bg);
      border-radius:var(--radius);
      padding:12px 12px 16px;
      box-shadow:0 2px 10px rgba(0,0,0,.06);
      margin-bottom:18px;
    }

    .calendar-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }

    .calendar-range-label {
      font-size:0.9rem;
      color:var(--muted);
    }

    .calendar-weekdays {
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      font-size:0.9rem;
      color:var(--muted);
      margin-bottom:4px;
      padding:0 2px;
    }

    .weekday-cell { text-align:center; }

    .calendar-grid {
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      gap:4px;
    }

    .day-cell {
      background:#fff;
      border-radius:10px;
      border:1px solid #eee;
      min-height:115px;  /* åŸæœ¬ 80ï¼Œæ‹‰é«˜ä¸€é»è®“å­—æœ‰åœ°æ–¹ä½ */
      padding:4px 6px 6px;
      position:relative;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    .day-number {
      font-size:.95rem;
      font-weight:600;
    }

    .day-month-tag {
      font-size:.8rem;
      color:var(--muted);
      margin-left:4px;
    }

    .today-ring {
      position:absolute;
      top:4px;
      right:5px;
      width:8px;
      height:8px;
      border-radius:50%;
      border:2px solid #ff7043;
    }

    .has-range {
      background:linear-gradient(to bottom, rgba(79,140,255,0.08), #fff);
      border-color:#d0dcff;
    }

    .range-bar {
      position:absolute;
      left:0;
      right:0;
      top:0;
      height:4px;
    }

    .range-label {
      margin-top:2px;
      font-size:.78rem;
      font-weight:600;
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
    }

    .hotel-line {
      margin-top:2px;
      font-size:.8rem;
      color:#444;
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
    }

    .hotel-amount {
      margin-top:2px;
      font-size:.78rem;
      color:var(--muted);
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
    }

    .events {
      margin-top:4px;
      padding-top:2px;
      border-top:1px dashed #e0e0e0;
    }

    .event-item {
      display:flex;
      gap:4px;
      align-items:flex-start;
      font-size:.8rem;
      margin-bottom:1px;
    }

    .event-icon { font-size:.95rem; }
    .event-text {
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
    }
/* âœˆï¸ èˆªç­ï¼šå…è¨±å…©è¡Œé¡¯ç¤º */
.event-text-multiline {
  white-space: pre-line;
}

/* ä¸‹æ–¹è¼¸å…¥å€å¡Šï¼šå…¨éƒ¨ç›´å‘ä¸€åˆ—ä¸€æ¬„ */
.bottom-layout {
  display:flex;
  flex-direction:column;
  gap:18px;
  align-items:stretch;
}

    .panel {
      background:var(--card-bg);
      border-radius:var(--radius);
      padding:12px 12px 16px;
      box-shadow:0 2px 10px rgba(0,0,0,.06);
    }

    .field-row {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-bottom:8px;
    }

    .field-row small {
      font-size:0.8rem;
      color:var(--muted);
    }

    .badge {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 6px;
      border-radius:999px;
      background:#f4f4ff;
      font-size:0.8rem;
      color:#555;
    }

    .badge-dot {
      width:8px;
      height:8px;
      border-radius:50%;
      border:2px solid #4f8cff;
    }

    .list {
      border-top:1px dashed #e0e0e0;
      padding-top:8px;
      margin-top:6px;
      max-height:260px;
      overflow:auto;
    }

    .chip {
      border-radius:999px;
      border:1px solid #e0e0e0;
      padding:6px 10px;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      background:#fafafa;
      font-size:.85rem;
    }

    .chip-main {
      display:flex;
      flex-direction:column;
      min-width:0;
    }

    .chip-title {
      font-weight:600;
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
    }

    .chip-meta {
      font-size:.78rem;
      color:var(--muted);
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
    }

    .chip-actions {
      display:flex;
      gap:4px;
      flex-shrink:0;
    }

    .chip button {
      border:none;
      border-radius:999px;
      padding:3px 7px;
      font-size:.75rem;
      cursor:pointer;
    }

    .chip button.edit {
      background:#e3f2fd;
      color:#1565c0;
    }

    .chip button.delete {
      background:#ffebee;
      color:#c62828;
    }

    .chip.editing {
      border-color:#4f8cff;
      box-shadow:0 0 0 1px rgba(79,140,255,0.45);
      background:#f0f4ff;
    }
            /* Markdown é è¦½ç”¨ Modal */
            .modal-backdrop {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.35);
                display: none; /* é è¨­é—œé–‰ï¼Œæ‰“é–‹æ™‚æ”¹ç‚º flex */
                align-items: center;
                justify-content: center;
                z-index: 99;
            }

            .modal-dialog {
                background: var(--card-bg);
                border-radius: var(--radius);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
                max-width: 900px;
                width: 92%;
                max-height: 80vh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            .modal-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 10px 14px;
                border-bottom: 1px solid #e5e5ea;
                background: #f9fafb;
            }

            .modal-header-title {
                font-size: 0.98rem;
                font-weight: 600;
            }

            .modal-close-btn {
                border: none;
                background: transparent;
                font-size: 1.1rem;
                cursor: pointer;
                padding: 4px 8px;
                border-radius: 999px;
            }

            .modal-close-btn:hover {
                background: #e5e5ea;
            }

            .modal-body {
                padding: 12px 16px 14px;
                overflow: auto;
                font-size: 0.95rem;
                line-height: 1.6;
            }

            .modal-body h2 {
                font-size: 1.05rem;
                margin: 0.4rem 0 0.3rem;
            }

            .modal-body p {
                margin: 0.2rem 0 0.3rem;
            }

            .modal-body blockquote {
                margin: 6px 0;
                padding: 6px 10px;
                border-left: 4px solid var(--accent);
                background: var(--soft);
                border-radius: 6px;
            }

            .modal-body table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 8px;
                font-size: 0.9rem;
            }

            .modal-body th,
            .modal-body td {
                border: 1px solid #ddd;
                padding: 4px 6px;
                text-align: left;
            }

            .modal-body thead {
                background: #f3f4f6;
            }

            .modal-footer {
                padding: 8px 14px;
                border-top: 1px solid #e5e5ea;
                display: flex;
                justify-content: flex-end;
                gap: 8px;
                background: #fafafa;
            }

            @media (max-width: 767px) {
                /* ä½ åŸæœ¬çš„ @media å·²ç¶“å­˜åœ¨ï¼Œè¨˜å¾—åªè¦åœ¨è£¡é¢å¤šåŠ  modal çš„èª¿æ•´ */
                .modal-dialog {
                    max-height: 88vh;
                    width: 96%;
                }
            }
    @media (max-width: 767px) {
      .wrap { padding:16px 10px 28px; }
      header { padding:0.75rem 1rem; }
      .toolbar { padding:12px; }
      input, select, textarea, button {
        font-size:16px !important;
        height:44px;
      }
      .calendar-card { padding:10px; }
      .panel { padding:10px; }
    }
  </style>
</head>
<body>
  <header>
    <h2>ğŸ—ºï¸ æ—…éŠè¡Œäº‹æ›†ï¼ˆ5 é€±è¦åŠƒè¦–åœ–ï¼‰</h2>
    <a href="index.html">ğŸ§­ å›é¦–é </a>
  </header>

  <div class="wrap">
    <div class="toolbar">
      <div class="toolbar-group">
        <label>éŒ¨é»æ—¥æœŸï¼š</label>
        <input id="anchorDate" type="date" />
        <button id="btnToday" class="btn ghost" type="button">å›åˆ°ä»Šå¤©</button>
        <button id="btnGenerate" class="btn" type="button">æ›´æ–° 5 é€±è¦–åœ–</button>
      </div>

<div class="toolbar-group">
    <button id="btnCopyMd" class="btn secondary" type="button">è¤‡è£½ Markdown</button>
    <button id="btnPreviewMd" class="btn ghost" type="button">é è¦½è¡Œç¨‹</button>
</div>

      <div class="toolbar-group">
        <button id="btnImportJson" class="btn ghost" type="button">åŒ¯å…¥ JSON</button>
        <button id="btnExportJson" class="btn ghost" type="button">åŒ¯å‡º JSON</button>
        <input id="importJsonInput" type="file" accept="application/json" style="display:none;" />
      </div>
    </div>

    <div id="summary">å°šæœªå»ºç«‹æ—¥æ›†ã€‚è«‹å…ˆé¸ä¸€å€‹æ—¥æœŸï¼Œä¸¦æŒ‰ã€Œæ›´æ–° 5 é€±è¦–åœ–ã€ã€‚</div>

    <!-- æ—¥æ›†ç¨ç«‹ä¸€å¼µå¤§å¡ -->
    <div class="calendar-card">
      <div class="calendar-header">
        <h3>ğŸ—“ 5 é€±è¡Œäº‹æ›†</h3>
        <div id="calendarRangeLabel" class="calendar-range-label"></div>
      </div>
      <div class="calendar-weekdays">
        <div class="weekday-cell">ä¸€</div>
        <div class="weekday-cell">äºŒ</div>
        <div class="weekday-cell">ä¸‰</div>
        <div class="weekday-cell">å››</div>
        <div class="weekday-cell">äº”</div>
        <div class="weekday-cell">å…­</div>
        <div class="weekday-cell">æ—¥</div>
      </div>

      <div id="calendarGrid" class="calendar-grid"></div>
    </div>

    <!-- è¼¸å…¥å€å¡Šæ•´æ’åœ¨ä¸‹é¢ -->
    <div class="bottom-layout">
      <div class="panel">
        <h3>â‘  å€é–“ï¼ˆåŸå¸‚ï¼‰</h3>
        <p>è¨­å®šã€Œå¾…åœ¨å“ªå€‹åŸå¸‚ã€ã€‚</p>

        <div class="field-row">
          <input id="rangeName" type="text" placeholder="ä¾‹å¦‚ï¼šæœ­å¹Œ" />
          <input id="rangeColor" type="color" value="#4f8cff" />
        </div>
        <div class="field-row">
          <label>èµ·ï¼š</label>
          <input id="rangeStart" type="date" />
          <label>è¿„ï¼š</label>
          <input id="rangeEnd" type="date" />
          <button id="btnAddRange" class="btn secondary" type="button">åŠ å…¥å€é–“</button>
          <button id="btnCancelRangeEdit" class="btn secondary" type="button" style="display:none;">å–æ¶ˆç·¨è¼¯</button>
        </div>
        <div class="field-row">
          <span class="badge">
            <span class="badge-dot"></span>
            <span>å€é–“åªæ”¹é¡è‰²èˆ‡åœ°é»æ¬„ä½ï¼Œä¸æœƒç¢°åˆ°äº‹ä»¶è³‡æ–™ã€‚</span>
          </span>
        </div>

        <div id="rangeList" class="list"></div>
      </div>

      <div class="panel">
        <h3>â‘¡ é£¯åº—ä½å®¿ï¼ˆå«åŒ¯ç‡ï¼‰</h3>
        <p>è¨­å®šæ¯ä¸€æ®µä½å®¿çš„é£¯åº—åç¨±ã€é‡‘é¡èˆ‡æ¦‚ç®—åŒ¯ç‡ï¼Œæœƒé¡¯ç¤ºåœ¨æ—¥æ›†æ ¼å­è£¡ã€‚</p>

        <div class="field-row">
          <input id="hotelName" type="text" placeholder="ä¾‹å¦‚ï¼šæº«å“¥è¯è¬è±ª" />
        </div>
        <div class="field-row">
          <label>èµ·ï¼š</label>
          <input id="hotelStart" type="date" />
          <label>è¿„ï¼š</label>
          <input id="hotelEnd" type="date" />
        </div>
        <div class="field-row">
          <label>å¹£åˆ¥ï¼š</label>
          <select id="hotelCurrency">
            <option value="TWD">TWD</option>
            <option value="JPY">JPY</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="AUD">AUD</option>
            <option value="CAD">CAD</option>
            <option value="IDR">IDR</option>
            <option value="MYR">MYR</option>
            <option value="CNY">CNY</option>
            <option value="PT">é»æ•¸</option>
            
          </select>
        </div>
        <div class="field-row">
          <label>é‡‘é¡ï¼š</label>
          <input id="hotelAmount" type="number" step="0.01" min="0" placeholder="ä¾‹å¦‚ï¼š1.8" />
          <select id="hotelUnit">
            <option value="å…ƒ">å…ƒ</option>
            <option value="K">Kï¼ˆåƒï¼‰</option>
            <option value="M">Mï¼ˆç™¾è¬ï¼‰</option>
          </select>
        </div>
        <div class="field-row">
          <label>åŒ¯ç‡ï¼š</label>
          <input id="hotelFxRate" type="number" step="0.0001" min="0" placeholder="1 åŸå¹£ â‰ˆ å¹¾å°å¹£" />
        </div>
        <div class="field-row">
          <small>ä¾‹å¦‚ï¼šAUD 1 â‰ˆ 20 TWDã€JPY 100 â‰ˆ 20 TWDï¼ˆå‰‡å¡« 0.2ï¼‰ã€IDR 1,000 â‰ˆ 2 TWDï¼ˆå‰‡å¡« 0.002ï¼‰ã€‚</small>
        </div>
        <div class="field-row">
          <button id="btnAddHotel" class="btn secondary" type="button">åŠ å…¥ä½å®¿</button>
          <button id="btnCancelHotelEdit" class="btn secondary" type="button" style="display:none;">å–æ¶ˆç·¨è¼¯</button>
        </div>

        <div id="hotelList" class="list"></div>
      </div>

      <div class="panel">
        <h3>â‘¢ å–®æ—¥äº‹ä»¶ï¼ˆç§»å‹•ï¼æ´»å‹•ï¼å‚™è¨»ï¼‰</h3>
        <p>åƒ âœˆï¸ã€ğŸš„ã€ğŸšŒã€ğŸ£ é€™ç¨®ç™¼ç”Ÿåœ¨ã€ŒæŸä¸€å¤©ã€çš„äº‹æƒ…ã€‚</p>

        <div class="field-row">
          <label>æ—¥æœŸï¼š</label>
          <input id="eventDate" type="date" />
        </div>
<div class="field-row">
  <label>åœ–ç¤ºï¼š</label>
  <select id="eventIcon">
    <option value="âœˆï¸">âœˆï¸ é£›æ©Ÿ</option>
    <option value="ğŸš†">ğŸš† ç«è»Š</option>
    <option value="ğŸšŒ">ğŸšŒ å·´å£«</option>
    <option value="ğŸš—">ğŸš— åŒ…è»Š</option>
    <option value="ğŸš¢">ğŸš¢ éƒµè¼ª</option>
    <option value="ğŸ£">ğŸ£ é¤å»³</option>
    <option value="ğŸ›">ğŸ› é€›è¡—</option>
    <option value="ğŸ“">ğŸ“ æ™¯é»</option>
  </select>
  <input id="eventNote" type="text" placeholder="ä¾‹å¦‚ï¼šAC838ã€TPE â†’ CTS å¤œèˆª" />
  <button id="btnAddEvent" class="btn secondary" type="button">åŠ å…¥äº‹ä»¶</button>
  <button id="btnCancelEventEdit" class="btn secondary" type="button" style="display:none;">å–æ¶ˆç·¨è¼¯</button>
</div>
<!-- âœˆï¸ å°ˆç”¨ç¬¬äºŒè¡Œï¼šèµ·è¿„æ™‚é–“ -->
<div class="field-row" id="eventExtraRow" style="display:none;">
  <label style="visibility:hidden;">åœ–ç¤ºï¼š</label>
  <input id="eventNote2" type="text" placeholder="ä¾‹å¦‚ï¼š12:00-06:35ï¼ˆ+1ï¼‰" />
</div>
        
        <div class="field-row">
          <small>åŒä¸€å¤©å¯ä»¥æœ‰å¤šå€‹äº‹ä»¶ï¼Œæ—¥æ›†æœƒå…¨éƒ¨é¡¯ç¤ºï¼›åŒ¯å‡º Markdown æ™‚æœƒæ”¾é€²å‚™è¨»æ¬„ï¼Œç”¨ã€Œï¼›ã€åˆ†éš”ã€‚</small>
        </div>

        <div id="eventList" class="list"></div>
      </div>
    </div>
        <!-- Markdown é è¦½ Modal -->
        <div id="mdPreviewModal" class="modal-backdrop">
            <div class="modal-dialog">
                <div class="modal-header">
                    <div class="modal-header-title">ğŸ“– è¡Œç¨‹é è¦½</div>
                    <button id="btnClosePreview" class="modal-close-btn" type="button">âœ•</button>
                </div>
                <div id="mdPreviewContent" class="modal-body">
                    <!-- ç”± JS å°‡ Markdown æ¸²æŸ“æˆ HTML å¡é€²ä¾† -->
                </div>
                <div class="modal-footer">
                    <button id="btnCopyFromPreview" class="btn secondary" type="button">è¤‡è£½ Markdown</button>
                </div>
            </div>
        </div>
  </div>
        <!-- ä½¿ç”¨ CDN è¼‰å…¥ marked.jsï¼Œæä¾› Markdown -> HTML æ¸²æŸ“ -->
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- ä¸‹é¢æ•´æ®µ JS è·Ÿä¸Šä¸€ç‰ˆä¸€æ¨£ï¼šè³‡æ–™çµæ§‹ï¼‹åŒ¯ç‡è¨ˆç®—ï¼‹JSONï¼‹Markdown -->
  <script>
    /* æ—¥æœŸå·¥å…·ï¼šè§£æã€æ ¼å¼åŒ–ã€åŠ å¤©æ•¸ã€åˆ¤æ–·æ˜¯å¦åœ¨å€é–“å…§ */
    function parseDate(value) {
      if (!value) return null;
      return new Date(value + 'T00:00:00');
    }

    function formatDateISO(date) {
      if (!date) return '';
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function addDays(date, days) {
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }

    function getMondayOfWeek(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = (day === 0 ? -6 : 1) - day;
      d.setDate(d.getDate() + diff);
      return d;
    }

    function isWithin(date, start, end) {
      if (!start || !end) return false;
      const t = date.getTime();
      return t >= start.getTime() && t <= end.getTime();
    }

    /* é‡‘é¡è¨ˆç®— */
    function computeAmountBase(amountInput, unitType) {
      const n = Number(amountInput) || 0;
      if (unitType === 'K') return n * 1000;
      if (unitType === 'M') return n * 1000000;
      return n;
    }

    function formatTwdK(twdAmount) {
      const k = twdAmount / 1000;
      if (!isFinite(k) || k === 0) return '0K';
      const absK = Math.abs(k);
      const decimals = absK >= 10 ? 0 : 1;
      let s = k.toFixed(decimals);
      if (s.indexOf('.') !== -1) s = s.replace(/\.0$/, '');
      return s + 'K';
    }
            /* è¨ˆç®—ä½å®¿æ™šæ•¸ï¼ˆç›®å‰ä»¥ã€ŒåŒ…å«èµ·è¨–æ—¥ã€çš„å¤©æ•¸ç•¶æ™šæ•¸ï¼‰ */
            function computeStayNights(startDate, endDate) {
                if (!startDate || !endDate) return 0;
                const MS = 24 * 60 * 60 * 1000;
                const diff = endDate.getTime() - startDate.getTime();
                return Math.round(diff / MS) + 1;
            }
    /* å…¨åŸŸè³‡æ–™ */
    let viewStartDate = null;
    const ranges = [];
    const events = [];
    const stays  = [];
    let idCounter = 1;
    function nextId() { return idCounter++; }

    let editingRangeId = null;
    let editingEventId = null;
    let editingHotelId = null;

    const anchorInput       = document.getElementById('anchorDate');
    const btnToday          = document.getElementById('btnToday');
    const btnGenerate       = document.getElementById('btnGenerate');
    const btnCopyMd         = document.getElementById('btnCopyMd');
    const btnImportJson     = document.getElementById('btnImportJson');
    const btnExportJson     = document.getElementById('btnExportJson');
    const importJsonInput   = document.getElementById('importJsonInput');

    const summaryBox        = document.getElementById('summary');
    const calendarGrid      = document.getElementById('calendarGrid');
    const calendarRangeLabel= document.getElementById('calendarRangeLabel');

    const rangeNameInput    = document.getElementById('rangeName');
    const rangeColorInput   = document.getElementById('rangeColor');
    const rangeStartInput   = document.getElementById('rangeStart');
    const rangeEndInput     = document.getElementById('rangeEnd');
    const btnAddRange       = document.getElementById('btnAddRange');
    const btnCancelRangeEdit= document.getElementById('btnCancelRangeEdit');
    const rangeList         = document.getElementById('rangeList');

    const hotelNameInput    = document.getElementById('hotelName');
    const hotelStartInput   = document.getElementById('hotelStart');
    const hotelEndInput     = document.getElementById('hotelEnd');
    const hotelCurrencySelect = document.getElementById('hotelCurrency');
    const hotelAmountInput  = document.getElementById('hotelAmount');
    const hotelUnitSelect   = document.getElementById('hotelUnit');
    const hotelFxRateInput  = document.getElementById('hotelFxRate');
    const btnAddHotel       = document.getElementById('btnAddHotel');
    const btnCancelHotelEdit= document.getElementById('btnCancelHotelEdit');
    const hotelList         = document.getElementById('hotelList');

const eventDateInput    = document.getElementById('eventDate');
const eventIconSelect   = document.getElementById('eventIcon');
const eventNoteInput    = document.getElementById('eventNote');
const eventNote2Input   = document.getElementById('eventNote2');   // âœˆï¸ ç¬¬äºŒè¡Œ
const eventExtraRow     = document.getElementById('eventExtraRow'); // âœˆï¸ ç¬¬äºŒè¡Œå®¹å™¨
const btnAddEvent       = document.getElementById('btnAddEvent');
const btnCancelEventEdit= document.getElementById('btnCancelEventEdit');
const eventList         = document.getElementById('eventList');      

            const btnPreviewMd = document.getElementById("btnPreviewMd");

            // Modal å…ƒä»¶ï¼šMarkdown é è¦½
            const mdPreviewModal = document.getElementById("mdPreviewModal");
            const mdPreviewContent = document.getElementById("mdPreviewContent");
            const btnClosePreview = document.getElementById("btnClosePreview");
            const btnCopyFromPreview = document.getElementById("btnCopyFromPreview");


// æ§åˆ¶ã€Œç¬¬äºŒè¡Œï¼ˆæ™‚é–“ï¼‰ã€æ˜¯å¦é¡¯ç¤ºï¼šåªæœ‰ âœˆï¸ æ‰é¡¯ç¤º
function updateEventExtraVisibility() {
  if (!eventExtraRow) return;
  const isFlight = eventIconSelect.value === 'âœˆï¸';
  eventExtraRow.style.display = isFlight ? '' : 'none';
  if (!isFlight && eventNote2Input) {
    eventNote2Input.value = '';
  }
}

eventIconSelect.addEventListener('change', updateEventExtraVisibility);

(function initDefaults() {
  const today = new Date();
  const iso = formatDateISO(today);

  anchorInput.value = iso;
  eventDateInput.value = iso;
  rangeStartInput.value = iso;
  rangeEndInput.value = iso;

  // é è¨­å–®æ—¥äº‹ä»¶æ˜¯ã€ŒğŸ“ æ™¯é»ã€ï¼Œé †ä¾¿é—œæ‰ç¬¬äºŒè¡Œ
  if (eventIconSelect) eventIconSelect.value = 'ğŸ“';
  if (eventNote2Input) eventNote2Input.value = '';
  updateEventExtraVisibility();

  setViewStartFromAnchor(today);
  renderRangesList();
  renderEventsList();
  clearHotelForm();
  renderHotelList();
  renderCalendar();
  updateSummary();
})();

    function setViewStartFromAnchor(date) {
      if (!date) return;
      const monday = getMondayOfWeek(date);
      viewStartDate = monday;
    }

    btnToday.addEventListener('click', () => {
      const today = new Date();
      const iso = formatDateISO(today);
      anchorInput.value = iso;
      setViewStartFromAnchor(today);
      renderCalendar();
      updateSummary();
    });

    btnGenerate.addEventListener('click', () => {
      const d = parseDate(anchorInput.value);
      if (!d) {
        alert('è«‹å…ˆé¸æ“‡ä¸€å€‹æ—¥æœŸã€‚');
        return;
      }
      setViewStartFromAnchor(d);
      renderCalendar();
      updateSummary();
    });

    function clearRangeForm() {
      editingRangeId = null;
      rangeNameInput.value = '';
      rangeColorInput.value = '#4f8cff';
      rangeStartInput.value = anchorInput.value || '';
      rangeEndInput.value = anchorInput.value || '';
      btnAddRange.textContent = 'åŠ å…¥å€é–“';
      btnCancelRangeEdit.style.display = 'none';
    }

    function renderRangesList() {
      rangeList.innerHTML = '';
      if (!ranges.length) {
        rangeList.innerHTML = '<div style="font-size:.85rem; color:var(--muted);">å°šæœªåŠ å…¥ä»»ä½•å€é–“ã€‚</div>';
        return;
      }

      for (const r of ranges) {
        const chip = document.createElement('div');
        chip.className = 'chip';
        if (editingRangeId === r.id) chip.classList.add('editing');

        const main = document.createElement('div');
        main.className = 'chip-main';

        const title = document.createElement('div');
        title.className = 'chip-title';
        title.textContent = r.name;

        const meta = document.createElement('div');
        meta.className = 'chip-meta';
        meta.textContent = `${formatDateISO(r.start)} ï½ ${formatDateISO(r.end)}`;

        main.appendChild(title);
        main.appendChild(meta);

        const colorBox = document.createElement('div');
        colorBox.style.width = '10px';
        colorBox.style.height = '10px';
        colorBox.style.borderRadius = '999px';
        colorBox.style.background = r.color || '#4f8cff';
        colorBox.style.flexShrink = '0';

        const actions = document.createElement('div');
        actions.className = 'chip-actions';

        const btnEdit = document.createElement('button');
        btnEdit.type = 'button';
        btnEdit.className = 'edit';
        btnEdit.textContent = 'ç·¨è¼¯';
        btnEdit.addEventListener('click', () => startEditRange(r.id));

        const btnDel = document.createElement('button');
        btnDel.type = 'button';
        btnDel.className = 'delete';
        btnDel.textContent = 'åˆªé™¤';
        btnDel.addEventListener('click', () => removeRange(r.id));

        actions.appendChild(btnEdit);
        actions.appendChild(btnDel);

        chip.appendChild(colorBox);
        chip.appendChild(main);
        chip.appendChild(actions);

        rangeList.appendChild(chip);
      }
    }

    function startEditRange(id) {
      const r = ranges.find(x => x.id === id);
      if (!r) return;

      editingRangeId = id;
      rangeNameInput.value = r.name;
      rangeColorInput.value = r.color || '#4f8cff';
      rangeStartInput.value = formatDateISO(r.start);
      rangeEndInput.value = formatDateISO(r.end);

      btnAddRange.textContent = 'å„²å­˜å€é–“';
      btnCancelRangeEdit.style.display = 'inline-block';
    }

    function removeRange(id) {
      const idx = ranges.findIndex(x => x.id === id);
      if (idx === -1) return;
      ranges.splice(idx, 1);
      if (editingRangeId === id) clearRangeForm();
      renderRangesList();
      renderCalendar();
      updateSummary();
    }

    btnAddRange.addEventListener('click', () => {
      const name  = rangeNameInput.value.trim();
      const color = rangeColorInput.value || '#4f8cff';
      const start = parseDate(rangeStartInput.value);
      const end   = parseDate(rangeEndInput.value);

      if (!name) {
        alert('è«‹è¼¸å…¥å€é–“åç¨±ï¼ˆåŸå¸‚æˆ–é£¯åº—ï¼‰ã€‚');
        return;
      }
      if (!start || !end) {
        alert('è«‹è¨­å®šèµ·è¨–æ—¥æœŸã€‚');
        return;
      }
      if (end < start) {
        alert('çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸã€‚');
        return;
      }

      if (editingRangeId != null) {
        const target = ranges.find(r => r.id === editingRangeId);
        if (target) {
          target.name  = name;
          target.color = color;
          target.start = start;
          target.end   = end;
        }
      } else {
        ranges.push({
          id: nextId(),
          name,
          color,
          start,
          end
        });
      }

      clearRangeForm();
      renderRangesList();
      renderCalendar();
      updateSummary();
    });

    btnCancelRangeEdit.addEventListener('click', () => {
      clearRangeForm();
      renderRangesList();
    });

function clearEventForm() {
  editingEventId = null;
  eventDateInput.value = anchorInput.value || '';
  eventIconSelect.value = 'ğŸ“';
  eventNoteInput.value = '';
  if (eventNote2Input) eventNote2Input.value = '';
  btnAddEvent.textContent = 'åŠ å…¥äº‹ä»¶';
  btnCancelEventEdit.style.display = 'none';
  updateEventExtraVisibility();
}

    function renderEventsList() {
      eventList.innerHTML = '';
      if (!events.length) {
        eventList.innerHTML = '<div style="font-size:.85rem; color:var(--muted);">å°šæœªåŠ å…¥ä»»ä½•äº‹ä»¶ã€‚</div>';
        return;
      }

      const sorted = [...events].sort((a, b) => a.date - b.date);

      for (const e of sorted) {
        const chip = document.createElement('div');
        chip.className = 'chip';
        if (editingEventId === e.id) chip.classList.add('editing');

        const main = document.createElement('div');
        main.className = 'chip-main';

const title = document.createElement('div');
title.className = 'chip-title';

let mainText = e.note || '(ç„¡å‚™è¨»)';
if (e.icon === 'âœˆï¸' && e.note2) {
  mainText = `${e.note || ''}ã€${e.note2}ã€‘`.trim();
}
title.textContent = `${e.icon} ${mainText}`;

        const meta = document.createElement('div');
        meta.className = 'chip-meta';
        meta.textContent = formatDateISO(e.date);

        main.appendChild(title);
        main.appendChild(meta);

        const actions = document.createElement('div');
        actions.className = 'chip-actions';

        const btnEdit = document.createElement('button');
        btnEdit.type = 'button';
        btnEdit.className = 'edit';
        btnEdit.textContent = 'ç·¨è¼¯';
        btnEdit.addEventListener('click', () => startEditEvent(e.id));

        const btnDel = document.createElement('button');
        btnDel.type = 'button';
        btnDel.className = 'delete';
        btnDel.textContent = 'åˆªé™¤';
        btnDel.addEventListener('click', () => removeEvent(e.id));

        actions.appendChild(btnEdit);
        actions.appendChild(btnDel);

        chip.appendChild(main);
        chip.appendChild(actions);

        eventList.appendChild(chip);
      }
    }

function startEditEvent(id) {
  const e = events.find(x => x.id === id);
  if (!e) return;

  editingEventId = id;
  eventDateInput.value  = formatDateISO(e.date);
  eventIconSelect.value = e.icon || 'ğŸ“';
  eventNoteInput.value  = e.note || '';
  if (eventNote2Input) eventNote2Input.value = e.note2 || '';

  btnAddEvent.textContent = 'å„²å­˜äº‹ä»¶';
  btnCancelEventEdit.style.display = 'inline-block';
  updateEventExtraVisibility();
}

    function removeEvent(id) {
      const idx = events.findIndex(x => x.id === id);
      if (idx === -1) return;
      events.splice(idx, 1);
      if (editingEventId === id) clearEventForm();
      renderEventsList();
      renderCalendar();
      updateSummary();
    }

btnAddEvent.addEventListener('click', () => {
  const date = parseDate(eventDateInput.value);
  const icon = eventIconSelect.value || 'ğŸ“';
  const note = eventNoteInput.value.trim();
  const note2Raw = eventNote2Input ? eventNote2Input.value.trim() : '';
  const isFlight = icon === 'âœˆï¸';
  const note2 = isFlight ? note2Raw : '';

  if (!date) {
    alert('è«‹å…ˆé¸æ“‡äº‹ä»¶æ—¥æœŸã€‚');
    return;
  }

  if (editingEventId != null) {
    const target = events.find(e => e.id === editingEventId);
    if (target) {
      target.date = date;
      target.icon = icon;
      target.note = note;
      target.note2 = note2;
    }
  } else {
    events.push({
      id: nextId(),
      date,
      icon,
      note,
      note2
    });
  }

  clearEventForm();
  renderEventsList();
  renderCalendar();
  updateSummary();
});


    btnCancelEventEdit.addEventListener('click', () => {
      clearEventForm();
      renderEventsList();
    });

    function clearHotelForm() {
      editingHotelId = null;
      hotelNameInput.value  = '';
      hotelStartInput.value = anchorInput.value || '';
      hotelEndInput.value   = anchorInput.value || '';
      hotelCurrencySelect.value = 'TWD';
      hotelAmountInput.value = '';
      hotelUnitSelect.value  = 'å…ƒ';
      hotelFxRateInput.value = '';
      btnAddHotel.textContent = 'åŠ å…¥ä½å®¿';
      btnCancelHotelEdit.style.display = 'none';
    }

    function renderHotelList() {
      hotelList.innerHTML = '';
      if (!stays.length) {
        hotelList.innerHTML = '<div style="font-size:.85rem; color:var(--muted);">å°šæœªåŠ å…¥ä»»ä½•ä½å®¿ã€‚</div>';
        return;
      }

      const sorted = [...stays].sort((a, b) => a.start - b.start);

      for (const s of sorted) {
        const chip = document.createElement('div');
        chip.className = 'chip';
        if (editingHotelId === s.id) chip.classList.add('editing');

        const main = document.createElement('div');
        main.className = 'chip-main';

        const title = document.createElement('div');
        title.className = 'chip-title';
        title.textContent = s.name || '(æœªå‘½åä½å®¿)';

        const meta = document.createElement('div');
        meta.className = 'chip-meta';
        const datePart   = `${formatDateISO(s.start)} ï½ ${formatDateISO(s.end)}`;
        const amountPart = `${s.currency}${s.amountInput}${s.unitType}ï½œNT ${formatTwdK(s.twdAmount)}`;
        meta.textContent = `${datePart}ï½œ${amountPart}`;

        main.appendChild(title);
        main.appendChild(meta);

        const actions = document.createElement('div');
        actions.className = 'chip-actions';

        const btnEdit = document.createElement('button');
        btnEdit.type = 'button';
        btnEdit.className = 'edit';
        btnEdit.textContent = 'ç·¨è¼¯';
        btnEdit.addEventListener('click', () => startEditHotel(s.id));

        const btnDel = document.createElement('button');
        btnDel.type = 'button';
        btnDel.className = 'delete';
        btnDel.textContent = 'åˆªé™¤';
        btnDel.addEventListener('click', () => removeHotel(s.id));

        actions.appendChild(btnEdit);
        actions.appendChild(btnDel);

        chip.appendChild(main);
        chip.appendChild(actions);

        hotelList.appendChild(chip);
      }
    }

    function startEditHotel(id) {
      const s = stays.find(x => x.id === id);
      if (!s) return;
      editingHotelId = id;
      hotelNameInput.value  = s.name || '';
      hotelStartInput.value = formatDateISO(s.start);
      hotelEndInput.value   = formatDateISO(s.end);
      hotelCurrencySelect.value = s.currency || 'TWD';
      hotelAmountInput.value = s.amountInput;
      hotelUnitSelect.value  = s.unitType || 'å…ƒ';
      hotelFxRateInput.value = s.fxRate;

      btnAddHotel.textContent = 'å„²å­˜ä½å®¿';
      btnCancelHotelEdit.style.display = 'inline-block';
    }

    function removeHotel(id) {
      const idx = stays.findIndex(x => x.id === id);
      if (idx === -1) return;
      stays.splice(idx, 1);
      if (editingHotelId === id) clearHotelForm();
      renderHotelList();
      renderCalendar();
      updateSummary();
    }

    btnAddHotel.addEventListener('click', () => {
      const name     = (hotelNameInput.value || '').trim();
      const start    = parseDate(hotelStartInput.value);
      const end      = parseDate(hotelEndInput.value);
      const currency = hotelCurrencySelect.value || 'TWD';
      const unitType = hotelUnitSelect.value || 'å…ƒ';
      const amountInputVal = hotelAmountInput.value;
      const fxRateVal      = hotelFxRateInput.value;

      if (!name) {
        alert('è«‹è¼¸å…¥é£¯åº—åç¨±ã€‚');
        return;
      }
      if (!start || !end) {
        alert('è«‹è¨­å®šä½å®¿èµ·è¨–æ—¥æœŸã€‚');
        return;
      }
      if (end < start) {
        alert('ä½å®¿çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸã€‚');
        return;
      }

      const amountInputNum = Number(amountInputVal);
      if (!isFinite(amountInputNum) || amountInputNum <= 0) {
        alert('è«‹è¼¸å…¥æ­£ç¢ºçš„é‡‘é¡æ•¸å­—ï¼ˆå¯ä»¥ç”¨å°æ•¸ï¼‰ã€‚');
        return;
      }
      const fxRateNum = Number(fxRateVal);
      if (!isFinite(fxRateNum) || fxRateNum <= 0) {
        alert('è«‹è¼¸å…¥æ­£ç¢ºçš„æ¦‚ç®—åŒ¯ç‡ï¼ˆ1 åŸå¹£ â‰ˆ å¹¾å°å¹£ï¼‰ã€‚');
        return;
      }

      const amountBase = computeAmountBase(amountInputNum, unitType);
      const twdAmount  = amountBase * fxRateNum;

      if (editingHotelId != null) {
        const target = stays.find(s => s.id === editingHotelId);
        if (target) {
          target.name        = name;
          target.start       = start;
          target.end         = end;
          target.currency    = currency;
          target.unitType    = unitType;
          target.amountInput = amountInputNum;
          target.amountBase  = amountBase;
          target.fxRate      = fxRateNum;
          target.twdAmount   = twdAmount;
        }
      } else {
        stays.push({
          id: nextId(),
          name,
          start,
          end,
          currency,
          unitType,
          amountInput: amountInputNum,
          amountBase,
          fxRate: fxRateNum,
          twdAmount
        });
      }

      clearHotelForm();
      renderHotelList();
      renderCalendar();
      updateSummary();
    });

    btnCancelHotelEdit.addEventListener('click', () => {
      clearHotelForm();
      renderHotelList();
    });

    function renderCalendar() {
      calendarGrid.innerHTML = '';
      if (!viewStartDate) return;

      const days = [];
      for (let i = 0; i < 35; i++) days.push(addDays(viewStartDate, i));

      const first = days[0];
      const last  = days[days.length - 1];
      calendarRangeLabel.textContent = `${formatDateISO(first)} ï½ ${formatDateISO(last)}`;

      const todayISO = formatDateISO(new Date());

      for (const day of days) {
        const cell = document.createElement('div');
        cell.className = 'day-cell';

        const dateISO = formatDateISO(day);
        const dayNum  = day.getDate();
        const month   = day.getMonth() + 1;

        const topRow = document.createElement('div');
        topRow.style.display = 'flex';
        topRow.style.alignItems = 'baseline';

        const numSpan = document.createElement('span');
        numSpan.className = 'day-number';
        numSpan.textContent = dayNum;

        topRow.appendChild(numSpan);

        if (dayNum === 1) {
          const monthTag = document.createElement('span');
          monthTag.className = 'day-month-tag';
          monthTag.textContent = `${month} æœˆ`;
          topRow.appendChild(monthTag);
        }

        cell.appendChild(topRow);

        if (dateISO === todayISO) {
          const ring = document.createElement('div');
          ring.className = 'today-ring';
          cell.appendChild(ring);
        }

        const hitRanges = ranges.filter(r => isWithin(day, r.start, r.end));
        if (hitRanges.length) {
          cell.classList.add('has-range');

          const sorted = hitRanges.sort((a, b) => a.start - b.start);
          const primary = sorted[0];

          const bar = document.createElement('div');
          bar.className = 'range-bar';
          bar.style.background = primary.color || '#4f8cff';
          cell.appendChild(bar);

          for (const r of sorted) {
            if (formatDateISO(day) === formatDateISO(r.start)) {
              const labelDiv = document.createElement('div');
              labelDiv.className = 'range-label';
              labelDiv.textContent = r.name;
              labelDiv.style.color = r.color;
              cell.appendChild(labelDiv);
              break;
            }
          }
        }

        const hitStays = stays
          .filter(s => isWithin(day, s.start, s.end))
          .sort((a, b) => a.start - b.start);

        if (hitStays.length) {
          const primaryStay = hitStays[0];

          const hotelLine = document.createElement('div');
          hotelLine.className = 'hotel-line';
          hotelLine.textContent = 'ğŸ¨ ' + (primaryStay.name || '');
          cell.appendChild(hotelLine);

          if (formatDateISO(day) === formatDateISO(primaryStay.start)) {
            const hotelAmount = document.createElement('div');
            hotelAmount.className = 'hotel-amount';
            hotelAmount.textContent =
              `${primaryStay.currency} ${primaryStay.amountInput}${primaryStay.unitType} / NT ${formatTwdK(primaryStay.twdAmount)}`;
            cell.appendChild(hotelAmount);
          }
        }

        const dayEvents = events.filter(e => formatDateISO(e.date) === dateISO);
        if (dayEvents.length) {
          const eventsBox = document.createElement('div');
          eventsBox.className = 'events';

          const sortedEvents = dayEvents.sort((a, b) => a.id - b.id);
          for (const e of sortedEvents) {
            const item = document.createElement('div');
            item.className = 'event-item';

            const iconSpan = document.createElement('span');
            iconSpan.className = 'event-icon';
            iconSpan.textContent = e.icon;

const textSpan = document.createElement('span');
textSpan.className = 'event-text';

let text = e.note || '';
if (e.icon === 'âœˆï¸' && e.note2) {
  textSpan.classList.add('event-text-multiline');
  text = `${e.note || ''}\n${e.note2}`.trim(); // ç¬¬ä¸€è¡Œï¼šèˆªç­ï¼‹é£›è¡Œæ™‚é–“ï¼›ç¬¬äºŒè¡Œï¼šèµ·è¿„æ™‚é–“
}
textSpan.textContent = text;

            item.appendChild(iconSpan);
            item.appendChild(textSpan);
            eventsBox.appendChild(item);
          }

          cell.appendChild(eventsBox);
        }

        calendarGrid.appendChild(cell);
      }
    }

    function getTripSpan() {
      const dates = [];
      for (const r of ranges) {
        if (r.start) dates.push(r.start);
        if (r.end)   dates.push(r.end);
      }
      for (const s of stays) {
        if (s.start) dates.push(s.start);
        if (s.end)   dates.push(s.end);
      }
      for (const e of events) {
        if (e.date) dates.push(e.date);
      }
      if (!dates.length) return null;
      dates.sort((a, b) => a - b);
      const first = dates[0];
      const last  = dates[dates.length - 1];
      const MS = 24 * 60 * 60 * 1000;
      const days = Math.round((last - first) / MS) + 1;
      return { first, last, days };
    }

            function updateSummary() {
                if (!viewStartDate) {
                    summaryBox.textContent = "å°šæœªå»ºç«‹æ—¥æ›†ã€‚è«‹å…ˆé¸ä¸€å€‹æ—¥æœŸã€‚";
                    return;
                }
                const firstView = viewStartDate;
                const lastView = addDays(viewStartDate, 34);

                const span = getTripSpan();
                let tripLine = "ğŸ§­ æ—…ç¨‹å¤©æ•¸ï¼šç›®å‰å°šæœªè¨­å®šä»»ä½•å€é–“æˆ–äº‹ä»¶ã€‚";
                if (span) {
                    tripLine = `ğŸ§­ æ—…ç¨‹å¤©æ•¸ï¼š<strong>${span.days}</strong> å¤©ï¼ˆ${formatDateISO(
                        span.first
                    )} ï½ ${formatDateISO(span.last)}ï¼‰`;
                }

                // ä½å®¿æ‘˜è¦ï¼šæ¯é–“é£¯åº— + ç¸½å°å¹£é‡‘é¡
                let hotelSummaryHtml = "ğŸ’¤ ä½å®¿æ‘˜è¦ï¼šå°šæœªè¨­å®šä»»ä½•ä½å®¿ã€‚";
                if (stays.length) {
                    const sortedStays = [...stays].sort((a, b) => a.start - b.start);
                    let totalTwd = 0;
                    const lines = [];
                    for (const s of sortedStays) {
                        const nights = computeStayNights(s.start, s.end);
                        totalTwd += s.twdAmount || 0;
                        const name = s.name || "(æœªå‘½åä½å®¿)";
                        const origAmount = `${s.currency} ${s.amountInput}${s.unitType}`;
                        const twdStr = `NT ${formatTwdK(s.twdAmount)}`;
                        lines.push(`ãƒ»${name}ï¼š${nights} æ™šï¼Œ${origAmount}ï¼Œ${twdStr}`);
                    }
                    hotelSummaryHtml =
                        "ğŸ’¤ ä½å®¿æ‘˜è¦ï¼š<br/>" +
                        lines.join("<br/>") +
                        `<br/>åˆè¨ˆï¼šç´„ <strong>NT ${formatTwdK(totalTwd)}</strong>`;
                }

                summaryBox.innerHTML = `
        ğŸ“… ç›®å‰è¦–åœ–ç¯„åœï¼š<strong>${formatDateISO(firstView)}</strong> ï½ <strong>${formatDateISO(lastView)}</strong><br/>
        ğŸ¨ å€é–“ï¼ˆåŸå¸‚ï¼é£¯åº—ï¼‰å…±ï¼š<strong>${ranges.length}</strong> ç­†<br/>
        ğŸ›ï¸ ä½å®¿ç´€éŒ„å…±ï¼š<strong>${stays.length}</strong> ç­†<br/>
        ğŸ“Œ å–®æ—¥äº‹ä»¶å…±ï¼š<strong>${events.length}</strong> ç­†<br/>
        ${tripLine}<br/>
        ${hotelSummaryHtml}
      `;
            }

    function buildMarkdownTable() {
      if (!viewStartDate) return '';

      const lines = [];
      lines.push('| æ—¥æœŸ | åœ°é» | é£¯åº— | é‡‘é¡æ‘˜è¦ | å‚™è¨» |');
      lines.push('| ---- | ---- | ---- | ---- | ---- |');

      const weekdayChars = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

      for (let i = 0; i < 35; i++) {
        const day = addDays(viewStartDate, i);
        const iso = formatDateISO(day);

        const y = day.getFullYear();
        const m = String(day.getMonth() + 1).padStart(2, '0');
        const d = String(day.getDate()).padStart(2, '0');
        const weekday = weekdayChars[day.getDay()];
        const dateStr = `${y}/${m}/${d}ï¼ˆ${weekday}ï¼‰`;

        const coveringRanges = ranges
          .filter(r => isWithin(day, r.start, r.end))
          .sort((a, b) => a.start - b.start);
        const location = coveringRanges.length ? coveringRanges[0].name : '';

        const coveringStays = stays
          .filter(s => isWithin(day, s.start, s.end))
          .sort((a, b) => a.start - b.start);
        const hotelName = coveringStays.length ? (coveringStays[0].name || '') : '';

        let amountSummary = '';
        if (coveringStays.length) {
          const s = coveringStays[0];
          if (iso === formatDateISO(s.start)) {
            amountSummary =
              `${s.currency} ${s.amountInput}${s.unitType} / NT ${formatTwdK(s.twdAmount)}`;
          }
        }

        const dayEvents = events
          .filter(e => formatDateISO(e.date) === iso)
          .sort((a, b) => a.id - b.id);

const remark = dayEvents
  .map(e => {
    const base = e.icon || '';
    const note = (e.note || '').trim();
    const note2 = (e.note2 || '').trim();

    if (e.icon === 'âœˆï¸' && note && note2) {
      // âœˆï¸ BR72 12h35mã€12:00-06:35ï¼ˆ+1ï¼‰ã€‘
      return `${base} ${note}ã€${note2}ã€‘`;
    }

    if (note) return `${base} ${note}`;
    return base;
  })
  .join('ï¼›');

        lines.push(`| ${dateStr} | ${location} | ${hotelName} | ${amountSummary} | ${remark} |`);
      }

      return lines.join('\n');
    }

    btnCopyMd.addEventListener('click', async () => {
      if (!viewStartDate) {
        alert('è«‹å…ˆå»ºç«‹ 5 é€±æ—¥æ›†è¦–åœ–ï¼ˆé¸æ—¥æœŸä¸¦æŒ‰ã€Œæ›´æ–°ã€ï¼‰ã€‚');
        return;
      }

      const md = buildMarkdownTable();
      if (!md) {
        alert('ç›®å‰æ²’æœ‰å¯åŒ¯å‡ºçš„å…§å®¹ã€‚');
        return;
      }

      try {
        await navigator.clipboard.writeText(md);
        alert('Markdown è¡¨æ ¼å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚');
      } catch (err) {
        console.error(err);
        alert('è¤‡è£½å¤±æ•—ï¼Œå¯èƒ½æ˜¯ç€è¦½å™¨æ¬Šé™å•é¡Œã€‚è«‹æ‰‹å‹•é¸å–è¤‡è£½ã€‚');
      }
    });

    function buildJsonSnapshot() {
      return {
        version: 2,
        viewStart: viewStartDate ? formatDateISO(viewStartDate) : null,
        ranges: ranges.map(r => ({
          name: r.name,
          color: r.color,
          start: formatDateISO(r.start),
          end:   formatDateISO(r.end)
        })),
        
events: events.map(e => ({
  date: formatDateISO(e.date),
  icon: e.icon,
  note: e.note,
  note2: e.note2 || ''
})),
        
        stays: stays.map(s => ({
          name: s.name,
          start: formatDateISO(s.start),
          end:   formatDateISO(s.end),
          currency: s.currency,
          unitType: s.unitType,
          amountInput: s.amountInput,
          amountBase:  s.amountBase,
          fxRate:      s.fxRate,
          twdAmount:   s.twdAmount
        }))
      };
    }

    function triggerDownloadBlob(blob, fileName) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    btnExportJson.addEventListener('click', () => {
      const snapshot = buildJsonSnapshot();
      const jsonStr = JSON.stringify(snapshot, null, 2);
      const blob = new Blob(['\uFEFF' + jsonStr], {
        type: 'application/json;charset=utf-8'
      });

      const base = snapshot.viewStart || 'trip';
      const fileName = `trip_${base.replace(/-/g, '')}.json`;
      triggerDownloadBlob(blob, fileName);
    });

    btnImportJson.addEventListener('click', () => {
      importJsonInput.click();
    });

    importJsonInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const text = String(reader.result || '');
          const data = JSON.parse(text);

          ranges.length = 0;
          events.length = 0;
          stays.length  = 0;
          editingRangeId = null;
          editingEventId = null;
          editingHotelId = null;
          clearRangeForm();
          clearEventForm();
          clearHotelForm();

          const importedStart = data.viewStart ? parseDate(data.viewStart) : null;
          if (importedStart) {
            viewStartDate = importedStart;
            anchorInput.value = formatDateISO(importedStart);
          }

          if (Array.isArray(data.ranges)) {
            for (const r of data.ranges) {
              const start = r.start ? parseDate(r.start) : null;
              const end   = r.end   ? parseDate(r.end)   : null;
              if (!start || !end) continue;
              ranges.push({
                id: nextId(),
                name:  r.name  || '',
                color: r.color || '#4f8cff',
                start,
                end
              });
            }
          }

          if (Array.isArray(data.events)) {
            for (const e of data.events) {
              const date = e.date ? parseDate(e.date) : null;
              if (!date) continue;
              events.push({
                id: nextId(),
                date,
                icon: e.icon || 'ğŸ“',
                note: e.note || '',
                note2: e.note2 || ''
              });
            }
          }

          if (Array.isArray(data.stays)) {
            for (const s of data.stays) {
              const start = s.start ? parseDate(s.start) : null;
              const end   = s.end   ? parseDate(s.end)   : null;
              if (!start || !end) continue;

              const currency   = s.currency || 'TWD';
              const unitType   = s.unitType || 'å…ƒ';
              const amountInput= Number(s.amountInput) || 0;
              const fxRate     = Number(s.fxRate) || 0;
              const amountBase = s.amountBase != null
                                   ? Number(s.amountBase)
                                   : computeAmountBase(amountInput, unitType);
              const twdAmount  = s.twdAmount != null
                                   ? Number(s.twdAmount)
                                   : amountBase * fxRate;

              stays.push({
                id: nextId(),
                name: s.name || '',
                start,
                end,
                currency,
                unitType,
                amountInput,
                amountBase,
                fxRate,
                twdAmount
              });
            }
          }

          renderRangesList();
          renderEventsList();
          renderHotelList();
          renderCalendar();
          updateSummary();
          alert('JSON åŒ¯å…¥å®Œæˆã€‚');
        } catch (err) {
          console.error(err);
          alert('åŒ¯å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª JSON æ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚');
        } finally {
          importJsonInput.value = '';
        }
      };
      reader.readAsText(file);
    });
  </script>
  
  <footer style="margin-top:32px; padding:12px 0; font-size:12px; color:#aaa; text-align:center;">
    Â© Claire Huang Â· å€‹äººå¯¦é©—å·¥å…·
  </footer>
</body>
</html>