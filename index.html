<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ—…éŠè¡Œäº‹æ›†å·¥å…·ï¼ˆ5 é€±è¦–åœ–ï¼‰</title>

  <style>
    :root {
      --card-bg:#fff;
      --soft:#f5f5f7;
      --ink:#222;
      --muted:#666;
      --accent:#888;
      --radius:12px;
      --border:#e3e3e6;
    }

    /* å…¨åŸŸæ’ç‰ˆèˆ‡åº•è‰² */
    body {
      margin:0;
      background:#fafafa;
      color:var(--ink);
      font-family: system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans TC", sans-serif;
    }

    /* é ‚éƒ¨å›ºå®šåˆ—ï¼šå’Œå…¶ä»–å·¥å…·åŒé¢¨æ ¼ */
    header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:1rem 1.5rem;
      background:#fff;
      box-shadow:0 2px 5px rgba(0,0,0,0.05);
      position:sticky;
      top:0;
      z-index:10;
    }
    header h2 {
      margin:0;
      font-size:1.4rem;
      letter-spacing:.5px;
    }
    header a {
      text-decoration:none;
      font-size:1rem;
      padding:.5rem 1rem;
      border-radius:6px;
      background:#eee;
      color:#333;
      box-shadow:0 1px 4px rgba(0,0,0,0.1);
    }

    .wrap {
      max-width:1080px;
      margin:0 auto;
      padding:24px 24px 40px;
    }

    h1 {
      margin:0 0 10px;
      font-size: clamp(1.4rem, 1.2rem + 1vw, 1.8rem);
    }
    .sub {
      margin:0 0 16px;
      color:var(--muted);
      font-size:.98rem;
    }

    /* æœ€ä¸Šæ–¹ï¼šæ—¥æœŸæ§åˆ¶ï¼‹è¤‡è£½MD åŒ¯å‡º */
    .toolbar {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      background:var(--card-bg);
      padding:14px;
      border-radius:var(--radius);
      box-shadow:0 2px 10px rgba(0,0,0,.06);
      margin-bottom:14px;
    }
    .toolbar-group {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .toolbar label {
      font-size:.95rem;
      color:var(--muted);
    }

    input[type="date"],
    input[type="text"],
    input[type="color"],
    select {
      border:1px solid var(--border);
      border-radius:8px;
      padding:6px 10px;
      font-size:.95rem;
      background:#fff;
    }
    input[type="text"] { min-width:140px; }

    .btn {
      border:none;
      border-radius:10px;
      padding:8px 14px;
      font-size:.95rem;
      cursor:pointer;
      background:#2f855a;
      color:#fff;
      white-space:nowrap;
    }
    .btn.secondary {
      background:#e0e0e0;
      color:#333;
    }
    .btn[disabled] {
      background:#bdbdbd;
      cursor:not-allowed;
    }

    /* ç¸½è¦½æ¡†ï¼šé¡¯ç¤ºç›®å‰ 5 é€±ç¯„åœèˆ‡ç­†æ•¸ */
    #summary {
      background:var(--soft);
      border-left:5px solid var(--accent);
      padding:10px 14px;
      border-radius:10px;
      font-size:.95rem;
      line-height:1.6;
      box-shadow: inset 0 0 0 1px #eee;
      margin-bottom:18px;
    }

    /* ä¸­é–“ï¼šå¤§æ—¥æ›†å¡ç‰‡ */
    .calendar-shell {
      background:var(--card-bg);
      padding:14px;
      border-radius:var(--radius);
      box-shadow:0 2px 10px rgba(0,0,0,.06);
      margin-bottom:20px;
    }
    .calendar-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      gap:8px;
    }
    .calendar-header h3 {
      margin:0;
      font-size:1.05rem;
    }
    .calendar-header span {
      font-size:.85rem;
      color:var(--muted);
    }

    .weekday-row {
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:4px;
      margin-bottom:4px;
      padding:0 2px;
      font-size:.85rem;
      color:var(--muted);
    }
    .weekday-cell {
      text-align:center;
    }

    .calendar-grid {
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:4px;
    }

    /* æ”¾å¤§ç‰ˆæ—¥æ›†æ ¼å­ */
    .day-cell {
      min-height:110px;             /* æ”¾å¤§é«˜åº¦ */
      background:#fff;
      border-radius:8px;
      border:1px solid var(--border);
      padding:8px 6px 6px;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      position:relative;
      overflow:hidden;
    }

    .day-number {
      font-size:.95rem;
      font-weight:600;
    }

    .day-month-tag {
      font-size:.8rem;
      color:var(--muted);
      margin-left:4px;
    }

    /* å€é–“è‰²æ¢ï¼šä¸Šæ–¹ä¸€æ¢æ°´å¹³ç·š + æ·¡æ·¡èƒŒæ™¯ */
    .day-cell.has-range {
      background:linear-gradient(to bottom, rgba(0,0,0,0.02), rgba(0,0,0,0.015));
    }
    .range-top-bar {
      position:absolute;
      left:0;
      right:0;
      top:0;
      height:4px;
      background:var(--accent);
    }
    .range-label {
      margin-top:4px;
      font-size:.8rem;
      font-weight:600;
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
    }

    /* å–®æ—¥äº‹ä»¶å€ï¼šæ”¾åœ¨æ ¼å­åº•éƒ¨ */
    .events {
      margin-top:auto;
      font-size:.85rem;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .event-item {
      display:flex;
      align-items:center;
      gap:4px;
      padding:1px 3px;
      border-radius:4px;
      background:rgba(0,0,0,0.03);
    }
    .event-icon {
      font-size:.95rem;
    }
    .event-text {
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
    }

    /* ä»Šå¤©çš„å°åœˆåœˆæ¨™è¨˜ */
    .today-ring {
      position:absolute;
      top:4px;
      right:5px;
      width:8px;
      height:8px;
      border-radius:50%;
      border:2px solid #ff7043;
    }

    /* åº•éƒ¨ï¼šå€é–“èˆ‡äº‹ä»¶è¨­å®šï¼ˆå·¦å³å…©æ¬„ï¼‰ */
    .bottom-layout {
      display:grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap:18px;
      align-items:flex-start;
    }

    .panel {
      background:var(--card-bg);
      padding:14px;
      border-radius:var(--radius);
      box-shadow:0 2px 10px rgba(0,0,0,.06);
    }
    .panel h3 {
      margin:0 0 8px;
      font-size:1.05rem;
    }
    .panel p {
      margin:0 0 10px;
      font-size:.9rem;
      color:var(--muted);
    }

    .field-row {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:8px;
      align-items:center;
    }
    .field-row small {
      font-size:.8rem;
      color:var(--muted);
    }

    .badge {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 8px;
      border-radius:999px;
      background:var(--soft);
      font-size:.8rem;
      color:var(--muted);
    }
    .badge-dot {
      width:10px;
      height:10px;
      border-radius:50%;
      background:var(--accent);
    }

    .list {
      margin-top:8px;
      max-height:260px;
      overflow:auto;
      border-top:1px solid #eee;
      padding-top:6px;
    }
    .chip {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      border-radius:8px;
      background:#fafafa;
      border:1px solid #eee;
      font-size:.86rem;
      margin-bottom:4px;
    }
    .chip-main {
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .chip-title {
      font-weight:600;
    }
    .chip-meta {
      color:var(--muted);
      font-size:.8rem;
    }
    .chip-color {
      width:14px;
      height:14px;
      border-radius:4px;
      border:1px solid rgba(0,0,0,.08);
    }
    .chip button {
      border:none;
      background:transparent;
      color:#c62828;
      cursor:pointer;
      font-size:.9rem;
    }

    @media (max-width: 900px) {
      .bottom-layout {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 767px) {
      .wrap {
        padding:18px 14px 28px;
      }
      header {
        padding:.8rem 1rem;
      }
      input, select, button {
        font-size:16px !important; /* iOS ä¸è¦å¤ªå° */
        height:40px;
      }
      .day-cell {
        min-height:95px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h2>ğŸ§³ æ—…éŠè¡Œäº‹æ›†å·¥å…·</h2>
    <a href="index.html">ğŸ§­ å›é¦–é </a>
  </header>

  <div class="wrap">
    <h1>5 é€±æ—…éŠè¡Œäº‹æ›†è¦–åœ–</h1>
    <p class="sub">
      é¸ä¸€å€‹æ—¥æœŸï¼Œç³»çµ±æœƒè‡ªå‹•å¾€å‰è£œåˆ°è©²é€±æ˜ŸæœŸä¸€ï¼Œå›ºå®šé¡¯ç¤º 5 é€±ï¼ˆ35 å¤©ï¼‰ã€‚ä¸Šæ–¹å…ˆèª¿æ•´è¦–åœ–èˆ‡åŒ¯å‡º Markdownï¼Œä¸­é–“å¤§æ—¥æ›†ç”¨ä¾†è¬›è¡Œç¨‹ï¼Œä¸‹é¢å†ç´°ä¿®å€é–“èˆ‡å–®æ—¥äº‹ä»¶ã€‚
    </p>

    <!-- è¦–åœ–æ§åˆ¶åˆ—ï¼šæ—¥æœŸã€æ›´æ–°ã€ä»Šå¤©ã€è¤‡è£½MD -->
    <div class="toolbar">
      <div class="toolbar-group">
        <label for="anchorDate">é¸æ“‡ä»»ä¸€æ—¥æœŸï¼š</label>
        <input id="anchorDate" type="date" />
        <button id="btnToday" class="btn secondary" type="button">è·³åˆ°ä»Šå¤©æ‰€åœ¨é€±</button>
        <button id="btnGenerate" class="btn" type="button">æ›´æ–° 5 é€±è¦–åœ–</button>
      </div>
      <div class="toolbar-group" style="margin-left:auto;">
        <button id="btnCopyMd" class="btn secondary" type="button">
          è¤‡è£½ Markdown è¡¨æ ¼
        </button>
      </div>
    </div>

    <!-- ç¸½è¦½è³‡è¨Š -->
    <div id="summary">å°šæœªå»ºç«‹æ—¥æ›†ã€‚è«‹å…ˆé¸ä¸€å€‹æ—¥æœŸï¼Œå†æŒ‰ã€Œæ›´æ–° 5 é€±è¦–åœ–ã€ã€‚</div>

    <!-- ä¸­é–“ï¼šæ”¾å¤§ç‰ˆ 5 é€±æ—¥æ›† -->
    <div class="calendar-shell">
      <div class="calendar-header">
        <h3>5 é€±æ—¥æ›†è¦–åœ–</h3>
        <span id="calendarRangeLabel"></span>
      </div>

      <div class="weekday-row">
        <div class="weekday-cell">ä¸€</div>
        <div class="weekday-cell">äºŒ</div>
        <div class="weekday-cell">ä¸‰</div>
        <div class="weekday-cell">å››</div>
        <div class="weekday-cell">äº”</div>
        <div class="weekday-cell">å…­</div>
        <div class="weekday-cell">æ—¥</div>
      </div>

      <div id="calendarGrid" class="calendar-grid">
        <!-- JS å‹•æ…‹ç”¢ç”Ÿæ—¥æ›†æ ¼å­ -->
      </div>
    </div>

    <!-- åº•éƒ¨ï¼šå·¦å€é–“ã€å³äº‹ä»¶ -->
    <div class="bottom-layout">
      <!-- å€é–“ï¼ˆåŸå¸‚ï¼é£¯åº—ï¼‰ -->
      <div class="panel">
        <h3>â‘  å€é–“ï¼ˆåŸå¸‚ï¼é£¯åº—ï¼‰</h3>
        <p>è¨­å®šã€Œä½åœ¨å“ªè£¡ã€æˆ–ã€Œå¾…åœ¨å“ªå€‹åŸå¸‚ã€ã€‚æœƒæ¯å¤©è‡ªå‹•å¡«å…¥åœ°é»ï¼Œæ—¥æ›†ä¸Šç”¨é ‚ç«¯è‰²æ¢é¡¯ç¤ºå€é–“ã€‚</p>

        <div class="field-row">
          <input id="rangeName" type="text" placeholder="ä¾‹å¦‚ï¼šæœ­å¹Œï½œäº¬ç‹é£¯åº—" />
          <input id="rangeColor" type="color" value="#4f8cff" />
        </div>
        <div class="field-row">
          <label>èµ·ï¼š</label>
          <input id="rangeStart" type="date" />
          <label>è¿„ï¼š</label>
          <input id="rangeEnd" type="date" />
          <button id="btnAddRange" class="btn secondary" type="button">åŠ å…¥å€é–“</button>
        </div>
        <div class="field-row">
          <small>èµ·è¨–æœƒè¢«è¦–ç‚ºã€Œå«ç•¶å¤©ã€ï¼Œé¡è‰²æœƒå¥—ç”¨æ•´æ®µæ—¥æœŸã€‚è‹¥æŸå¤©è½åœ¨å¤šå€‹å€é–“ï¼Œè¡¨æ ¼èˆ‡æ—¥æ›†éƒ½ä»¥é–‹å§‹æ—¥æœŸè¼ƒæ—©çš„é‚£ä¸€æ®µç‚ºä¸»ã€‚</small>
        </div>

        <div class="badge">
          <span class="badge-dot"></span>
          <span>å€é–“åªæ”¹é¡è‰²èˆ‡åœ°é»æ¬„ä½ï¼Œä¸æœƒç¢°åˆ°äº‹ä»¶è³‡æ–™ã€‚</span>
        </div>

        <div id="rangeList" class="list"></div>
      </div>

      <!-- å–®æ—¥äº‹ä»¶ -->
      <div class="panel">
        <h3>â‘¡ å–®æ—¥äº‹ä»¶ï¼ˆç§»å‹•ï¼æ´»å‹•ï¼å‚™è¨»ï¼‰</h3>
        <p>åƒ âœˆï¸ã€ğŸš„ã€ğŸšŒã€ğŸ£ é€™ç¨®ç™¼ç”Ÿåœ¨ã€ŒæŸä¸€å¤©ã€çš„äº‹æƒ…ã€‚è·¨æ—¥ç¡æ©Ÿä¸Šå°±è‡ªå·±åŠ å…©å¤©ï¼Œå¾ˆè‡ªç”±ã€‚</p>

        <div class="field-row">
          <label>æ—¥æœŸï¼š</label>
          <input id="eventDate" type="date" />
        </div>
        <div class="field-row">
          <label>åœ–ç¤ºï¼š</label>
          <select id="eventIcon">
            <option value="âœˆï¸">âœˆï¸ é£›æ©Ÿ</option>
            <option value="ğŸš†">ğŸš† ç«è»Šåœ°éµ</option>
            <option value="ğŸšŒ">ğŸšŒ å·´å£«</option>
            <option value="ğŸš—">ğŸš— åŒ…è»Š</option>
            <option value="ğŸš¢">ğŸš¢ éƒµè¼ª</option>
            <option value="ğŸ£">ğŸ£ é¤å»³</option>
            <option value="ğŸ›">ğŸ› é€›è¡—</option>
            <option value="ğŸ“">ğŸ“ æ™¯é»</option>
          </select>
          <input id="eventNote" type="text" placeholder="ä¾‹å¦‚ï¼šAC838ã€TPE â†’ CTS å¤œèˆª" />
          <button id="btnAddEvent" class="btn secondary" type="button">åŠ å…¥äº‹ä»¶</button>
        </div>
        <div class="field-row">
          <small>åŒä¸€å¤©å¯ä»¥æœ‰å¤šå€‹äº‹ä»¶ï¼Œæ—¥æ›†æœƒå…¨éƒ¨é¡¯ç¤ºï¼›åŒ¯å‡º Markdown æ™‚æœƒæ”¾é€²å‚™è¨»æ¬„ï¼Œç”¨ã€Œï¼›ã€åˆ†éš”ã€‚</small>
        </div>

        <div id="eventList" class="list"></div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // æ—¥æœŸå·¥å…·å‡½å¼
    // =========================

    /** å°‡ "YYYY-MM-DD" è½‰æˆ Dateï¼ˆé–åœ¨ç•¶åœ° 00:00ï¼‰ */
    function parseDate(value) {
      if (!value) return null;
      return new Date(value + 'T00:00:00');
    }

    /** å°‡ Date è½‰æˆ "YYYY-MM-DD" */
    function formatDateISO(date) {
      if (!date) return '';
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    /** å›å‚³æ–°çš„ Dateï¼Œç‚ºåŸæ—¥æœŸåŠ ä¸ŠæŒ‡å®šå¤©æ•¸ */
    function addDays(date, days) {
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }

    /**
     * å–å¾—ä»¥ã€Œé€±ä¸€ç‚º 0ã€çš„ç´¢å¼•
     * JS: getDay() â†’ 0=æ—¥,1=ä¸€,â€¦6=å…­
     * æˆ‘å€‘è¦ 0=ä¸€,â€¦,6=æ—¥
     */
    function getMondayIndex(date) {
      const jsDay = date.getDay();
      return (jsDay + 6) % 7;
    }

    /** åˆ¤æ–· date æ˜¯å¦åœ¨ [start, end] ç¯„åœå…§ï¼ˆå«é‚Šç•Œï¼‰ */
    function isWithin(date, start, end) {
      if (!start || !end) return false;
      const t = date.getTime();
      return t >= start.getTime() && t <= end.getTime();
    }

    // =========================
    // å…¨åŸŸç‹€æ…‹ï¼šè¦–åœ–ã€å€é–“ã€äº‹ä»¶
    // =========================

    /** è¦–åœ–èµ·å§‹æ—¥æœŸï¼ˆä¸€å®šæ˜¯æ˜ŸæœŸä¸€ï¼‰ */
    let viewStartDate = null;

    /** å€é–“åˆ—è¡¨ï¼š{id, name, color, start, end} */
    const ranges = [];

    /** å–®æ—¥äº‹ä»¶åˆ—è¡¨ï¼š{id, date, icon, note} */
    const events = [];

    let idCounter = 1;
    function nextId() {
      return idCounter++;
    }

    // =========================
    // DOM å…ƒç´ 
    // =========================

    const anchorInput = document.getElementById('anchorDate');
    const btnToday = document.getElementById('btnToday');
    const btnGenerate = document.getElementById('btnGenerate');
    const btnCopyMd = document.getElementById('btnCopyMd');

    const summaryBox = document.getElementById('summary');
    const calendarGrid = document.getElementById('calendarGrid');
    const calendarRangeLabel = document.getElementById('calendarRangeLabel');

    const rangeNameInput = document.getElementById('rangeName');
    const rangeColorInput = document.getElementById('rangeColor');
    const rangeStartInput = document.getElementById('rangeStart');
    const rangeEndInput = document.getElementById('rangeEnd');
    const btnAddRange = document.getElementById('btnAddRange');
    const rangeList = document.getElementById('rangeList');

    const eventDateInput = document.getElementById('eventDate');
    const eventIconSelect = document.getElementById('eventIcon');
    const eventNoteInput = document.getElementById('eventNote');
    const btnAddEvent = document.getElementById('btnAddEvent');
    const eventList = document.getElementById('eventList');

    // =========================
    // åˆå§‹åŒ–ï¼šé è¨­æŠ“ä»Šå¤©æ‰€åœ¨é€±
    // =========================

    (function initDefaults() {
      const today = new Date();
      const iso = formatDateISO(today);

      anchorInput.value = iso;
      eventDateInput.value = iso;
      rangeStartInput.value = iso;
      rangeEndInput.value = iso;

      setViewStartFromAnchor(today);
      renderRangesList();
      renderEventsList();
      renderCalendar();
      updateSummary();
    })();

    /** æ ¹æ“š anchor æ—¥æœŸè¨ˆç®—ç•¶é€±æ˜ŸæœŸä¸€ç•¶ä½œè¦–åœ–èµ·å§‹æ—¥ */
    function setViewStartFromAnchor(date) {
      if (!date) return;
      const mondayOffset = getMondayIndex(date); // 0~6
      viewStartDate = addDays(date, -mondayOffset);
    }

    // =========================
    // è¦–åœ–æ§åˆ¶ï¼šä»Šå¤©ã€æ›´æ–°
    // =========================

    btnToday.addEventListener('click', () => {
      const today = new Date();
      anchorInput.value = formatDateISO(today);
      setViewStartFromAnchor(today);
      renderCalendar();
      updateSummary();
    });

    btnGenerate.addEventListener('click', () => {
      const d = parseDate(anchorInput.value);
      if (!d) {
        alert('è«‹å…ˆé¸æ“‡ä¸€å€‹æ—¥æœŸã€‚');
        return;
      }
      setViewStartFromAnchor(d);
      renderCalendar();
      updateSummary();
    });

    // =========================
    // å€é–“æ“ä½œï¼šæ–°å¢ / åˆªé™¤ / æ¸…å–®
    // =========================

    btnAddRange.addEventListener('click', () => {
      const name = rangeNameInput.value.trim();
      const color = rangeColorInput.value || '#4f8cff';
      const start = parseDate(rangeStartInput.value);
      const end = parseDate(rangeEndInput.value);

      if (!name) {
        alert('è«‹è¼¸å…¥å€é–“åç¨±ï¼ˆåŸå¸‚æˆ–é£¯åº—ï¼‰ã€‚');
        return;
      }
      if (!start || !end) {
        alert('è«‹è¨­å®šèµ·è¨–æ—¥æœŸã€‚');
        return;
      }
      if (end < start) {
        alert('çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸã€‚');
        return;
      }

      ranges.push({
        id: nextId(),
        name,
        color,
        start,
        end
      });

      rangeNameInput.value = '';
      renderRangesList();
      renderCalendar();
      updateSummary();
    });

    function removeRange(id) {
      const idx = ranges.findIndex(r => r.id === id);
      if (idx >= 0) {
        ranges.splice(idx, 1);
        renderRangesList();
        renderCalendar();
        updateSummary();
      }
    }

    /** å°‡å€é–“åˆ—è¡¨ç•«åœ¨å·¦ä¸‹å¡ç‰‡ */
    function renderRangesList() {
      rangeList.innerHTML = '';
      if (!ranges.length) {
        rangeList.innerHTML = '<div style="font-size:.85rem; color:var(--muted);">å°šæœªåŠ å…¥ä»»ä½•å€é–“ã€‚</div>';
        return;
      }

      for (const r of ranges) {
        const chip = document.createElement('div');
        chip.className = 'chip';

        const main = document.createElement('div');
        main.className = 'chip-main';

        const title = document.createElement('div');
        title.className = 'chip-title';
        title.textContent = r.name;

        const meta = document.createElement('div');
        meta.className = 'chip-meta';
        meta.textContent = `${formatDateISO(r.start)} ï½ ${formatDateISO(r.end)}`;

        main.appendChild(title);
        main.appendChild(meta);

        const colorBox = document.createElement('div');
        colorBox.className = 'chip-color';
        colorBox.style.background = r.color;

        const btnDel = document.createElement('button');
        btnDel.type = 'button';
        btnDel.textContent = 'åˆªé™¤';
        btnDel.addEventListener('click', () => removeRange(r.id));

        chip.appendChild(colorBox);
        chip.appendChild(main);
        chip.appendChild(btnDel);

        rangeList.appendChild(chip);
      }
    }

    // =========================
    // å–®æ—¥äº‹ä»¶æ“ä½œï¼šæ–°å¢ / åˆªé™¤ / æ¸…å–®
    // =========================

    btnAddEvent.addEventListener('click', () => {
      const date = parseDate(eventDateInput.value);
      const icon = eventIconSelect.value || 'ğŸ“';
      const note = eventNoteInput.value.trim();

      if (!date) {
        alert('è«‹å…ˆé¸æ“‡äº‹ä»¶æ—¥æœŸã€‚');
        return;
      }

      events.push({
        id: nextId(),
        date,
        icon,
        note
      });

      eventNoteInput.value = '';
      renderEventsList();
      renderCalendar();
      updateSummary();
    });

    function removeEvent(id) {
      const idx = events.findIndex(e => e.id === id);
      if (idx >= 0) {
        events.splice(idx, 1);
        renderEventsList();
        renderCalendar();
        updateSummary();
      }
    }

    /** å°‡äº‹ä»¶åˆ—è¡¨ç•«åœ¨å³ä¸‹å¡ç‰‡ */
    function renderEventsList() {
      eventList.innerHTML = '';
      if (!events.length) {
        eventList.innerHTML = '<div style="font-size:.85rem; color:var(--muted);">å°šæœªåŠ å…¥ä»»ä½•äº‹ä»¶ã€‚</div>';
        return;
      }

      const sorted = [...events].sort((a, b) => a.date - b.date);

      for (const e of sorted) {
        const chip = document.createElement('div');
        chip.className = 'chip';

        const main = document.createElement('div');
        main.className = 'chip-main';

        const title = document.createElement('div');
        title.className = 'chip-title';
        title.textContent = `${e.icon} ${e.note || '(ç„¡å‚™è¨»)'}`;

        const meta = document.createElement('div');
        meta.className = 'chip-meta';
        meta.textContent = formatDateISO(e.date);

        main.appendChild(title);
        main.appendChild(meta);

        const btnDel = document.createElement('button');
        btnDel.type = 'button';
        btnDel.textContent = 'åˆªé™¤';
        btnDel.addEventListener('click', () => removeEvent(e.id));

        chip.appendChild(main);
        chip.appendChild(btnDel);

        eventList.appendChild(chip);
      }
    }

    // =========================
    // æ—¥æ›†æ¸²æŸ“ï¼š5 é€± x 7 å¤©
    // =========================

    function renderCalendar() {
      calendarGrid.innerHTML = '';
      if (!viewStartDate) return;

      const days = [];
      for (let i = 0; i < 35; i++) {
        days.push(addDays(viewStartDate, i));
      }

      const first = days[0];
      const last = days[days.length - 1];
      calendarRangeLabel.textContent = `${formatDateISO(first)} ï½ ${formatDateISO(last)}`;

      const todayISO = formatDateISO(new Date());

      for (const day of days) {
        const cell = document.createElement('div');
        cell.className = 'day-cell';

        const dateISO = formatDateISO(day);
        const dayNum = day.getDate();
        const month = day.getMonth() + 1;

        // ä¸Šæ–¹ï¼šæ—¥æœŸï¼‹æ¯æœˆ 1 è™Ÿå°æœˆæ¨™ç±¤
        const topRow = document.createElement('div');
        topRow.style.display = 'flex';
        topRow.style.alignItems = 'baseline';

        const numSpan = document.createElement('span');
        numSpan.className = 'day-number';
        numSpan.textContent = dayNum;

        topRow.appendChild(numSpan);

        if (dayNum === 1) {
          const monthTag = document.createElement('span');
          monthTag.className = 'day-month-tag';
          monthTag.textContent = `${month} æœˆ`;
          topRow.appendChild(monthTag);
        }

        cell.appendChild(topRow);

        // ä»Šå¤©æ¨™è¨˜
        if (dateISO === todayISO) {
          const ring = document.createElement('div');
          ring.className = 'today-ring';
          cell.appendChild(ring);
        }

        // æ‰¾å‡ºæ¶µè“‹é€™å¤©çš„æ‰€æœ‰å€é–“ï¼Œè‹¥æœ‰å¤šå€‹ï¼Œä»¥é–‹å§‹æ—¥æœŸæœ€æ—©çš„ä¸€æ®µç‚ºä¸»
        const hitRanges = ranges.filter(r => isWithin(day, r.start, r.end));
        if (hitRanges.length) {
          cell.classList.add('has-range');

          const sorted = hitRanges.sort((a, b) => a.start - b.start);
          const primary = sorted[0];

          // é ‚éƒ¨è‰²å¸¶
          const bar = document.createElement('div');
          bar.className = 'range-top-bar';
          bar.style.background = primary.color;
          cell.appendChild(bar);

          // è‹¥ç•¶å¤©å‰›å¥½æ˜¯æŸå€‹å€é–“çš„èµ·å§‹æ—¥ï¼Œé¡¯ç¤ºåç¨±æ¨™ç±¤
          for (const r of sorted) {
            if (formatDateISO(day) === formatDateISO(r.start)) {
              const labelDiv = document.createElement('div');
              labelDiv.className = 'range-label';
              labelDiv.textContent = r.name;
              labelDiv.style.color = r.color;
              cell.appendChild(labelDiv);
              break; // ä¸€å¤©é¡¯ç¤ºä¸€å€‹åç¨±å°±å¥½
            }
          }
        }

        // å–®æ—¥äº‹ä»¶ï¼šåº•éƒ¨é¡¯ç¤ºæ‰€æœ‰äº‹ä»¶
        const dayEvents = events.filter(e => formatDateISO(e.date) === dateISO);
        if (dayEvents.length) {
          const eventsBox = document.createElement('div');
          eventsBox.className = 'events';

          const sortedEvents = dayEvents.sort((a, b) => a.id - b.id);
          for (const e of sortedEvents) {
            const item = document.createElement('div');
            item.className = 'event-item';

            const iconSpan = document.createElement('span');
            iconSpan.className = 'event-icon';
            iconSpan.textContent = e.icon;

            const textSpan = document.createElement('span');
            textSpan.className = 'event-text';
            textSpan.textContent = e.note || '';

            item.appendChild(iconSpan);
            if (e.note) item.appendChild(textSpan);

            eventsBox.appendChild(item);
          }

          cell.appendChild(eventsBox);
        }

        calendarGrid.appendChild(cell);
      }
    }

    // =========================
    // ç¸½è¦½è¨Šæ¯
    // =========================

    function updateSummary() {
      if (!viewStartDate) {
        summaryBox.textContent = 'å°šæœªå»ºç«‹æ—¥æ›†ã€‚è«‹å…ˆé¸ä¸€å€‹æ—¥æœŸã€‚';
        return;
      }
      const first = viewStartDate;
      const last = addDays(viewStartDate, 34);

      const rangeCount = ranges.length;
      const eventCount = events.length;

      summaryBox.innerHTML = `
        ğŸ“… ç›®å‰è¦–åœ–ç¯„åœï¼š<strong>${formatDateISO(first)}</strong> ï½ <strong>${formatDateISO(last)}</strong><br/>
        ğŸ¨ å€é–“ï¼ˆåŸå¸‚ï¼é£¯åº—ï¼‰å…±ï¼š<strong>${rangeCount}</strong> ç­†<br/>
        ğŸ“Œ å–®æ—¥äº‹ä»¶å…±ï¼š<strong>${eventCount}</strong> ç­†<br/>
        âœï¸ æ¯å¤©çš„åœ°é»æœƒæ ¹æ“šå€é–“è‡ªå‹•å¡«å…¥ï¼›äº‹ä»¶å‰‡é›†ä¸­åœ¨å‚™è¨»æ¬„ï¼Œè·¨æ—¥ç§»å‹•å°±è‡ªå·±åŠ æˆå…©å¤©ã€‚
      `;
    }

    // =========================
    // åŒ¯å‡ºï¼šè¤‡è£½ Markdown è¡¨æ ¼
    // =========================

    /**
     * ç”¢ç”Ÿã€Œæ—¥æœŸ / åœ°é» / å‚™è¨»ã€ä¸‰æ¬„çš„ Markdown è¡¨æ ¼å­—ä¸²
     * - æ—¥æœŸï¼š2026/05/13ï¼ˆä¸‰ï¼‰
     * - åœ°é»ï¼šç•¶å¤©è½åœ¨å“ªä¸€å€‹å€é–“ï¼ˆè‹¥æœ‰å¤šæ®µé‡ç–Šï¼Œå–é–‹å§‹æ—¥æœ€æ—©çš„é‚£ä¸€æ®µï¼‰
     * - å‚™è¨»ï¼šç•¶å¤©æ‰€æœ‰äº‹ä»¶ï¼Œæ ¼å¼ã€Œåœ–ç¤ºï¼‹å‚™è¨»ã€ï¼Œä»¥ã€Œï¼›ã€åˆ†éš”
     */
    function buildMarkdownTable() {
      if (!viewStartDate) return '';

      const lines = [];
      lines.push('| æ—¥æœŸ | åœ°é» | å‚™è¨» |');
      lines.push('| ---- | ---- | ---- |');

      const weekdayChars = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

      for (let i = 0; i < 35; i++) {
        const day = addDays(viewStartDate, i);
        const iso = formatDateISO(day);

        // æ—¥æœŸï¼šYYYY/MM/DDï¼ˆXï¼‰
        const y = day.getFullYear();
        const m = String(day.getMonth() + 1).padStart(2, '0');
        const d = String(day.getDate()).padStart(2, '0');
        const weekday = weekdayChars[day.getDay()];
        const dateStr = `${y}/${m}/${d}ï¼ˆ${weekday}ï¼‰`;

        // åœ°é»ï¼šæ‰¾å‡ºæ¶µè“‹é€™å¤©çš„æ‰€æœ‰å€é–“ï¼Œå–é–‹å§‹æ—¥æœŸæœ€æ—©çš„ä¸€æ®µ
        const coveringRanges = ranges
          .filter(r => isWithin(day, r.start, r.end))
          .sort((a, b) => a.start - b.start);
        const location = coveringRanges.length ? coveringRanges[0].name : '';

        // å‚™è¨»ï¼šç•¶å¤©æ‰€æœ‰äº‹ä»¶
        const dayEvents = events
          .filter(e => formatDateISO(e.date) === iso)
          .sort((a, b) => a.id - b.id);

        const remark = dayEvents
          .map(e => {
            const base = e.icon || '';
            const note = (e.note || '').trim();
            return note ? `${base} ${note}` : base;
          })
          .join('ï¼›');

        lines.push(`| ${dateStr} | ${location} | ${remark} |`);
      }

      return lines.join('\n');
    }

    // è¤‡è£½ Markdown æŒ‰éˆ•ç¶å®š
    btnCopyMd.addEventListener('click', async () => {
      if (!viewStartDate) {
        alert('è«‹å…ˆå»ºç«‹ 5 é€±æ—¥æ›†è¦–åœ–ï¼ˆé¸æ—¥æœŸä¸¦æŒ‰ã€Œæ›´æ–°ã€ï¼‰ã€‚');
        return;
      }

      const md = buildMarkdownTable();
      if (!md) {
        alert('ç›®å‰æ²’æœ‰å¯åŒ¯å‡ºçš„å…§å®¹ã€‚');
        return;
      }

      try {
        await navigator.clipboard.writeText(md);
        alert('å·²è¤‡è£½ Markdown è¡¨æ ¼ï¼Œå¯ä»¥è²¼åˆ° Day One / Notion / Obsidianã€‚');
      } catch (err) {
        console.error(err);
        alert('è¤‡è£½å¤±æ•—ï¼Œå¯èƒ½æ˜¯ç€è¦½å™¨æ¬Šé™å•é¡Œã€‚ä»¥ä¸‹æ˜¯è¡¨æ ¼å…§å®¹ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼š\n\n' + md);
      }
    });
  </script>
</body>
</html>